<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Inliningproof</title>
<meta name="description" content="Documentation of Coq module Inliningproof" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Inliningproof</h1>
<div class="coq">
<br/>
<div class="doc">RTL function inlining: semantic preservation </div>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Coqlib</span> <span class="id">Wfsimpl</span> <span class="id">Maps</span> <span class="id">Errors</span> <span class="id">Integers</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">AST</span> <span class="id">Linking</span> <span class="id">Values</span> <span class="id">Memory</span> <span class="id">Globalenvs</span> <span class="id">Events</span> <span class="id">Smallstep</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Op</span> <span class="id">Registers</span> <span class="id">RTL</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Inlining</span> <span class="id">Inliningspec</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">match_prog</span> (<span class="id">prog</span> <span class="id">tprog</span>: <span class="id">program</span>) :=<br/>
&nbsp;&nbsp;<span class="id">match_program</span> (<span class="kwd">fun</span> <span class="id">cunit</span> <span class="id">f</span> <span class="id">tf</span> =&gt; <span class="id">transf_fundef</span> (<span class="id">funenv_program</span> <span class="id">cunit</span>) <span class="id">f</span> = <span class="id">OK</span> <span class="id">tf</span>) <span class="id">eq</span> <span class="id">prog</span> <span class="id">tprog</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">transf_program_match</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">prog</span> <span class="id">tprog</span>, <span class="id">transf_program</span> <span class="id">prog</span> = <span class="id">OK</span> <span class="id">tprog</span> -&gt; <span class="id">match_prog</span> <span class="id">prog</span> <span class="id">tprog</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2611')">Proof.</div>
<div class="proofscript" id="proof2611">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">match_transform_partial_program_contextual</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Section</span> <span class="id">INLINING</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">prog</span>: <span class="id">program</span>.<br/>
<span class="kwd">Variable</span> <span class="id">tprog</span>: <span class="id">program</span>.<br/>
<span class="kwd">Hypothesis</span> <span class="id">TRANSF</span>: <span class="id">match_prog</span> <span class="id">prog</span> <span class="id">tprog</span>.<br/>
<span class="kwd">Let</span> <span class="id">ge</span> := <span class="id">Genv.globalenv</span> <span class="id">prog</span>.<br/>
<span class="kwd">Let</span> <span class="id">tge</span> := <span class="id">Genv.globalenv</span> <span class="id">tprog</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">symbols_preserved</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">s</span>: <span class="id">ident</span>), <span class="id">Genv.find_symbol</span> <span class="id">tge</span> <span class="id">s</span> = <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">s</span>.<br/>
<span class="kwd">Proof</span> (<span class="id">Genv.find_symbol_match</span> <span class="id">TRANSF</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">senv_preserved</span>:<br/>
&nbsp;&nbsp;<span class="id">Senv.equiv</span> <span class="id">ge</span> <span class="id">tge</span>.<br/>
<span class="kwd">Proof</span> (<span class="id">Genv.senv_match</span> <span class="id">TRANSF</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">functions_translated</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">v</span>: <span class="id">val</span>) (<span class="id">f</span>: <span class="id">fundef</span>),<br/>
&nbsp;&nbsp;<span class="id">Genv.find_funct</span> <span class="id">ge</span> <span class="id">v</span> = <span class="id">Some</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">cu</span> <span class="id">f</span>', <span class="id">Genv.find_funct</span> <span class="id">tge</span> <span class="id">v</span> = <span class="id">Some</span> <span class="id">f</span>' /\ <span class="id">transf_fundef</span> (<span class="id">funenv_program</span> <span class="id">cu</span>) <span class="id">f</span> = <span class="id">OK</span> <span class="id">f</span>' /\ <span class="id">linkorder</span> <span class="id">cu</span> <span class="id">prog</span>.<br/>
<span class="kwd">Proof</span> (<span class="id">Genv.find_funct_match</span> <span class="id">TRANSF</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">function_ptr_translated</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">b</span>: <span class="id">block</span>) (<span class="id">f</span>: <span class="id">fundef</span>),<br/>
&nbsp;&nbsp;<span class="id">Genv.find_funct_ptr</span> <span class="id">ge</span> <span class="id">b</span> = <span class="id">Some</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">cu</span> <span class="id">f</span>', <span class="id">Genv.find_funct_ptr</span> <span class="id">tge</span> <span class="id">b</span> = <span class="id">Some</span> <span class="id">f</span>' /\ <span class="id">transf_fundef</span> (<span class="id">funenv_program</span> <span class="id">cu</span>) <span class="id">f</span> = <span class="id">OK</span> <span class="id">f</span>' /\ <span class="id">linkorder</span> <span class="id">cu</span> <span class="id">prog</span>.<br/>
<span class="kwd">Proof</span> (<span class="id">Genv.find_funct_ptr_match</span> <span class="id">TRANSF</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">sig_function_translated</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">cu</span> <span class="id">f</span> <span class="id">f</span>', <span class="id">transf_fundef</span> (<span class="id">funenv_program</span> <span class="id">cu</span>) <span class="id">f</span> = <span class="id">OK</span> <span class="id">f</span>' -&gt; <span class="id">funsig</span> <span class="id">f</span>' = <span class="id">funsig</span> <span class="id">f</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2612')">Proof.</div>
<div class="proofscript" id="proof2612">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">f</span>; <span class="id">Errors.monadInv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">transf_function_spec</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">SP</span>; <span class="id">inv</span> <span class="id">SP</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> Properties of contexts and relocations </h2>
<br/>
<span class="kwd">Remark</span> <span class="id">sreg_below_diff</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">r</span> <span class="id">r</span>', <span class="id">Plt</span> <span class="id">r</span>' <span class="id">ctx</span>.(<span class="id">dreg</span>) -&gt; <span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span> &lt;&gt; <span class="id">r</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2613')">Proof.</div>
<div class="proofscript" id="proof2613">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">zify</span>. <span class="tactic">unfold</span> <span class="id">sreg</span>; <span class="tactic">rewrite</span> <span class="id">shiftpos_eq</span>. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id">context_below_diff</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx1</span> <span class="id">ctx2</span> <span class="id">r1</span> <span class="id">r2</span>,<br/>
&nbsp;&nbsp;<span class="id">context_below</span> <span class="id">ctx1</span> <span class="id">ctx2</span> -&gt; <span class="id">Ple</span> <span class="id">r1</span> <span class="id">ctx1</span>.(<span class="id">mreg</span>) -&gt; <span class="id">sreg</span> <span class="id">ctx1</span> <span class="id">r1</span> &lt;&gt; <span class="id">sreg</span> <span class="id">ctx2</span> <span class="id">r2</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2614')">Proof.</div>
<div class="proofscript" id="proof2614">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">zify</span>. <span class="tactic">unfold</span> <span class="id">sreg</span>; <span class="tactic">rewrite</span> ! <span class="id">shiftpos_eq</span>. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id">context_below_lt</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx1</span> <span class="id">ctx2</span> <span class="id">r</span>, <span class="id">context_below</span> <span class="id">ctx1</span> <span class="id">ctx2</span> -&gt; <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx1</span>.(<span class="id">mreg</span>) -&gt; <span class="id">Plt</span> (<span class="id">sreg</span> <span class="id">ctx1</span> <span class="id">r</span>) <span class="id">ctx2</span>.(<span class="id">dreg</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2615')">Proof.</div>
<div class="proofscript" id="proof2615">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">unfold</span> <span class="id">Plt</span>; <span class="id">zify</span>. <span class="tactic">unfold</span> <span class="id">sreg</span>; <span class="tactic">rewrite</span> <span class="id">shiftpos_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<br/>
<h2> Agreement between register sets before and after inlining. </h2>
<br/>
<span class="kwd">Definition</span> <span class="id">agree_regs</span> (<span class="id">F</span>: <span class="id">meminj</span>) (<span class="id">ctx</span>: <span class="id">context</span>) (<span class="id">rs</span> <span class="id">rs</span>': <span class="id">regset</span>) :=<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) -&gt; <span class="id">Val.inject</span> <span class="id">F</span> <span class="id">rs</span>#<span class="id">r</span> <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>))<br/>
/\(<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">Plt</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) <span class="id">r</span> -&gt; <span class="id">rs</span>#<span class="id">r</span> = <span class="id">Vundef</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">val_reg_charact</span> (<span class="id">F</span>: <span class="id">meminj</span>) (<span class="id">ctx</span>: <span class="id">context</span>) (<span class="id">rs</span>': <span class="id">regset</span>) (<span class="id">v</span>: <span class="id">val</span>) (<span class="id">r</span>: <span class="id">reg</span>) :=<br/>
&nbsp;&nbsp;(<span class="id">Plt</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) <span class="id">r</span> /\ <span class="id">v</span> = <span class="id">Vundef</span>) \/ (<span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) /\ <span class="id">Val.inject</span> <span class="id">F</span> <span class="id">v</span> <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>)).<br/>
<br/>
<span class="kwd">Remark</span> <span class="id">Plt_Ple_dec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span> <span class="id">q</span>, {<span class="id">Plt</span> <span class="id">p</span> <span class="id">q</span>} + {<span class="id">Ple</span> <span class="id">q</span> <span class="id">p</span>}.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2616')">Proof.</div>
<div class="proofscript" id="proof2616">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">plt</span> <span class="id">p</span> <span class="id">q</span>). <span class="id">left</span>; <span class="tactic">auto</span>. <span class="id">right</span>; <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_val_reg_gen</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">r</span>, <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt; <span class="id">val_reg_charact</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span>' <span class="id">rs</span>#<span class="id">r</span> <span class="id">r</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2617')">Proof.</div>
<div class="proofscript" id="proof2617">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Plt_Ple_dec</span> (<span class="id">mreg</span> <span class="id">ctx</span>) <span class="id">r</span>).<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">rewrite</span> <span class="id">B</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_val_regs_gen</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">rl</span>,<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt; <span class="id">list_forall2</span> (<span class="id">val_reg_charact</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span>') <span class="id">rs</span>##<span class="id">rl</span> <span class="id">rl</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2618')">Proof.</div>
<div class="proofscript" id="proof2618">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">rl</span>; <span class="tactic">intros</span>; <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">agree_val_reg_gen</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_val_reg</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">r</span>, <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt; <span class="id">Val.inject</span> <span class="id">F</span> <span class="id">rs</span>#<span class="id">r</span> <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2619')">Proof.</div>
<div class="proofscript" id="proof2619">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">agree_val_reg_gen</span>; <span class="tactic">eauto</span>. <span class="id">instantiate</span> (1 := <span class="id">r</span>). <span class="tactic">intros</span> [[<span class="id">A</span> <span class="id">B</span>] | [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">B</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_val_regs</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">rl</span>, <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt; <span class="id">Val.inject_list</span> <span class="id">F</span> <span class="id">rs</span>##<span class="id">rl</span> <span class="id">rs</span>'##(<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">rl</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2620')">Proof.</div>
<div class="proofscript" id="proof2620">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">rl</span>; <span class="tactic">intros</span>; <span class="tactic">simpl</span>. <span class="id">constructor</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">agree_val_reg</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_set_reg</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">r</span> <span class="id">v</span> <span class="id">v</span>',<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">Val.inject</span> <span class="id">F</span> <span class="id">v</span> <span class="id">v</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> (<span class="id">rs</span>#<span class="id">r</span> &lt;- <span class="id">v</span>) (<span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>) &lt;- <span class="id">v</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2621')">Proof.</div>
<div class="proofscript" id="proof2621">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">agree_regs</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">Regmap.gsspec</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">peq</span> <span class="id">r0</span> <span class="id">r</span>). <span class="tactic">subst</span> <span class="id">r0</span>. <span class="tactic">rewrite</span> <span class="id">peq_true</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">peq_false</span>. <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">shiftpos_diff</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Regmap.gso</span>. <span class="tactic">auto</span>. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_set_reg_undef</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">r</span> <span class="id">v</span>',<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> (<span class="id">rs</span>#<span class="id">r</span> &lt;- <span class="id">Vundef</span>) (<span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>) &lt;- <span class="id">v</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2622')">Proof.</div>
<div class="proofscript" id="proof2622">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">agree_regs</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">repeat</span> <span class="tactic">rewrite</span> <span class="id">Regmap.gsspec</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">peq</span> <span class="id">r0</span> <span class="id">r</span>). <span class="tactic">subst</span> <span class="id">r0</span>. <span class="tactic">rewrite</span> <span class="id">peq_true</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">peq_false</span>. <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">shiftpos_diff</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Regmap.gsspec</span>. <span class="tactic">destruct</span> (<span class="id">peq</span> <span class="id">r0</span> <span class="id">r</span>); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_set_reg_undef</span>':<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">r</span>,<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> (<span class="id">rs</span>#<span class="id">r</span> &lt;- <span class="id">Vundef</span>) <span class="id">rs</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2623')">Proof.</div>
<div class="proofscript" id="proof2623">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">agree_regs</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Regmap.gsspec</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">peq</span> <span class="id">r0</span> <span class="id">r</span>). <span class="tactic">subst</span> <span class="id">r0</span>. <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Regmap.gsspec</span>. <span class="tactic">destruct</span> (<span class="id">peq</span> <span class="id">r0</span> <span class="id">r</span>); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_regs_invariant</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs1</span> <span class="id">rs2</span>,<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs1</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dreg</span>) <span class="id">r</span> -&gt; <span class="id">Plt</span> <span class="id">r</span> (<span class="id">ctx</span>.(<span class="id">dreg</span>) + <span class="id">ctx</span>.(<span class="id">mreg</span>)) -&gt; <span class="id">rs2</span>#<span class="id">r</span> = <span class="id">rs1</span>#<span class="id">r</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs2</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2624')">Proof.</div>
<div class="proofscript" id="proof2624">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">agree_regs</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">shiftpos_above</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Plt_le_trans</span>. <span class="tactic">apply</span> <span class="id">shiftpos_below</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H1</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_regs_incr</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs1</span> <span class="id">rs2</span> <span class="id">F</span>',<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs1</span> <span class="id">rs2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">inject_incr</span> <span class="id">F</span> <span class="id">F</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span>' <span class="id">ctx</span> <span class="id">rs1</span> <span class="id">rs2</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2625')">Proof.</div>
<div class="proofscript" id="proof2625">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>. <span class="tactic">eauto</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id">agree_regs_init</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span>, <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> (<span class="id">Regmap.init</span> <span class="id">Vundef</span>) <span class="id">rs</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2626')">Proof.</div>
<div class="proofscript" id="proof2626">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">split</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">Regmap.gi</span>; <span class="tactic">auto</span>. <span class="tactic">rewrite</span> <span class="id">Regmap.gi</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">agree_regs_init_regs</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rl</span> <span class="id">vl</span> <span class="id">vl</span>',<br/>
&nbsp;&nbsp;<span class="id">Val.inject_list</span> <span class="id">F</span> <span class="id">vl</span> <span class="id">vl</span>' -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">In</span> <span class="id">r</span> <span class="id">rl</span> -&gt; <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> (<span class="id">init_regs</span> <span class="id">vl</span> <span class="id">rl</span>) (<span class="id">init_regs</span> <span class="id">vl</span>' (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">rl</span>)).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2627')">Proof.</div>
<div class="proofscript" id="proof2627">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">rl</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_regs_init</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>. <span class="tactic">apply</span> <span class="id">agree_regs_init</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_set_reg</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> Executing sequences of moves </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id">tr_moves_init_regs</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">stk</span> <span class="id">f</span> <span class="id">sp</span> <span class="id">m</span> <span class="id">ctx1</span> <span class="id">ctx2</span>, <span class="id">context_below</span> <span class="id">ctx1</span> <span class="id">ctx2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">rdsts</span> <span class="id">rsrcs</span> <span class="id">vl</span> <span class="id">pc1</span> <span class="id">pc2</span> <span class="id">rs1</span>,<br/>
&nbsp;&nbsp;<span class="id">tr_moves</span> <span class="id">f</span>.(<span class="id">fn_code</span>) <span class="id">pc1</span> (<span class="id">sregs</span> <span class="id">ctx1</span> <span class="id">rsrcs</span>) (<span class="id">sregs</span> <span class="id">ctx2</span> <span class="id">rdsts</span>) <span class="id">pc2</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">In</span> <span class="id">r</span> <span class="id">rdsts</span> -&gt; <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx2</span>.(<span class="id">mreg</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">list_forall2</span> (<span class="id">val_reg_charact</span> <span class="id">F</span> <span class="id">ctx1</span> <span class="id">rs1</span>) <span class="id">vl</span> <span class="id">rsrcs</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">rs2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">star</span> <span class="id">step</span> <span class="id">tge</span> (<span class="id">State</span> <span class="id">stk</span> <span class="id">f</span> <span class="id">sp</span> <span class="id">pc1</span> <span class="id">rs1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">E0</span> (<span class="id">State</span> <span class="id">stk</span> <span class="id">f</span> <span class="id">sp</span> <span class="id">pc2</span> <span class="id">rs2</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;/\ <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx2</span> (<span class="id">init_regs</span> <span class="id">vl</span> <span class="id">rdsts</span>) <span class="id">rs2</span><br/>
&nbsp;&nbsp;/\ <span class="kwd">forall</span> <span class="id">r</span>, <span class="id">Plt</span> <span class="id">r</span> <span class="id">ctx2</span>.(<span class="id">dreg</span>) -&gt; <span class="id">rs2</span>#<span class="id">r</span> = <span class="id">rs1</span>#<span class="id">r</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2628')">Proof.</div>
<div class="proofscript" id="proof2628">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">rdsts</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;rdsts&nbsp;=&nbsp;nil&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="id">exists</span> <span class="id">rs1</span>; <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">star_refl</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">agree_regs_init</span>. <span class="tactic">auto</span>.<br/>
&nbsp;rdsts&nbsp;=&nbsp;a&nbsp;::&nbsp;rdsts&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H2</span>. <span class="id">inv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">rs1</span>; <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">star_refl</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">agree_regs_init</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">inv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">IHrdsts</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">rs2</span> [<span class="id">A</span> [<span class="id">B</span> <span class="id">C</span>]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> (<span class="id">rs2</span>#(<span class="id">sreg</span> <span class="id">ctx2</span> <span class="id">a</span>) &lt;- (<span class="id">rs2</span>#(<span class="id">sreg</span> <span class="id">ctx1</span> <span class="id">b1</span>))).<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">star_right</span>. <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">exec_Iop</span>; <span class="tactic">eauto</span>. <span class="id">traceEq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">destruct</span> <span class="id">H3</span> <span class="kwd">as</span> [[<span class="id">P</span> <span class="id">Q</span>] | [<span class="id">P</span> <span class="id">Q</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">a1</span>. <span class="tactic">eapply</span> <span class="id">agree_set_reg_undef</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_set_reg</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">C</span>; <span class="tactic">auto</span>.  <span class="tactic">apply</span> <span class="id">context_below_lt</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">Regmap.gso</span>. <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">sym_not_equal</span>. <span class="tactic">eapply</span> <span class="id">sreg_below_diff</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H2</span>; <span class="tactic">discriminate</span>.<br/>
Qed.</div>
<br/>
<h2> Memory invariants </h2>
<br/>
<div class="doc">A stack location is private if it is not the image of a valid
   location and we have full rights on it. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">loc_private</span> (<span class="id">F</span>: <span class="id">meminj</span>) (<span class="id">m</span> <span class="id">m</span>': <span class="id">mem</span>) (<span class="id">sp</span>: <span class="id">block</span>) (<span class="id">ofs</span>: <span class="id">Z</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">ofs</span> <span class="id">Cur</span> <span class="id">Freeable</span> /\<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span> <span class="id">delta</span>, <span class="id">F</span> <span class="id">b</span> = <span class="id">Some</span>(<span class="id">sp</span>, <span class="id">delta</span>) -&gt; ~<span class="id">Mem.perm</span> <span class="id">m</span> <span class="id">b</span> (<span class="id">ofs</span> - <span class="id">delta</span>) <span class="id">Max</span> <span class="id">Nonempty</span>).<br/>
<br/>
<div class="doc">Likewise, for a range of locations. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">range_private</span> (<span class="id">F</span>: <span class="id">meminj</span>) (<span class="id">m</span> <span class="id">m</span>': <span class="id">mem</span>) (<span class="id">sp</span>: <span class="id">block</span>) (<span class="id">lo</span> <span class="id">hi</span>: <span class="id">Z</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ofs</span>, <span class="id">lo</span> &lt;= <span class="id">ofs</span> &lt; <span class="id">hi</span> -&gt; <span class="id">loc_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">ofs</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">range_private_invariant</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m1</span>',<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span> <span class="id">delta</span> <span class="id">ofs</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">F1</span> <span class="id">b</span> = <span class="id">Some</span>(<span class="id">sp</span>, <span class="id">delta</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m1</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lo</span> &lt;= <span class="id">ofs</span> + <span class="id">delta</span> &lt; <span class="id">hi</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">F</span> <span class="id">b</span> = <span class="id">Some</span>(<span class="id">sp</span>, <span class="id">delta</span>) /\ <span class="id">Mem.perm</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">ofs</span>, <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">ofs</span> <span class="id">Cur</span> <span class="id">Freeable</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m1</span>' <span class="id">sp</span> <span class="id">ofs</span> <span class="id">Cur</span> <span class="id">Freeable</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m1</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2629')">Proof.</div>
<div class="proofscript" id="proof2629">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">H</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">H0</span>; <span class="tactic">eauto</span>. <span class="tactic">omega</span>. <span class="tactic">intros</span> [<span class="id">P</span> <span class="id">Q</span>].<br/>
&nbsp;&nbsp;<span class="id">eelim</span> <span class="id">B</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">range_private_perms</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span>,<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.range_perm</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span> <span class="id">Cur</span> <span class="id">Freeable</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2630')">Proof.</div>
<div class="proofscript" id="proof2630">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">H</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">range_private_alloc_left</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">base</span> <span class="id">hi</span> <span class="id">sz</span> <span class="id">m1</span> <span class="id">sp</span> <span class="id">F1</span>,<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">base</span> <span class="id">hi</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.alloc</span> <span class="id">m</span> 0 <span class="id">sz</span> = (<span class="id">m1</span>, <span class="id">sp</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">F1</span> <span class="id">sp</span> = <span class="id">Some</span>(<span class="id">sp</span>', <span class="id">base</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span>, <span class="id">b</span> &lt;&gt; <span class="id">sp</span> -&gt; <span class="id">F1</span> <span class="id">b</span> = <span class="id">F</span> <span class="id">b</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m</span>' <span class="id">sp</span>' (<span class="id">base</span> + <span class="id">Zmax</span> <span class="id">sz</span> 0) <span class="id">hi</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2631')">Proof.</div>
<div class="proofscript" id="proof2631">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> (<span class="id">H</span> <span class="id">ofs</span>). <span class="tactic">generalize</span> (<span class="id">Zmax2</span> <span class="id">sz</span> 0). <span class="tactic">omega</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.perm_alloc_inv</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b</span> <span class="id">sp</span>); <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">b</span>. <span class="tactic">rewrite</span> <span class="id">H1</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="id">inv</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Zmax_spec</span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="tactic">destruct</span> (<span class="id">zlt</span> 0 <span class="id">sz</span>); <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H2</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="tactic">auto</span>. <span class="id">eelim</span> <span class="id">B</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">range_private_free_left</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">base</span> <span class="id">sz</span> <span class="id">hi</span> <span class="id">b</span> <span class="id">m1</span>,<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span> (<span class="id">base</span> + <span class="id">Zmax</span> <span class="id">sz</span> 0) <span class="id">hi</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.free</span> <span class="id">m</span> <span class="id">b</span> 0 <span class="id">sz</span> = <span class="id">Some</span> <span class="id">m1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">F</span> <span class="id">b</span> = <span class="id">Some</span>(<span class="id">sp</span>, <span class="id">base</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span> <span class="id">m1</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">base</span> <span class="id">hi</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2632')">Proof.</div>
<div class="proofscript" id="proof2632">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zlt</span> <span class="id">ofs</span> (<span class="id">base</span> + <span class="id">Zmax</span> <span class="id">sz</span> 0)) <span class="kwd">as</span> [<span class="id">z</span>|<span class="id">z</span>].<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">replace</span> <span class="id">ofs</span> <span class="kwd">with</span> ((<span class="id">ofs</span> - <span class="id">base</span>) + <span class="id">base</span>) <span class="tactic">by</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.perm_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_range_perm</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Zmax_spec</span> <span class="kwd">in</span> <span class="id">z</span>. <span class="tactic">destruct</span> (<span class="id">zlt</span> 0 <span class="id">sz</span>); <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b</span> <span class="id">b0</span>).<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">b0</span>. <span class="tactic">rewrite</span> <span class="id">H1</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="id">inv</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;<span class="id">eelim</span> <span class="id">Mem.perm_free_2</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">Zmax_spec</span> <span class="kwd">in</span> <span class="id">z</span>. <span class="tactic">destruct</span> (<span class="id">zlt</span> 0 <span class="id">sz</span>); <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.mi_no_overlap</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Mem.perm_cur_max</span>. <span class="tactic">apply</span> <span class="id">Mem.perm_implies</span> <span class="kwd">with</span> <span class="id">Freeable</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">mem</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_range_perm</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">ofs</span> - <span class="id">base</span>). <span class="tactic">rewrite</span> <span class="id">Zmax_spec</span> <span class="kwd">in</span> <span class="id">z</span>. <span class="tactic">destruct</span> (<span class="id">zlt</span> 0 <span class="id">sz</span>); <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">A</span> | <span class="id">A</span>]. <span class="tactic">congruence</span>. <span class="tactic">omega</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">exploit</span> (<span class="id">H</span> <span class="id">ofs</span>). <span class="tactic">omega</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="tactic">split</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">eelim</span> <span class="id">B</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">range_private_extcall</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">F</span>' <span class="id">m1</span> <span class="id">m2</span> <span class="id">m1</span>' <span class="id">m2</span>' <span class="id">sp</span> <span class="id">base</span> <span class="id">hi</span>,<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span> <span class="id">m1</span> <span class="id">m1</span>' <span class="id">sp</span> <span class="id">base</span> <span class="id">hi</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.valid_block</span> <span class="id">m1</span> <span class="id">b</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m2</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">p</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m1</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">p</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.unchanged_on</span> (<span class="id">loc_out_of_reach</span> <span class="id">F</span> <span class="id">m1</span>) <span class="id">m1</span>' <span class="id">m2</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m1</span> <span class="id">m1</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">inject_incr</span> <span class="id">F</span> <span class="id">F</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">inject_separated</span> <span class="id">F</span> <span class="id">F</span>' <span class="id">m1</span> <span class="id">m1</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.valid_block</span> <span class="id">m1</span>' <span class="id">sp</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span>' <span class="id">m2</span> <span class="id">m2</span>' <span class="id">sp</span> <span class="id">base</span> <span class="id">hi</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2633')">Proof.</div>
<div class="proofscript" id="proof2633">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">hi</span>; <span class="tactic">intros</span> <span class="id">RP</span> <span class="id">PERM</span> <span class="id">UNCH</span> <span class="id">INJ</span> <span class="id">INCR</span> <span class="id">SEP</span> <span class="id">VB</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">RP</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_unchanged_on</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">SEP</span>. <span class="tactic">destruct</span> (<span class="id">F</span> <span class="id">b</span>) <span class="kwd">as</span> [[<span class="id">sp1</span> <span class="id">delta1</span>] |] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">INCR</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">EQ</span>; <span class="tactic">rewrite</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">EQ</span>; <span class="id">inv</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>; <span class="id">eelim</span> <span class="id">B</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">PERM</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>. <span class="tactic">destruct</span> (<span class="id">plt</span> <span class="id">b</span> (<span class="id">Mem.nextblock</span> <span class="id">m1</span>)); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.mi_freeblocks</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">SEP</span>; <span class="tactic">eauto</span>. <span class="tactic">tauto</span>.<br/>
Qed.</div>
<br/>
<h2> Relating global environments </h2>
<br/>
<span class="kwd">Inductive</span> <span class="id">match_globalenvs</span> (<span class="id">F</span>: <span class="id">meminj</span>) (<span class="id">bound</span>: <span class="id">block</span>): <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">mk_match_globalenvs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">DOMAIN</span>: <span class="kwd">forall</span> <span class="id">b</span>, <span class="id">Plt</span> <span class="id">b</span> <span class="id">bound</span> -&gt; <span class="id">F</span> <span class="id">b</span> = <span class="id">Some</span>(<span class="id">b</span>, 0))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">IMAGE</span>: <span class="kwd">forall</span> <span class="id">b1</span> <span class="id">b2</span> <span class="id">delta</span>, <span class="id">F</span> <span class="id">b1</span> = <span class="id">Some</span>(<span class="id">b2</span>, <span class="id">delta</span>) -&gt; <span class="id">Plt</span> <span class="id">b2</span> <span class="id">bound</span> -&gt; <span class="id">b1</span> = <span class="id">b2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SYMBOLS</span>: <span class="kwd">forall</span> <span class="id">id</span> <span class="id">b</span>, <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">id</span> = <span class="id">Some</span> <span class="id">b</span> -&gt; <span class="id">Plt</span> <span class="id">b</span> <span class="id">bound</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">FUNCTIONS</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">fd</span>, <span class="id">Genv.find_funct_ptr</span> <span class="id">ge</span> <span class="id">b</span> = <span class="id">Some</span> <span class="id">fd</span> -&gt; <span class="id">Plt</span> <span class="id">b</span> <span class="id">bound</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VARINFOS</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">gv</span>, <span class="id">Genv.find_var_info</span> <span class="id">ge</span> <span class="id">b</span> = <span class="id">Some</span> <span class="id">gv</span> -&gt; <span class="id">Plt</span> <span class="id">b</span> <span class="id">bound</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">find_function_agree</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ros</span> <span class="id">rs</span> <span class="id">fd</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span>' <span class="id">bound</span>,<br/>
&nbsp;&nbsp;<span class="id">find_function</span> <span class="id">ge</span> <span class="id">ros</span> <span class="id">rs</span> = <span class="id">Some</span> <span class="id">fd</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_globalenvs</span> <span class="id">F</span> <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">cu</span> <span class="id">fd</span>',<br/>
&nbsp;&nbsp;<span class="id">find_function</span> <span class="id">tge</span> (<span class="id">sros</span> <span class="id">ctx</span> <span class="id">ros</span>) <span class="id">rs</span>' = <span class="id">Some</span> <span class="id">fd</span>' /\ <span class="id">transf_fundef</span> (<span class="id">funenv_program</span> <span class="id">cu</span>) <span class="id">fd</span> = <span class="id">OK</span> <span class="id">fd</span>' /\ <span class="id">linkorder</span> <span class="id">cu</span> <span class="id">prog</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2634')">Proof.</div>
<div class="proofscript" id="proof2634">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">ros</span> <span class="kwd">as</span> [<span class="id">r</span> | <span class="id">id</span>]; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
- <span class="comment">(*&nbsp;register&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">EQ</span>: <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>) = <span class="id">rs</span>#<span class="id">r</span>).<br/>
&nbsp;&nbsp;{ <span class="id">exploit</span> <span class="id">Genv.find_funct_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">b</span> <span class="id">EQ</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">A</span>: <span class="id">Val.inject</span> <span class="id">F</span> <span class="id">rs</span>#<span class="id">r</span> <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>)). <span class="tactic">eapply</span> <span class="id">agree_val_reg</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">EQ</span> <span class="kwd">in</span> <span class="id">A</span>; <span class="id">inv</span> <span class="id">A</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H1</span>. <span class="tactic">rewrite</span> <span class="id">DOMAIN</span> <span class="kwd">in</span> <span class="id">H5</span>. <span class="id">inv</span> <span class="id">H5</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">FUNCTIONS</span> <span class="kwd">with</span> <span class="id">fd</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">EQ</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">rewrite</span> <span class="id">Genv.find_funct_find_funct_ptr</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">EQ</span>. <span class="tactic">eapply</span> <span class="id">functions_translated</span>; <span class="tactic">eauto</span>.<br/>
- <span class="comment">(*&nbsp;symbol&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">symbols_preserved</span>. <span class="tactic">destruct</span> (<span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">id</span>); <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">function_ptr_translated</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">find_inlined_function</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">fenv</span> <span class="id">id</span> <span class="id">rs</span> <span class="id">fd</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">fenv_compat</span> <span class="id">prog</span> <span class="id">fenv</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">find_function</span> <span class="id">ge</span> (<span class="id">inr</span> <span class="id">id</span>) <span class="id">rs</span> = <span class="id">Some</span> <span class="id">fd</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">fenv</span>!<span class="id">id</span> = <span class="id">Some</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">fd</span> = <span class="id">Internal</span> <span class="id">f</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2635')">Proof.</div>
<div class="proofscript" id="proof2635">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="tactic">apply</span> <span class="id">Genv.find_def_symbol</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="tactic">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> (<span class="id">b</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span>).<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">unfold</span> <span class="id">ge</span>, <span class="id">fundef</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">A</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">Genv.find_funct_ptr_iff</span> <span class="kwd">in</span> <span class="id">B</span>.<br/>
&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Translation of builtin arguments. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">tr_builtin_arg</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">bound</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">sp</span> <span class="id">sp</span>' <span class="id">m</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">match_globalenvs</span> <span class="id">F</span> <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">F</span> <span class="id">sp</span> = <span class="id">Some</span>(<span class="id">sp</span>', <span class="id">ctx</span>.(<span class="id">dstk</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">eval_builtin_arg</span> <span class="id">ge</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">rs</span>#<span class="id">r</span>) (<span class="id">Vptr</span> <span class="id">sp</span> <span class="id">Ptrofs.zero</span>) <span class="id">m</span> <span class="id">a</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>', <span class="id">eval_builtin_arg</span> <span class="id">tge</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">rs</span>'#<span class="id">r</span>) (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) <span class="id">m</span>' (<span class="id">sbuiltinarg</span> <span class="id">ctx</span> <span class="id">a</span>) <span class="id">v</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">Val.inject</span> <span class="id">F</span> <span class="id">v</span> <span class="id">v</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2636')">Proof.</div>
<div class="proofscript" id="proof2636">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">m</span>'; <span class="tactic">intros</span> <span class="id">MG</span> <span class="id">AG</span> <span class="id">SP</span> <span class="id">MI</span>. <span class="tactic">induction</span> 1; <span class="tactic">simpl</span>.<br/>
- <span class="id">exists</span> <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">x</span>); <span class="tactic">split</span>. <span class="id">constructor</span>. <span class="tactic">eapply</span> <span class="id">agree_val_reg</span>; <span class="tactic">eauto</span>.<br/>
- <span class="id">econstructor</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">barg</span>.<br/>
- <span class="id">econstructor</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">barg</span>.<br/>
- <span class="id">econstructor</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">barg</span>.<br/>
- <span class="id">econstructor</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">barg</span>.<br/>
- <span class="id">exploit</span> <span class="id">Mem.loadv_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">Vptr</span> <span class="id">sp</span>' (<span class="id">Ptrofs.add</span> <span class="id">ofs</span> (<span class="id">Ptrofs.repr</span> (<span class="id">dstk</span> <span class="id">ctx</span>)))).<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">Ptrofs.add_zero_l</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> (<span class="id">v</span>' &amp; <span class="id">A</span> &amp; <span class="id">B</span>). <span class="id">exists</span> <span class="id">v</span>'; <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="id">constructor</span>. <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id">Ptrofs.add_zero_l</span>; <span class="tactic">auto</span>.<br/>
- <span class="id">econstructor</span>; <span class="tactic">split</span>. <span class="id">constructor</span>. <span class="tactic">simpl</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> ! <span class="id">Ptrofs.add_zero_l</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">assert</span> (<span class="id">Val.inject</span> <span class="id">F</span> (<span class="id">Senv.symbol_address</span> <span class="id">ge</span> <span class="id">id</span> <span class="id">ofs</span>) (<span class="id">Senv.symbol_address</span> <span class="id">tge</span> <span class="id">id</span> <span class="id">ofs</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">unfold</span> <span class="id">Senv.symbol_address</span>; <span class="tactic">simpl</span>; <span class="tactic">unfold</span> <span class="id">Genv.symbol_address</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">symbols_preserved</span>. <span class="tactic">destruct</span> (<span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">id</span>) <span class="kwd">as</span> [<span class="id">b</span>|] <span class="id">eqn</span>:<span class="id">FS</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MG</span>. <span class="id">econstructor</span>. <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">Ptrofs.add_zero</span>; <span class="tactic">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.loadv_inject</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> (<span class="id">v</span>' &amp; <span class="id">A</span> &amp; <span class="id">B</span>).<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>'; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">barg</span>.<br/>
- <span class="id">econstructor</span>; <span class="tactic">split</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">Senv.symbol_address</span>; <span class="tactic">simpl</span>; <span class="tactic">unfold</span> <span class="id">Genv.symbol_address</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">symbols_preserved</span>. <span class="tactic">destruct</span> (<span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">id</span>) <span class="kwd">as</span> [<span class="id">b</span>|] <span class="id">eqn</span>:<span class="id">FS</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MG</span>. <span class="id">econstructor</span>. <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">Ptrofs.add_zero</span>; <span class="tactic">auto</span>.<br/>
- <span class="tactic">destruct</span> <span class="id">IHeval_builtin_arg1</span> <span class="kwd">as</span> (<span class="id">v1</span> &amp; <span class="id">A1</span> &amp; <span class="id">B1</span>).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">IHeval_builtin_arg2</span> <span class="kwd">as</span> (<span class="id">v2</span> &amp; <span class="id">A2</span> &amp; <span class="id">B2</span>).<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">split</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">barg</span>. <span class="tactic">apply</span> <span class="id">Val.longofwords_inject</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">tr_builtin_args</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">bound</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' <span class="id">sp</span> <span class="id">sp</span>' <span class="id">m</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">match_globalenvs</span> <span class="id">F</span> <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">F</span> <span class="id">sp</span> = <span class="id">Some</span>(<span class="id">sp</span>', <span class="id">ctx</span>.(<span class="id">dstk</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">al</span> <span class="id">vl</span>,<br/>
&nbsp;&nbsp;<span class="id">eval_builtin_args</span> <span class="id">ge</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">rs</span>#<span class="id">r</span>) (<span class="id">Vptr</span> <span class="id">sp</span> <span class="id">Ptrofs.zero</span>) <span class="id">m</span> <span class="id">al</span> <span class="id">vl</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">vl</span>', <span class="id">eval_builtin_args</span> <span class="id">tge</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">rs</span>'#<span class="id">r</span>) (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) <span class="id">m</span>' (<span class="id">map</span> (<span class="id">sbuiltinarg</span> <span class="id">ctx</span>) <span class="id">al</span>) <span class="id">vl</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">Val.inject_list</span> <span class="id">F</span> <span class="id">vl</span> <span class="id">vl</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2637')">Proof.</div>
<div class="proofscript" id="proof2637">
&nbsp;&nbsp;<span class="tactic">induction</span> 5; <span class="tactic">simpl</span>.<br/>
- <span class="id">exists</span> (@<span class="id">nil</span> <span class="id">val</span>); <span class="tactic">split</span>; <span class="id">constructor</span>.<br/>
- <span class="id">exploit</span> <span class="id">tr_builtin_arg</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> (<span class="id">v1</span>' &amp; <span class="id">A</span> &amp; <span class="id">B</span>).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">IHlist_forall2</span> <span class="kwd">as</span> (<span class="id">vl</span>' &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;<span class="id">exists</span> (<span class="id">v1</span>' :: <span class="id">vl</span>'); <span class="tactic">split</span>; <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> Relating stacks </h2>
<br/>
<span class="kwd">Inductive</span> <span class="id">match_stacks</span> (<span class="id">F</span>: <span class="id">meminj</span>) (<span class="id">m</span> <span class="id">m</span>': <span class="id">mem</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">list</span> <span class="id">stackframe</span> -&gt; <span class="id">list</span> <span class="id">stackframe</span> -&gt; <span class="id">block</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">match_stacks_nil</span>: <span class="kwd">forall</span> <span class="id">bound1</span> <span class="id">bound</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MG</span>: <span class="id">match_globalenvs</span> <span class="id">F</span> <span class="id">bound1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">BELOW</span>: <span class="id">Ple</span> <span class="id">bound1</span> <span class="id">bound</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">nil</span> <span class="id">nil</span> <span class="id">bound</span><br/>
&nbsp;&nbsp;| <span class="id">match_stacks_cons</span>: <span class="kwd">forall</span> <span class="id">res</span> <span class="id">f</span> <span class="id">sp</span> <span class="id">pc</span> <span class="id">rs</span> <span class="id">stk</span> <span class="id">f</span>' <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">stk</span>' <span class="id">bound</span> <span class="id">fenv</span> <span class="id">ctx</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">COMPAT</span>: <span class="id">fenv_compat</span> <span class="id">prog</span> <span class="id">fenv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">FB</span>: <span class="id">tr_funbody</span> <span class="id">fenv</span> <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) <span class="id">ctx</span> <span class="id">f</span> <span class="id">f</span>'.(<span class="id">fn_code</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">AG</span>: <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SP</span>: <span class="id">F</span> <span class="id">sp</span> = <span class="id">Some</span>(<span class="id">sp</span>', <span class="id">ctx</span>.(<span class="id">dstk</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PRIV</span>: <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' (<span class="id">ctx</span>.(<span class="id">dstk</span>) + <span class="id">ctx</span>.(<span class="id">mstk</span>)) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ1</span>: 0 &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) &lt; <span class="id">Ptrofs.max_unsigned</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ2</span>: <span class="kwd">forall</span> <span class="id">ofs</span>, <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt; 0 &lt;= <span class="id">ofs</span> &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RES</span>: <span class="id">Ple</span> <span class="id">res</span> <span class="id">ctx</span>.(<span class="id">mreg</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">BELOW</span>: <span class="id">Plt</span> <span class="id">sp</span>' <span class="id">bound</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Stackframe</span> <span class="id">res</span> <span class="id">f</span> (<span class="id">Vptr</span> <span class="id">sp</span> <span class="id">Ptrofs.zero</span>) <span class="id">pc</span> <span class="id">rs</span> :: <span class="id">stk</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Stackframe</span> (<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">res</span>) <span class="id">f</span>' (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) <span class="id">rs</span>' :: <span class="id">stk</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bound</span><br/>
&nbsp;&nbsp;| <span class="id">match_stacks_untailcall</span>: <span class="kwd">forall</span> <span class="id">stk</span> <span class="id">res</span> <span class="id">f</span>' <span class="id">sp</span>' <span class="id">rpc</span> <span class="id">rs</span>' <span class="id">stk</span>' <span class="id">bound</span> <span class="id">ctx</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PRIV</span>: <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ctx</span>.(<span class="id">dstk</span>) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ1</span>: 0 &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) &lt; <span class="id">Ptrofs.max_unsigned</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ2</span>: <span class="kwd">forall</span> <span class="id">ofs</span>, <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt; 0 &lt;= <span class="id">ofs</span> &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RET</span>: <span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">Some</span> (<span class="id">rpc</span>, <span class="id">res</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">BELOW</span>: <span class="id">Plt</span> <span class="id">sp</span>' <span class="id">bound</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">stk</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Stackframe</span> <span class="id">res</span> <span class="id">f</span>' (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) <span class="id">rpc</span> <span class="id">rs</span>' :: <span class="id">stk</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bound</span><br/>
<br/>
<span class="kwd">with</span> <span class="id">match_stacks_inside</span> (<span class="id">F</span>: <span class="id">meminj</span>) (<span class="id">m</span> <span class="id">m</span>': <span class="id">mem</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">list</span> <span class="id">stackframe</span> -&gt; <span class="id">list</span> <span class="id">stackframe</span> -&gt; <span class="id">function</span> -&gt; <span class="id">context</span> -&gt; <span class="id">block</span> -&gt; <span class="id">regset</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">match_stacks_inside_base</span>: <span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">sp</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RET</span>: <span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">None</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">DSTK</span>: <span class="id">ctx</span>.(<span class="id">dstk</span>) = 0),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>'<br/>
&nbsp;&nbsp;| <span class="id">match_stacks_inside_inlined</span>: <span class="kwd">forall</span> <span class="id">res</span> <span class="id">f</span> <span class="id">sp</span> <span class="id">pc</span> <span class="id">rs</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">fenv</span> <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">ctx</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span>' <span class="id">sp</span>' <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">COMPAT</span>: <span class="id">fenv_compat</span> <span class="id">prog</span> <span class="id">fenv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">FB</span>: <span class="id">tr_funbody</span> <span class="id">fenv</span> <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) <span class="id">ctx</span>' <span class="id">f</span> <span class="id">f</span>'.(<span class="id">fn_code</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">AG</span>: <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span>' <span class="id">rs</span> <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SP</span>: <span class="id">F</span> <span class="id">sp</span> = <span class="id">Some</span>(<span class="id">sp</span>', <span class="id">ctx</span>'.(<span class="id">dstk</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PAD</span>: <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' (<span class="id">ctx</span>'.(<span class="id">dstk</span>) + <span class="id">ctx</span>'.(<span class="id">mstk</span>)) <span class="id">ctx</span>.(<span class="id">dstk</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RES</span>: <span class="id">Ple</span> <span class="id">res</span> <span class="id">ctx</span>'.(<span class="id">mreg</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RET</span>: <span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">Some</span> (<span class="id">spc</span> <span class="id">ctx</span>' <span class="id">pc</span>, <span class="id">sreg</span> <span class="id">ctx</span>' <span class="id">res</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">BELOW</span>: <span class="id">context_below</span> <span class="id">ctx</span>' <span class="id">ctx</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SBELOW</span>: <span class="id">context_stack_call</span> <span class="id">ctx</span>' <span class="id">ctx</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' (<span class="id">Stackframe</span> <span class="id">res</span> <span class="id">f</span> (<span class="id">Vptr</span> <span class="id">sp</span> <span class="id">Ptrofs.zero</span>) <span class="id">pc</span> <span class="id">rs</span> :: <span class="id">stk</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>'.<br/>
<br/>
<div class="doc">Properties of match_stacks </div>
<br/>
<span class="kwd">Section</span> <span class="id">MATCH_STACKS</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">F</span>: <span class="id">meminj</span>.<br/>
<span class="kwd">Variables</span> <span class="id">m</span> <span class="id">m</span>': <span class="id">mem</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_globalenvs</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span> -&gt; <span class="id">exists</span> <span class="id">b</span>, <span class="id">match_globalenvs</span> <span class="id">F</span> <span class="id">b</span><br/>
<span class="kwd">with</span> <span class="id">match_stacks_inside_globalenvs</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span> <span class="id">ctx</span> <span class="id">sp</span> <span class="id">rs</span>',<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span> <span class="id">ctx</span> <span class="id">sp</span> <span class="id">rs</span>' -&gt; <span class="id">exists</span> <span class="id">b</span>, <span class="id">match_globalenvs</span> <span class="id">F</span> <span class="id">b</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2638')">Proof.</div>
<div class="proofscript" id="proof2638">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_globalenvs_preserves_globals</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">b</span>, <span class="id">match_globalenvs</span> <span class="id">F</span> <span class="id">b</span> -&gt; <span class="id">meminj_preserves_globals</span> <span class="id">ge</span> <span class="id">F</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2639')">Proof.</div>
<div class="proofscript" id="proof2639">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>. <span class="tactic">red</span>. <span class="tactic">split</span>. <span class="tactic">eauto</span>. <span class="tactic">split</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">symmetry</span>. <span class="tactic">eapply</span> <span class="id">IMAGE</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_inside_globals</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span> <span class="id">ctx</span> <span class="id">sp</span> <span class="id">rs</span>',<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span> <span class="id">ctx</span> <span class="id">sp</span> <span class="id">rs</span>' -&gt; <span class="id">meminj_preserves_globals</span> <span class="id">ge</span> <span class="id">F</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2640')">Proof.</div>
<div class="proofscript" id="proof2640">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">match_stacks_inside_globalenvs</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">b</span> <span class="id">A</span>].<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_globalenvs_preserves_globals</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_bound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span> <span class="id">bound1</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">bound</span> <span class="id">bound1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound1</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2641')">Proof.</div>
<div class="proofscript" id="proof2641">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_nil</span> <span class="kwd">with</span> <span class="id">bound0</span>. <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id">Ple_trans</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_cons</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">Plt_le_trans</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_untailcall</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">Plt_le_trans</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Variable</span> <span class="id">F1</span>: <span class="id">meminj</span>.<br/>
<span class="kwd">Variables</span> <span class="id">m1</span> <span class="id">m1</span>': <span class="id">mem</span>.<br/>
<span class="kwd">Hypothesis</span> <span class="id">INCR</span>: <span class="id">inject_incr</span> <span class="id">F</span> <span class="id">F1</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_invariant</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span>, <span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">INJ</span>: <span class="kwd">forall</span> <span class="id">b1</span> <span class="id">b2</span> <span class="id">delta</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">F1</span> <span class="id">b1</span> = <span class="id">Some</span>(<span class="id">b2</span>, <span class="id">delta</span>) -&gt; <span class="id">Plt</span> <span class="id">b2</span> <span class="id">bound</span> -&gt; <span class="id">F</span> <span class="id">b1</span> = <span class="id">Some</span>(<span class="id">b2</span>, <span class="id">delta</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PERM1</span>: <span class="kwd">forall</span> <span class="id">b1</span> <span class="id">b2</span> <span class="id">delta</span> <span class="id">ofs</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">F1</span> <span class="id">b1</span> = <span class="id">Some</span>(<span class="id">b2</span>, <span class="id">delta</span>) -&gt; <span class="id">Plt</span> <span class="id">b2</span> <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m1</span> <span class="id">b1</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m</span> <span class="id">b1</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PERM2</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span>, <span class="id">Plt</span> <span class="id">b</span> <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">Cur</span> <span class="id">Freeable</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m1</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">Cur</span> <span class="id">Freeable</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PERM3</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">k</span> <span class="id">p</span>, <span class="id">Plt</span> <span class="id">b</span> <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m1</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">k</span> <span class="id">p</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">k</span> <span class="id">p</span>),<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m1</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span><br/>
<br/>
<span class="kwd">with</span> <span class="id">match_stacks_inside_invariant</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs1</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">rs2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RS</span>: <span class="kwd">forall</span> <span class="id">r</span>, <span class="id">Plt</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">dreg</span>) -&gt; <span class="id">rs2</span>#<span class="id">r</span> = <span class="id">rs1</span>#<span class="id">r</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">INJ</span>: <span class="kwd">forall</span> <span class="id">b1</span> <span class="id">b2</span> <span class="id">delta</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">F1</span> <span class="id">b1</span> = <span class="id">Some</span>(<span class="id">b2</span>, <span class="id">delta</span>) -&gt; <span class="id">Ple</span> <span class="id">b2</span> <span class="id">sp</span>' -&gt; <span class="id">F</span> <span class="id">b1</span> = <span class="id">Some</span>(<span class="id">b2</span>, <span class="id">delta</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PERM1</span>: <span class="kwd">forall</span> <span class="id">b1</span> <span class="id">b2</span> <span class="id">delta</span> <span class="id">ofs</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">F1</span> <span class="id">b1</span> = <span class="id">Some</span>(<span class="id">b2</span>, <span class="id">delta</span>) -&gt; <span class="id">Ple</span> <span class="id">b2</span> <span class="id">sp</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m1</span> <span class="id">b1</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m</span> <span class="id">b1</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PERM2</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span>, <span class="id">Ple</span> <span class="id">b</span> <span class="id">sp</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">Cur</span> <span class="id">Freeable</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m1</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">Cur</span> <span class="id">Freeable</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PERM3</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">k</span> <span class="id">p</span>, <span class="id">Ple</span> <span class="id">b</span> <span class="id">sp</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Mem.perm</span> <span class="id">m1</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">k</span> <span class="id">p</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">k</span> <span class="id">p</span>),<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m1</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs2</span>.<br/>
<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2642')">Proof.</div>
<div class="proofscript" id="proof2642">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;nil&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_nil</span> <span class="kwd">with</span> (<span class="id">bound1</span> := <span class="id">bound1</span>).<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MG</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">IMAGE</span> <span class="kwd">with</span> <span class="id">delta</span>. <span class="tactic">eapply</span> <span class="id">INJ</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">Plt_le_trans</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;cons&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_cons</span> <span class="kwd">with</span> (<span class="id">fenv</span> := <span class="id">fenv</span>) (<span class="id">ctx</span> := <span class="id">ctx</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">INJ</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM1</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM2</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM3</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_regs_incr</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;untailcall&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_untailcall</span> <span class="kwd">with</span> (<span class="id">ctx</span> := <span class="id">ctx</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">INJ</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM1</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM2</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM3</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_invariant</span>; <span class="tactic">eauto</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;base&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_base</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">INJ</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM1</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM2</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">PERM3</span>; <span class="tactic">eauto</span>; <span class="id">xomega</span>.<br/>
&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_inside_inlined</span> <span class="kwd">with</span> (<span class="id">fenv</span> := <span class="id">fenv</span>) (<span class="id">ctx</span>' := <span class="id">ctx</span>'); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHmatch_stacks_inside</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">RS</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">BELOW</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_regs_incr</span> <span class="kwd">with</span> <span class="id">F</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_regs_invariant</span> <span class="kwd">with</span> <span class="id">rs</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">RS</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">BELOW</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">INJ</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>. <span class="tactic">eapply</span> <span class="id">PERM1</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">PERM2</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_empty</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span> -&gt; <span class="id">stk</span> = <span class="id">nil</span> -&gt; <span class="id">stk</span>' = <span class="id">nil</span><br/>
<span class="kwd">with</span> <span class="id">match_stacks_inside_empty</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span> <span class="id">ctx</span> <span class="id">sp</span> <span class="id">rs</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span> <span class="id">ctx</span> <span class="id">sp</span> <span class="id">rs</span> -&gt; <span class="id">stk</span> = <span class="id">nil</span> -&gt; <span class="id">stk</span>' = <span class="id">nil</span> /\ <span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">None</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2643')">Proof.</div>
<div class="proofscript" id="proof2643">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">match_stacks_inside_empty</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">match_stacks_empty</span>; <span class="tactic">eauto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">discriminate</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">MATCH_STACKS</span>.<br/>
<br/>
<div class="doc">Preservation by assignment to a register </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_inside_set_reg</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">r</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' (<span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>) &lt;- <span class="id">v</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2644')">Proof.</div>
<div class="proofscript" id="proof2644">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">Regmap.gso</span>. <span class="id">zify</span>. <span class="tactic">unfold</span> <span class="id">sreg</span>; <span class="tactic">rewrite</span> <span class="id">shiftpos_eq</span>. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_inside_set_res</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">res</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' (<span class="id">regmap_setres</span> (<span class="id">sbuiltinres</span> <span class="id">ctx</span> <span class="id">res</span>) <span class="id">v</span> <span class="id">rs</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2645')">Proof.</div>
<div class="proofscript" id="proof2645">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">res</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_inside_set_reg</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Preservation by a memory store </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_inside_store</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">chunk</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">m1</span> <span class="id">chunk</span>' <span class="id">b</span>' <span class="id">ofs</span>' <span class="id">v</span>' <span class="id">m1</span>',<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.store</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> = <span class="id">Some</span> <span class="id">m1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.store</span> <span class="id">chunk</span>' <span class="id">m</span>' <span class="id">b</span>' <span class="id">ofs</span>' <span class="id">v</span>' = <span class="id">Some</span> <span class="id">m1</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m1</span> <span class="id">m1</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2646')">Proof.</div>
<div class="proofscript" id="proof2646">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">mem</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Preservation by an allocation </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_inside_alloc_left</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>',<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">sz</span> <span class="id">m1</span> <span class="id">b</span> <span class="id">F1</span> <span class="id">delta</span>,<br/>
&nbsp;&nbsp;<span class="id">Mem.alloc</span> <span class="id">m</span> 0 <span class="id">sz</span> = (<span class="id">m1</span>, <span class="id">b</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">inject_incr</span> <span class="id">F</span> <span class="id">F1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">F1</span> <span class="id">b</span> = <span class="id">Some</span>(<span class="id">sp</span>', <span class="id">delta</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b1</span>, <span class="id">b1</span> &lt;&gt; <span class="id">b</span> -&gt; <span class="id">F1</span> <span class="id">b1</span> = <span class="id">F</span> <span class="id">b1</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">delta</span> &gt;= <span class="id">ctx</span>.(<span class="id">dstk</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2647')">Proof.</div>
<div class="proofscript" id="proof2647">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;base&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_base</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b1</span> <span class="id">b</span>).<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">b1</span>. <span class="tactic">rewrite</span> <span class="id">H1</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="id">inv</span> <span class="id">H4</span>. <span class="id">eelim</span> <span class="id">Plt_strict</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H2</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">Mem.perm_alloc_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b1</span> <span class="id">b</span>); <span class="tactic">intros</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">b1</span>. <span class="tactic">rewrite</span> <span class="id">H1</span> <span class="kwd">in</span> <span class="id">H4</span>. <span class="id">inv</span> <span class="id">H4</span>. <span class="id">eelim</span> <span class="id">Plt_strict</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_inlined</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">IHmatch_stacks_inside</span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> <span class="id">SBELOW</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_regs_incr</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">Mem.perm_alloc_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b0</span> <span class="id">b</span>); <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">b0</span>. <span class="tactic">rewrite</span> <span class="id">H2</span> <span class="kwd">in</span> <span class="id">H5</span>; <span class="id">inv</span> <span class="id">H5</span>. <span class="tactic">elimtype</span> <span class="id">False</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H3</span> <span class="kwd">in</span> <span class="id">H5</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Preservation by freeing </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_free_left</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">sp</span> <span class="id">b</span> <span class="id">lo</span> <span class="id">hi</span> <span class="id">m1</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">sp</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.free</span> <span class="id">m</span> <span class="id">b</span> <span class="id">lo</span> <span class="id">hi</span> = <span class="id">Some</span> <span class="id">m1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m1</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">sp</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2648')">Proof.</div>
<div class="proofscript" id="proof2648">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">match_stacks_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_free_right</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span> <span class="id">m1</span>',<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">sp</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Mem.free</span> <span class="id">m</span>' <span class="id">sp</span> <span class="id">lo</span> <span class="id">hi</span> = <span class="id">Some</span> <span class="id">m1</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m1</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">sp</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2649')">Proof.</div>
<div class="proofscript" id="proof2649">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">match_stacks_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_1</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">min_alignment_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">sz</span> <span class="id">n</span>, (<span class="id">min_alignment</span> <span class="id">sz</span> | <span class="id">n</span>) -&gt; <span class="id">Mem.inj_offset_aligned</span> <span class="id">n</span> <span class="id">sz</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2650')">Proof.</div>
<div class="proofscript" id="proof2650">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">min_alignment</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (2 &lt;= <span class="id">sz</span> -&gt; (2 | <span class="id">n</span>)). <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 1). <span class="id">omegaContradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 2). <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 4). <span class="tactic">apply</span> <span class="id">Zdivides_trans</span> <span class="kwd">with</span> 4; <span class="tactic">auto</span>. <span class="id">exists</span> 2; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Zdivides_trans</span> <span class="kwd">with</span> 8; <span class="tactic">auto</span>. <span class="id">exists</span> 4; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (4 &lt;= <span class="id">sz</span> -&gt; (4 | <span class="id">n</span>)). <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 1). <span class="id">omegaContradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 2). <span class="id">omegaContradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 4). <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Zdivides_trans</span> <span class="kwd">with</span> 8; <span class="tactic">auto</span>. <span class="id">exists</span> 2; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (8 &lt;= <span class="id">sz</span> -&gt; (8 | <span class="id">n</span>)). <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 1). <span class="id">omegaContradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 2). <span class="id">omegaContradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 4). <span class="id">omegaContradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">chunk</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Zone_divide</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Zone_divide</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H2</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H2</span>; <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Preservation by external calls </div>
<br/>
<span class="kwd">Section</span> <span class="id">EXTCALL</span>.<br/>
<br/>
<span class="kwd">Variables</span> <span class="id">F1</span> <span class="id">F2</span>: <span class="id">meminj</span>.<br/>
<span class="kwd">Variables</span> <span class="id">m1</span> <span class="id">m2</span> <span class="id">m1</span>' <span class="id">m2</span>': <span class="id">mem</span>.<br/>
<span class="kwd">Hypothesis</span> <span class="id">MAXPERM</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">p</span>, <span class="id">Mem.valid_block</span> <span class="id">m1</span> <span class="id">b</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m2</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">p</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m1</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">p</span>.<br/>
<span class="kwd">Hypothesis</span> <span class="id">MAXPERM</span>': <span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">p</span>, <span class="id">Mem.valid_block</span> <span class="id">m1</span>' <span class="id">b</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m2</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">p</span> -&gt; <span class="id">Mem.perm</span> <span class="id">m1</span>' <span class="id">b</span> <span class="id">ofs</span> <span class="id">Max</span> <span class="id">p</span>.<br/>
<span class="kwd">Hypothesis</span> <span class="id">UNCHANGED</span>: <span class="id">Mem.unchanged_on</span> (<span class="id">loc_out_of_reach</span> <span class="id">F1</span> <span class="id">m1</span>) <span class="id">m1</span>' <span class="id">m2</span>'.<br/>
<span class="kwd">Hypothesis</span> <span class="id">INJ</span>: <span class="id">Mem.inject</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m1</span>'.<br/>
<span class="kwd">Hypothesis</span> <span class="id">INCR</span>: <span class="id">inject_incr</span> <span class="id">F1</span> <span class="id">F2</span>.<br/>
<span class="kwd">Hypothesis</span> <span class="id">SEP</span>: <span class="id">inject_separated</span> <span class="id">F1</span> <span class="id">F2</span> <span class="id">m1</span> <span class="id">m1</span>'.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_extcall</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m1</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">bound</span> (<span class="id">Mem.nextblock</span> <span class="id">m1</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks</span> <span class="id">F2</span> <span class="id">m2</span> <span class="id">m2</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">bound</span><br/>
<span class="kwd">with</span> <span class="id">match_stacks_inside_extcall</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>',<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F1</span> <span class="id">m1</span> <span class="id">m1</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> <span class="id">sp</span>' (<span class="id">Mem.nextblock</span> <span class="id">m1</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F2</span> <span class="id">m2</span> <span class="id">m2</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2651')">Proof.</div>
<div class="proofscript" id="proof2651">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_nil</span> <span class="kwd">with</span> <span class="id">bound1</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MG</span>. <span class="id">constructor</span>; <span class="tactic">intros</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">F1</span> <span class="id">b1</span>) <span class="kwd">as</span> [[<span class="id">b2</span>' <span class="id">delta</span>']|] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">INCR</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">EQ</span>; <span class="tactic">rewrite</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">EQ</span>; <span class="id">inv</span> <span class="id">EQ</span>. <span class="tactic">eapply</span> <span class="id">IMAGE</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">SEP</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="tactic">elim</span> <span class="id">B</span>. <span class="tactic">red</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_cons</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_extcall</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_regs_incr</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_extcall</span>; <span class="tactic">eauto</span>. <span class="tactic">red</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">SSZ2</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">MAXPERM</span>'; <span class="tactic">auto</span>. <span class="tactic">red</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_untailcall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_extcall</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_extcall</span>; <span class="tactic">eauto</span>. <span class="tactic">red</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">SSZ2</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">MAXPERM</span>'; <span class="tactic">auto</span>. <span class="tactic">red</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_base</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_extcall</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_inlined</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_regs_incr</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_extcall</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">EXTCALL</span>.<br/>
<br/>
<div class="doc">Change of context corresponding to an inlined tailcall </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">align_unchanged</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">amount</span>, <span class="id">amount</span> &gt; 0 -&gt; (<span class="id">amount</span> | <span class="id">n</span>) -&gt; <span class="id">align</span> <span class="id">n</span> <span class="id">amount</span> = <span class="id">n</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2652')">Proof.</div>
<div class="proofscript" id="proof2652">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H0</span> <span class="kwd">as</span> [<span class="id">p</span> <span class="id">EQ</span>]. <span class="tactic">subst</span> <span class="id">n</span>. <span class="tactic">unfold</span> <span class="id">align</span>. <span class="id">decEq</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Zdiv_unique</span> <span class="kwd">with</span> (<span class="id">b</span> := <span class="id">amount</span> - 1). <span class="tactic">omega</span>. <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">match_stacks_inside_inlined_tailcall</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">fenv</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">ctx</span>' <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">context_below</span> <span class="id">ctx</span> <span class="id">ctx</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">context_stack_tailcall</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">ctx</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>'.(<span class="id">retinfo</span>) = <span class="id">ctx</span>.(<span class="id">retinfo</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ctx</span>.(<span class="id">dstk</span>) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">fenv</span> <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) <span class="id">ctx</span>' <span class="id">f</span> <span class="id">f</span>'.(<span class="id">fn_code</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span>' <span class="id">sp</span>' <span class="id">rs</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2653')">Proof.</div>
<div class="proofscript" id="proof2653">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;base&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_base</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">rewrite</span> <span class="id">DSTK</span>. <span class="tactic">apply</span> <span class="id">align_unchanged</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>. <span class="tactic">apply</span> <span class="id">Zdivide_0</span>.<br/>
&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">dstk</span> <span class="id">ctx</span> &lt;= <span class="id">dstk</span> <span class="id">ctx</span>'). <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">apply</span> <span class="id">align_le</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_inlined</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">zlt</span> <span class="id">ofs</span> (<span class="id">dstk</span> <span class="id">ctx</span>)). <span class="tactic">apply</span> <span class="id">PAD</span>; <span class="tactic">omega</span>. <span class="tactic">apply</span> <span class="id">H3</span>. <span class="id">inv</span> <span class="id">H4</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">context_below</span> <span class="kwd">in</span> *. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">context_stack_call</span> <span class="kwd">in</span> *. <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<h2> Relating states </h2>
<br/>
<span class="kwd">Inductive</span> <span class="id">match_states</span>: <span class="id">RTL.state</span> -&gt; <span class="id">RTL.state</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">match_regular_states</span>: <span class="kwd">forall</span> <span class="id">stk</span> <span class="id">f</span> <span class="id">sp</span> <span class="id">pc</span> <span class="id">rs</span> <span class="id">m</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">m</span>' <span class="id">F</span> <span class="id">fenv</span> <span class="id">ctx</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">COMPAT</span>: <span class="id">fenv_compat</span> <span class="id">prog</span> <span class="id">fenv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">FB</span>: <span class="id">tr_funbody</span> <span class="id">fenv</span> <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) <span class="id">ctx</span> <span class="id">f</span> <span class="id">f</span>'.(<span class="id">fn_code</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">AG</span>: <span class="id">agree_regs</span> <span class="id">F</span> <span class="id">ctx</span> <span class="id">rs</span> <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SP</span>: <span class="id">F</span> <span class="id">sp</span> = <span class="id">Some</span>(<span class="id">sp</span>', <span class="id">ctx</span>.(<span class="id">dstk</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MINJ</span>: <span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VB</span>: <span class="id">Mem.valid_block</span> <span class="id">m</span>' <span class="id">sp</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PRIV</span>: <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' (<span class="id">ctx</span>.(<span class="id">dstk</span>) + <span class="id">ctx</span>.(<span class="id">mstk</span>)) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ1</span>: 0 &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) &lt; <span class="id">Ptrofs.max_unsigned</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ2</span>: <span class="kwd">forall</span> <span class="id">ofs</span>, <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt; 0 &lt;= <span class="id">ofs</span> &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_states</span> (<span class="id">State</span> <span class="id">stk</span> <span class="id">f</span> (<span class="id">Vptr</span> <span class="id">sp</span> <span class="id">Ptrofs.zero</span>) <span class="id">pc</span> <span class="id">rs</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">State</span> <span class="id">stk</span>' <span class="id">f</span>' (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) <span class="id">rs</span>' <span class="id">m</span>')<br/>
&nbsp;&nbsp;| <span class="id">match_call_states</span>: <span class="kwd">forall</span> <span class="id">stk</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">m</span> <span class="id">stk</span>' <span class="id">fd</span>' <span class="id">args</span>' <span class="id">m</span>' <span class="id">cunit</span> <span class="id">F</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' (<span class="id">Mem.nextblock</span> <span class="id">m</span>'))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">LINK</span>: <span class="id">linkorder</span> <span class="id">cunit</span> <span class="id">prog</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">FD</span>: <span class="id">transf_fundef</span> (<span class="id">funenv_program</span> <span class="id">cunit</span>) <span class="id">fd</span> = <span class="id">OK</span> <span class="id">fd</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VINJ</span>: <span class="id">Val.inject_list</span> <span class="id">F</span> <span class="id">args</span> <span class="id">args</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MINJ</span>: <span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>'),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_states</span> (<span class="id">Callstate</span> <span class="id">stk</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Callstate</span> <span class="id">stk</span>' <span class="id">fd</span>' <span class="id">args</span>' <span class="id">m</span>')<br/>
&nbsp;&nbsp;| <span class="id">match_call_regular_states</span>: <span class="kwd">forall</span> <span class="id">stk</span> <span class="id">f</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">m</span>' <span class="id">F</span> <span class="id">fenv</span> <span class="id">ctx</span> <span class="id">ctx</span>' <span class="id">pc</span>' <span class="id">pc1</span>' <span class="id">rargs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">COMPAT</span>: <span class="id">fenv_compat</span> <span class="id">prog</span> <span class="id">fenv</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">FB</span>: <span class="id">tr_funbody</span> <span class="id">fenv</span> <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) <span class="id">ctx</span> <span class="id">f</span> <span class="id">f</span>'.(<span class="id">fn_code</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">BELOW</span>: <span class="id">context_below</span> <span class="id">ctx</span>' <span class="id">ctx</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NOP</span>: <span class="id">f</span>'.(<span class="id">fn_code</span>)!<span class="id">pc</span>' = <span class="id">Some</span>(<span class="id">Inop</span> <span class="id">pc1</span>'))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MOVES</span>: <span class="id">tr_moves</span> <span class="id">f</span>'.(<span class="id">fn_code</span>) <span class="id">pc1</span>' (<span class="id">sregs</span> <span class="id">ctx</span>' <span class="id">rargs</span>) (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">f</span>.(<span class="id">fn_params</span>)) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">f</span>.(<span class="id">fn_entrypoint</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VINJ</span>: <span class="id">list_forall2</span> (<span class="id">val_reg_charact</span> <span class="id">F</span> <span class="id">ctx</span>' <span class="id">rs</span>') <span class="id">vargs</span> <span class="id">rargs</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MINJ</span>: <span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VB</span>: <span class="id">Mem.valid_block</span> <span class="id">m</span>' <span class="id">sp</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PRIV</span>: <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ctx</span>.(<span class="id">dstk</span>) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ1</span>: 0 &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) &lt; <span class="id">Ptrofs.max_unsigned</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ2</span>: <span class="kwd">forall</span> <span class="id">ofs</span>, <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt; 0 &lt;= <span class="id">ofs</span> &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_states</span> (<span class="id">Callstate</span> <span class="id">stk</span> (<span class="id">Internal</span> <span class="id">f</span>) <span class="id">vargs</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">State</span> <span class="id">stk</span>' <span class="id">f</span>' (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) <span class="id">pc</span>' <span class="id">rs</span>' <span class="id">m</span>')<br/>
&nbsp;&nbsp;| <span class="id">match_return_states</span>: <span class="kwd">forall</span> <span class="id">stk</span> <span class="id">v</span> <span class="id">m</span> <span class="id">stk</span>' <span class="id">v</span>' <span class="id">m</span>' <span class="id">F</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' (<span class="id">Mem.nextblock</span> <span class="id">m</span>'))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VINJ</span>: <span class="id">Val.inject</span> <span class="id">F</span> <span class="id">v</span> <span class="id">v</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MINJ</span>: <span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>'),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_states</span> (<span class="id">Returnstate</span> <span class="id">stk</span> <span class="id">v</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Returnstate</span> <span class="id">stk</span>' <span class="id">v</span>' <span class="id">m</span>')<br/>
&nbsp;&nbsp;| <span class="id">match_return_regular_states</span>: <span class="kwd">forall</span> <span class="id">stk</span> <span class="id">v</span> <span class="id">m</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">sp</span>' <span class="id">rs</span>' <span class="id">m</span>' <span class="id">F</span> <span class="id">ctx</span> <span class="id">pc</span>' <span class="id">or</span> <span class="id">rinfo</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MS</span>: <span class="id">match_stacks_inside</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">stk</span> <span class="id">stk</span>' <span class="id">f</span>' <span class="id">ctx</span> <span class="id">sp</span>' <span class="id">rs</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">RET</span>: <span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">Some</span> <span class="id">rinfo</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">AT</span>: <span class="id">f</span>'.(<span class="id">fn_code</span>)!<span class="id">pc</span>' = <span class="id">Some</span>(<span class="id">inline_return</span> <span class="id">ctx</span> <span class="id">or</span> <span class="id">rinfo</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VINJ</span>: <span class="kwd">match</span> <span class="id">or</span> <span class="kwd">with</span> <span class="id">None</span> =&gt; <span class="id">v</span> = <span class="id">Vundef</span> | <span class="id">Some</span> <span class="id">r</span> =&gt; <span class="id">Val.inject</span> <span class="id">F</span> <span class="id">v</span> <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>) <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">MINJ</span>: <span class="id">Mem.inject</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">VB</span>: <span class="id">Mem.valid_block</span> <span class="id">m</span>' <span class="id">sp</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">PRIV</span>: <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ctx</span>.(<span class="id">dstk</span>) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ1</span>: 0 &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) &lt; <span class="id">Ptrofs.max_unsigned</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">SSZ2</span>: <span class="kwd">forall</span> <span class="id">ofs</span>, <span class="id">Mem.perm</span> <span class="id">m</span>' <span class="id">sp</span>' <span class="id">ofs</span> <span class="id">Max</span> <span class="id">Nonempty</span> -&gt; 0 &lt;= <span class="id">ofs</span> &lt;= <span class="id">f</span>'.(<span class="id">fn_stacksize</span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_states</span> (<span class="id">Returnstate</span> <span class="id">stk</span> <span class="id">v</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">State</span> <span class="id">stk</span>' <span class="id">f</span>' (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) <span class="id">pc</span>' <span class="id">rs</span>' <span class="id">m</span>').<br/>
<br/>
<h2> Forward simulation </h2>
<br/>
<span class="kwd">Definition</span> <span class="kwd">measure</span> (<span class="id">S</span>: <span class="id">RTL.state</span>) : <span class="id">nat</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">S</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; 1%<span class="id">nat</span><br/>
&nbsp;&nbsp;| <span class="id">Callstate</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; 0%<span class="id">nat</span><br/>
&nbsp;&nbsp;| <span class="id">Returnstate</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; 0%<span class="id">nat</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">tr_funbody_inv</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">fenv</span> <span class="id">sz</span> <span class="id">cts</span> <span class="id">f</span> <span class="id">c</span> <span class="id">pc</span> <span class="id">i</span>,<br/>
&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">fenv</span> <span class="id">sz</span> <span class="id">cts</span> <span class="id">f</span> <span class="id">c</span> -&gt; <span class="id">f</span>.(<span class="id">fn_code</span>)!<span class="id">pc</span> = <span class="id">Some</span> <span class="id">i</span> -&gt; <span class="id">tr_instr</span> <span class="id">fenv</span> <span class="id">sz</span> <span class="id">cts</span> <span class="id">pc</span> <span class="id">i</span> <span class="id">c</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2654')">Proof.</div>
<div class="proofscript" id="proof2654">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>. <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Theorem</span> <span class="id">step_simulation</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">S1</span> <span class="id">t</span> <span class="id">S2</span>,<br/>
&nbsp;&nbsp;<span class="id">step</span> <span class="id">ge</span> <span class="id">S1</span> <span class="id">t</span> <span class="id">S2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">S1</span>' (<span class="id">MS</span>: <span class="id">match_states</span> <span class="id">S1</span> <span class="id">S1</span>'),<br/>
&nbsp;&nbsp;(<span class="id">exists</span> <span class="id">S2</span>', <span class="id">plus</span> <span class="id">step</span> <span class="id">tge</span> <span class="id">S1</span>' <span class="id">t</span> <span class="id">S2</span>' /\ <span class="id">match_states</span> <span class="id">S2</span> <span class="id">S2</span>')<br/>
&nbsp;&nbsp;\/ (<span class="kwd">measure</span> <span class="id">S2</span> &lt; <span class="kwd">measure</span> <span class="id">S1</span> /\ <span class="id">t</span> = <span class="id">E0</span> /\ <span class="id">match_states</span> <span class="id">S2</span> <span class="id">S1</span>')%<span class="id">nat</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2655')">Proof.</div>
<div class="proofscript" id="proof2655">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>; <span class="id">inv</span> <span class="id">MS</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;nop&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Inop</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;op&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">eval_operation_inject</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_globals</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">SP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">instantiate</span> (2 := <span class="id">rs</span>##<span class="id">args</span>). <span class="id">instantiate</span> (1 := <span class="id">rs</span>'##(<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>)). <span class="tactic">eapply</span> <span class="id">agree_val_regs</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">MINJ</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">fold</span> (<span class="id">sop</span> <span class="id">ctx</span> <span class="id">op</span>). <span class="tactic">intros</span> [<span class="id">v</span>' [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Iop</span>; <span class="tactic">eauto</span>. <span class="id">erewrite</span> <span class="id">eval_operation_preserved</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">exact</span> <span class="id">symbols_preserved</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_inside_set_reg</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_set_reg</span>; <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;load&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">eval_addressing_inject</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_globals</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">SP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">instantiate</span> (2 := <span class="id">rs</span>##<span class="id">args</span>). <span class="id">instantiate</span> (1 := <span class="id">rs</span>'##(<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>)). <span class="tactic">eapply</span> <span class="id">agree_val_regs</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">fold</span> (<span class="id">saddr</span> <span class="id">ctx</span> <span class="id">addr</span>). <span class="tactic">intros</span> [<span class="id">a</span>' [<span class="id">P</span> <span class="id">Q</span>]].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.loadv_inject</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">v</span>' [<span class="id">U</span> <span class="id">V</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">eval_addressing</span> <span class="id">tge</span> (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) (<span class="id">saddr</span> <span class="id">ctx</span> <span class="id">addr</span>) <span class="id">rs</span>' ## (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) = <span class="id">Some</span> <span class="id">a</span>').<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">P</span>. <span class="tactic">apply</span> <span class="id">eval_addressing_preserved</span>. <span class="tactic">exact</span> <span class="id">symbols_preserved</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Iload</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_inside_set_reg</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_set_reg</span>; <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;store&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">eval_addressing_inject</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_globals</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">SP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">instantiate</span> (2 := <span class="id">rs</span>##<span class="id">args</span>). <span class="id">instantiate</span> (1 := <span class="id">rs</span>'##(<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>)). <span class="tactic">eapply</span> <span class="id">agree_val_regs</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">fold</span> <span class="id">saddr</span>. <span class="tactic">intros</span> [<span class="id">a</span>' [<span class="id">P</span> <span class="id">Q</span>]].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.storev_mapped_inject</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">agree_val_reg</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">m1</span>' [<span class="id">U</span> <span class="id">V</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">eval_addressing</span> <span class="id">tge</span> (<span class="id">Vptr</span> <span class="id">sp</span>' <span class="id">Ptrofs.zero</span>) (<span class="id">saddr</span> <span class="id">ctx</span> <span class="id">addr</span>) <span class="id">rs</span>' ## (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) = <span class="id">Some</span> <span class="id">a</span>').<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">P</span>. <span class="tactic">apply</span> <span class="id">eval_addressing_preserved</span>. <span class="tactic">exact</span> <span class="id">symbols_preserved</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Istore</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H1</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span>'; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">U</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_store</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.store_valid_block_1</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_store_2</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">Mem.perm_store_1</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">SSZ2</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_store_2</span>; <span class="tactic">eauto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;call&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">match_stacks_inside_globalenvs</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">bound</span> <span class="id">G</span>].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">find_function_agree</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> (<span class="id">cu</span> &amp; <span class="id">fd</span>' &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span>).<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
+ <span class="comment">(*&nbsp;not&nbsp;inlined&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Icall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sig_function_translated</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_cons</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_val_regs</span>; <span class="tactic">eauto</span>.<br/>
+ <span class="comment">(*&nbsp;inlined&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">EQ</span>: <span class="id">fd</span> = <span class="id">Internal</span> <span class="id">f0</span>) <span class="tactic">by</span> (<span class="tactic">eapply</span> <span class="id">find_inlined_function</span>; <span class="tactic">eauto</span>).<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">fd</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>. <span class="tactic">simpl</span>; <span class="tactic">omega</span>. <span class="tactic">split</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_inlined</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">PRIV</span>. <span class="id">inv</span> <span class="id">H13</span>. <span class="tactic">destruct</span> <span class="id">H16</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_val_regs_gen</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>; <span class="tactic">apply</span> <span class="id">PRIV</span>. <span class="tactic">destruct</span> <span class="id">H16</span>. <span class="tactic">omega</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;tailcall&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">match_stacks_inside_globalenvs</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">bound</span> <span class="id">G</span>].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">find_function_agree</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> (<span class="id">cu</span> &amp; <span class="id">fd</span>' &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span>).<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">PRIV</span>': <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span>' <span class="id">m</span>'0 <span class="id">sp</span>' (<span class="id">dstk</span> <span class="id">ctx</span>) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">eapply</span> <span class="id">range_private_free_left</span>; <span class="tactic">eauto</span>. <span class="id">inv</span> <span class="id">FB</span>. <span class="tactic">rewrite</span> &lt;- <span class="id">H4</span>. <span class="tactic">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
+ <span class="comment">(*&nbsp;within&nbsp;the&nbsp;original&nbsp;function&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MS0</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">X</span>: { <span class="id">m1</span>' | <span class="id">Mem.free</span> <span class="id">m</span>'0 <span class="id">sp</span>' 0 (<span class="id">fn_stacksize</span> <span class="id">f</span>') = <span class="id">Some</span> <span class="id">m1</span>'}).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Mem.range_perm_free</span>. <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zlt</span> <span class="id">ofs</span> <span class="id">f</span>.(<span class="id">fn_stacksize</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">replace</span> <span class="id">ofs</span> <span class="kwd">with</span> (<span class="id">ofs</span> + <span class="id">dstk</span> <span class="id">ctx</span>) <span class="tactic">by</span> <span class="tactic">omega</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_range_perm</span>; <span class="tactic">eauto</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inv</span> <span class="id">FB</span>. <span class="tactic">eapply</span> <span class="id">range_private_perms</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">X</span> <span class="kwd">as</span> [<span class="id">m1</span>' <span class="id">FREE</span>].<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Itailcall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sig_function_translated</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_bound</span> <span class="kwd">with</span> (<span class="id">bound</span> := <span class="id">sp</span>').<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_1</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">erewrite</span> <span class="id">Mem.nextblock_free</span>; <span class="tactic">eauto</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">VB</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_val_regs</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_right_inject</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">Mem.free_left_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;show&nbsp;that&nbsp;no&nbsp;valid&nbsp;location&nbsp;points&nbsp;into&nbsp;the&nbsp;stack&nbsp;block&nbsp;being&nbsp;freed&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">DSTK</span> <span class="kwd">in</span> <span class="id">PRIV</span>'. <span class="id">exploit</span> (<span class="id">PRIV</span>' (<span class="id">ofs</span> + <span class="id">delta</span>)). <span class="tactic">omega</span>. <span class="tactic">intros</span> [<span class="id">P</span> <span class="id">Q</span>].<br/>
&nbsp;&nbsp;<span class="id">eelim</span> <span class="id">Q</span>; <span class="tactic">eauto</span>. <span class="tactic">replace</span> (<span class="id">ofs</span> + <span class="id">delta</span> - <span class="id">delta</span>) <span class="kwd">with</span> <span class="id">ofs</span> <span class="tactic">by</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Mem.perm_max</span> <span class="kwd">with</span> <span class="id">k</span>. <span class="tactic">apply</span> <span class="id">Mem.perm_implies</span> <span class="kwd">with</span> <span class="id">p</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">mem</span>.<br/>
+ <span class="comment">(*&nbsp;turned&nbsp;into&nbsp;a&nbsp;call&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Icall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sig_function_translated</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_untailcall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">agree_val_regs</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_left_inject</span>; <span class="tactic">eauto</span>.<br/>
+ <span class="comment">(*&nbsp;inlined&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">EQ</span>: <span class="id">fd</span> = <span class="id">Internal</span> <span class="id">f0</span>) <span class="tactic">by</span> (<span class="tactic">eapply</span> <span class="id">find_inlined_function</span>; <span class="tactic">eauto</span>).<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">fd</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">split</span>. <span class="tactic">simpl</span>; <span class="tactic">omega</span>. <span class="tactic">split</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_inlined_tailcall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_val_regs_gen</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_left_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>; <span class="tactic">apply</span> <span class="id">PRIV</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">dstk</span> <span class="id">ctx</span> &lt;= <span class="id">dstk</span> <span class="id">ctx</span>'). <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H14</span>; <span class="tactic">rewrite</span> <span class="id">H14</span>. <span class="tactic">apply</span> <span class="id">align_le</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;builtin&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">match_stacks_inside_globalenvs</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">bound</span> <span class="id">MG</span>].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_builtin_args</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> (<span class="id">vargs</span>' &amp; <span class="id">P</span> &amp; <span class="id">Q</span>).<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">external_call_mem_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_globals</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">F1</span> [<span class="id">v1</span> [<span class="id">m1</span>' [<span class="id">A</span> [<span class="id">B</span> [<span class="id">C</span> [<span class="id">D</span> [<span class="id">E</span> [<span class="id">J</span> <span class="id">K</span>]]]]]]]]].<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Ibuiltin</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">external_call_symbols_preserved</span>; <span class="tactic">eauto</span>. <span class="tactic">apply</span> <span class="id">senv_preserved</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_set_res</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_extcall</span> <span class="kwd">with</span> (<span class="id">F1</span> := <span class="id">F</span>) (<span class="id">F2</span> := <span class="id">F1</span>) (<span class="id">m1</span> := <span class="id">m</span>) (<span class="id">m1</span>' := <span class="id">m</span>'0); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">external_call_max_perm</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">external_call_max_perm</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">eauto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">res</span>; <span class="tactic">simpl</span>; [<span class="tactic">apply</span> <span class="id">agree_set_reg</span>;<span class="tactic">auto</span>|<span class="id">idtac</span>|<span class="id">idtac</span>]; <span class="tactic">eapply</span> <span class="id">agree_regs_incr</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">external_call_valid_block</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_extcall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">external_call_max_perm</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">SSZ2</span>. <span class="tactic">eapply</span> <span class="id">external_call_max_perm</span>; <span class="tactic">eauto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;cond&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">eval_condition</span> <span class="id">cond</span> <span class="id">rs</span>'##(<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) <span class="id">m</span>' = <span class="id">Some</span> <span class="id">b</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">eval_condition_inject</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">agree_val_regs</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Icond</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">b</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;jumptable&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Val.inject</span> <span class="id">F</span> <span class="id">rs</span>#<span class="id">arg</span> <span class="id">rs</span>'#(<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">arg</span>)). <span class="tactic">eapply</span> <span class="id">agree_val_reg</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">H2</span>; <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Ijumptable</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">list_nth_z_map</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">simpl</span>; <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;return&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_funbody_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">TR</span>; <span class="id">inv</span> <span class="id">TR</span>.<br/>
+ <span class="comment">(*&nbsp;not&nbsp;inlined&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MS0</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">X</span>: { <span class="id">m1</span>' | <span class="id">Mem.free</span> <span class="id">m</span>'0 <span class="id">sp</span>' 0 (<span class="id">fn_stacksize</span> <span class="id">f</span>') = <span class="id">Some</span> <span class="id">m1</span>'}).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Mem.range_perm_free</span>. <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zlt</span> <span class="id">ofs</span> <span class="id">f</span>.(<span class="id">fn_stacksize</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">replace</span> <span class="id">ofs</span> <span class="kwd">with</span> (<span class="id">ofs</span> + <span class="id">dstk</span> <span class="id">ctx</span>) <span class="tactic">by</span> <span class="tactic">omega</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_range_perm</span>; <span class="tactic">eauto</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inv</span> <span class="id">FB</span>. <span class="tactic">eapply</span> <span class="id">range_private_perms</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id">Zmax_spec</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) 0). <span class="tactic">destruct</span> (<span class="id">zlt</span> 0 (<span class="id">fn_stacksize</span> <span class="id">f</span>)); <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">X</span> <span class="kwd">as</span> [<span class="id">m1</span>' <span class="id">FREE</span>].<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Ireturn</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_bound</span> <span class="kwd">with</span> (<span class="id">bound</span> := <span class="id">sp</span>').<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_1</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">erewrite</span> <span class="id">Mem.nextblock_free</span>; <span class="tactic">eauto</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">VB</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">or</span>; <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">agree_val_reg</span>; <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_right_inject</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">Mem.free_left_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;show&nbsp;that&nbsp;no&nbsp;valid&nbsp;location&nbsp;points&nbsp;into&nbsp;the&nbsp;stack&nbsp;block&nbsp;being&nbsp;freed&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">FB</span>; <span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">PRIV</span>': <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span>' <span class="id">m</span>'0 <span class="id">sp</span>' (<span class="id">dstk</span> <span class="id">ctx</span>) <span class="id">f</span>'.(<span class="id">fn_stacksize</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H8</span> <span class="kwd">in</span> <span class="id">PRIV</span>. <span class="tactic">eapply</span> <span class="id">range_private_free_left</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">DSTK</span> <span class="kwd">in</span> <span class="id">PRIV</span>'. <span class="id">exploit</span> (<span class="id">PRIV</span>' (<span class="id">ofs</span> + <span class="id">delta</span>)). <span class="tactic">omega</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="id">eelim</span> <span class="id">B</span>; <span class="tactic">eauto</span>. <span class="tactic">replace</span> (<span class="id">ofs</span> + <span class="id">delta</span> - <span class="id">delta</span>) <span class="kwd">with</span> <span class="id">ofs</span> <span class="tactic">by</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Mem.perm_max</span> <span class="kwd">with</span> <span class="id">k</span>. <span class="tactic">apply</span> <span class="id">Mem.perm_implies</span> <span class="kwd">with</span> <span class="id">p</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">mem</span>.<br/>
<br/>
+ <span class="comment">(*&nbsp;inlined&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="tactic">split</span>. <span class="tactic">simpl</span>. <span class="tactic">omega</span>. <span class="tactic">split</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_free_3</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">or</span>; <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">agree_val_reg</span>; <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.free_left_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">FB</span>. <span class="tactic">rewrite</span> <span class="id">H4</span> <span class="kwd">in</span> <span class="id">PRIV</span>. <span class="tactic">eapply</span> <span class="id">range_private_free_left</span>; <span class="tactic">eauto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;internal&nbsp;function,&nbsp;not&nbsp;inlined&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">A</span>: <span class="id">exists</span> <span class="id">f</span>', <span class="id">tr_function</span> <span class="id">cunit</span> <span class="id">f</span> <span class="id">f</span>' /\ <span class="id">fd</span>' = <span class="id">Internal</span> <span class="id">f</span>').<br/>
&nbsp;&nbsp;{ <span class="id">Errors.monadInv</span> <span class="id">FD</span>. <span class="id">exists</span> <span class="id">x</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id">transf_function_spec</span>; <span class="tactic">eauto</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">A</span> <span class="kwd">as</span> [<span class="id">f</span>' [<span class="id">TR1</span> <span class="id">EQ</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">TR</span>: <span class="id">tr_function</span> <span class="id">prog</span> <span class="id">f</span> <span class="id">f</span>').<br/>
&nbsp;&nbsp;{ <span class="tactic">eapply</span> <span class="id">tr_function_linkorder</span>; <span class="tactic">eauto</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">TR</span>; <span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.alloc_parallel_inject</span>. <span class="tactic">eauto</span>. <span class="tactic">eauto</span>. <span class="tactic">apply</span> <span class="id">Zle_refl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">fn_stacksize</span> <span class="id">f</span>'). <span class="id">inv</span> <span class="id">H1</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">F</span>' [<span class="id">m1</span>' [<span class="id">sp</span>' [<span class="id">A</span> [<span class="id">B</span> [<span class="id">C</span> [<span class="id">D</span> <span class="id">E</span>]]]]]]].<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_function_internal</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H6</span>. <span class="id">econstructor</span>.<br/>
&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">F</span>'). <span class="tactic">apply</span> <span class="id">match_stacks_inside_base</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">SP</span>: <span class="id">sp</span>' = <span class="id">Mem.nextblock</span> <span class="id">m</span>'0) <span class="tactic">by</span> (<span class="tactic">eapply</span> <span class="id">Mem.alloc_result</span>; <span class="tactic">eauto</span>).<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">SP</span> <span class="kwd">in</span> <span class="id">MS0</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b1</span> <span class="id">stk</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">b1</span>. <span class="tactic">rewrite</span> <span class="id">D</span> <span class="kwd">in</span> <span class="id">H8</span>; <span class="id">inv</span> <span class="id">H8</span>. <span class="id">eelim</span> <span class="id">Plt_strict</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">E</span> <span class="kwd">in</span> <span class="id">H8</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">Mem.perm_alloc_inv</span>. <span class="id">eexact</span> <span class="id">H</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b1</span> <span class="id">stk</span>); <span class="tactic">intros</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">b1</span>. <span class="tactic">rewrite</span> <span class="id">D</span> <span class="kwd">in</span> <span class="id">H8</span>; <span class="id">inv</span> <span class="id">H8</span>. <span class="id">eelim</span> <span class="id">Plt_strict</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Mem.perm_alloc_1</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">Mem.perm_alloc_inv</span>. <span class="id">eexact</span> <span class="id">A</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">dec_eq_false</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>. <span class="tactic">auto</span>. <span class="tactic">eauto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H5</span>. <span class="tactic">apply</span> <span class="id">agree_regs_init_regs</span>. <span class="tactic">eauto</span>. <span class="tactic">auto</span>. <span class="id">inv</span> <span class="id">H1</span>; <span class="tactic">auto</span>. <span class="tactic">congruence</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.valid_new_block</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Mem.perm_alloc_2</span>; <span class="tactic">eauto</span>. <span class="id">inv</span> <span class="id">H1</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">Mem.perm_alloc_inv</span>. <span class="id">eexact</span> <span class="id">H</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b</span> <span class="id">stk</span>); <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span>. <span class="tactic">rewrite</span> <span class="id">D</span> <span class="kwd">in</span> <span class="id">H9</span>; <span class="id">inv</span> <span class="id">H9</span>. <span class="id">inv</span> <span class="id">H1</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">E</span> <span class="kwd">in</span> <span class="id">H9</span>; <span class="tactic">auto</span>. <span class="id">eelim</span> <span class="id">Mem.fresh_block_alloc</span>. <span class="id">eexact</span> <span class="id">A</span>. <span class="tactic">eapply</span> <span class="id">Mem.mi_mappedblocks</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">Mem.perm_alloc_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="tactic">omega</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;internal&nbsp;function,&nbsp;inlined&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">FB</span>; <span class="tactic">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">Mem.alloc_left_mapped_inject</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eauto</span>.<br/>
&nbsp;sp'&nbsp;is&nbsp;valid&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">sp</span>'). <span class="tactic">auto</span>.<br/>
&nbsp;offset&nbsp;is&nbsp;representable&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">dstk</span> <span class="id">ctx</span>). <span class="tactic">generalize</span> (<span class="id">Zmax2</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) 0). <span class="tactic">omega</span>.<br/>
&nbsp;size&nbsp;of&nbsp;target&nbsp;block&nbsp;is&nbsp;representable&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">right</span>. <span class="id">exploit</span> <span class="id">SSZ2</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">mem</span>. <span class="id">inv</span> <span class="id">FB</span>; <span class="tactic">omega</span>.<br/>
&nbsp;we&nbsp;have&nbsp;full&nbsp;permissions&nbsp;on&nbsp;sp'&nbsp;at&nbsp;and&nbsp;above&nbsp;dstk&nbsp;ctx&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">Mem.perm_cur</span>. <span class="tactic">apply</span> <span class="id">Mem.perm_implies</span> <span class="kwd">with</span> <span class="id">Freeable</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">mem</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">range_private_perms</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;offset&nbsp;is&nbsp;aligned&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="id">fn_stacksize</span> <span class="id">f</span> - 0) <span class="kwd">with</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) <span class="tactic">by</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inv</span> <span class="id">FB</span>. <span class="tactic">apply</span> <span class="id">min_alignment_sound</span>; <span class="tactic">auto</span>.<br/>
&nbsp;nobody&nbsp;maps&nbsp;to&nbsp;(sp,&nbsp;dstk&nbsp;ctx...)&nbsp;*)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> (<span class="id">PRIV</span> (<span class="id">ofs</span> + <span class="id">delta</span>')); <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="id">eelim</span> <span class="id">B</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="id">ofs</span> + <span class="id">delta</span>' - <span class="id">delta</span>') <span class="kwd">with</span> <span class="id">ofs</span> <span class="tactic">by</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Mem.perm_max</span> <span class="kwd">with</span> <span class="id">k</span>. <span class="tactic">apply</span> <span class="id">Mem.perm_implies</span> <span class="kwd">with</span> <span class="id">p</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">mem</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">F</span>' [<span class="id">A</span> [<span class="id">B</span> [<span class="id">C</span> <span class="id">D</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">tr_moves_init_regs</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">rs</span>'' [<span class="id">P</span> [<span class="id">Q</span> <span class="id">R</span>]]].<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_left</span>. <span class="tactic">eapply</span> <span class="id">exec_Inop</span>; <span class="tactic">eauto</span>. <span class="id">eexact</span> <span class="id">P</span>. <span class="id">traceEq</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_alloc_left</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_invariant</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_regs_incr</span> <span class="kwd">with</span> <span class="id">F</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H2</span>. <span class="tactic">eapply</span> <span class="id">range_private_alloc_left</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;external&nbsp;function&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">match_stacks_globalenvs</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">bound</span> <span class="id">MG</span>].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">external_call_mem_inject</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_globalenvs_preserves_globals</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">F1</span> [<span class="id">v1</span> [<span class="id">m1</span>' [<span class="id">A</span> [<span class="id">B</span> [<span class="id">C</span> [<span class="id">D</span> [<span class="id">E</span> [<span class="id">J</span> <span class="id">K</span>]]]]]]]]].<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">FD</span>. <span class="id">inv</span> <span class="id">FD</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_function_external</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">external_call_symbols_preserved</span>; <span class="tactic">eauto</span>. <span class="tactic">apply</span> <span class="id">senv_preserved</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_bound</span> <span class="kwd">with</span> (<span class="id">Mem.nextblock</span> <span class="id">m</span>'0).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_extcall</span> <span class="kwd">with</span> (<span class="id">F1</span> := <span class="id">F</span>) (<span class="id">F2</span> := <span class="id">F1</span>) (<span class="id">m1</span> := <span class="id">m</span>) (<span class="id">m1</span>' := <span class="id">m</span>'0); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">external_call_max_perm</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">external_call_max_perm</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">external_call_nextblock</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;return&nbsp;fron&nbsp;noninlined&nbsp;function&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MS0</span>.<br/>
+ <span class="comment">(*&nbsp;normal&nbsp;case&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_return</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_inside_set_reg</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_set_reg</span>; <span class="tactic">auto</span>.<br/>
+ <span class="comment">(*&nbsp;untailcall&nbsp;case&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MS</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">RET</span> <span class="kwd">in</span> <span class="id">RET0</span>; <span class="id">inv</span> <span class="id">RET0</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_return</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_regular_states</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">match_stacks_inside_set_reg</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eauto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">agree_set_reg</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">zlt</span> <span class="id">ofs</span> (<span class="id">dstk</span> <span class="id">ctx</span>)). <span class="tactic">apply</span> <span class="id">PAD</span>; <span class="tactic">omega</span>. <span class="tactic">apply</span> <span class="id">PRIV</span>; <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
<br/>
- <span class="comment">(*&nbsp;return&nbsp;from&nbsp;inlined&nbsp;function&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">MS0</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="tactic">rewrite</span> <span class="id">RET0</span> <span class="kwd">in</span> <span class="id">RET</span>; <span class="id">inv</span> <span class="id">RET</span>.<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">inline_return</span> <span class="kwd">in</span> <span class="id">AT</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">PRIV</span>': <span class="id">range_private</span> <span class="id">F</span> <span class="id">m</span> <span class="id">m</span>' <span class="id">sp</span>' (<span class="id">dstk</span> <span class="id">ctx</span>' + <span class="id">mstk</span> <span class="id">ctx</span>') <span class="id">f</span>'.(<span class="id">fn_stacksize</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">zlt</span> <span class="id">ofs</span> (<span class="id">dstk</span> <span class="id">ctx</span>)). <span class="tactic">apply</span> <span class="id">PAD</span>. <span class="tactic">omega</span>. <span class="tactic">apply</span> <span class="id">PRIV</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">or</span>.<br/>
+ <span class="comment">(*&nbsp;with&nbsp;a&nbsp;result&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Iop</span>; <span class="tactic">eauto</span>. <span class="tactic">simpl</span>. <span class="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>. <span class="tactic">apply</span> <span class="id">match_stacks_inside_set_reg</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">agree_set_reg</span>; <span class="tactic">auto</span>.<br/>
+ <span class="comment">(*&nbsp;without&nbsp;a&nbsp;result&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">left</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">plus_one</span>. <span class="tactic">eapply</span> <span class="id">exec_Inop</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>. <span class="tactic">subst</span> <span class="id">vres</span>. <span class="tactic">apply</span> <span class="id">agree_set_reg_undef</span>'; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">transf_initial_states</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">st1</span>, <span class="id">initial_state</span> <span class="id">prog</span> <span class="id">st1</span> -&gt; <span class="id">exists</span> <span class="id">st2</span>, <span class="id">initial_state</span> <span class="id">tprog</span> <span class="id">st2</span> /\ <span class="id">match_states</span> <span class="id">st1</span> <span class="id">st2</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2656')">Proof.</div>
<div class="proofscript" id="proof2656">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">function_ptr_translated</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> (<span class="id">cu</span> &amp; <span class="id">tf</span> &amp; <span class="id">FIND</span> &amp; <span class="id">TR</span> &amp; <span class="id">LINK</span>).<br/>
&nbsp;&nbsp;<span class="id">exists</span> (<span class="id">Callstate</span> <span class="id">nil</span> <span class="id">tf</span> <span class="id">nil</span> <span class="id">m0</span>); <span class="tactic">split</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> (<span class="id">Genv.init_mem_match</span> <span class="id">TRANSF</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">symbols_preserved</span>. <span class="tactic">replace</span> (<span class="id">prog_main</span> <span class="id">tprog</span>) <span class="kwd">with</span> (<span class="id">prog_main</span> <span class="id">prog</span>). <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">symmetry</span>; <span class="tactic">eapply</span> <span class="id">match_program_main</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> &lt;- <span class="id">H3</span>. <span class="tactic">eapply</span> <span class="id">sig_function_translated</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">Mem.flat_inj</span> (<span class="id">Mem.nextblock</span> <span class="id">m0</span>)).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">match_stacks_nil</span> <span class="kwd">with</span> (<span class="id">Mem.nextblock</span> <span class="id">m0</span>).<br/>
&nbsp;&nbsp;<span class="id">constructor</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">Mem.flat_inj</span>. <span class="tactic">apply</span> <span class="id">pred_dec_true</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">Mem.flat_inj</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">destruct</span> (<span class="id">plt</span> <span class="id">b1</span> (<span class="id">Mem.nextblock</span> <span class="id">m0</span>)); <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Genv.find_symbol_not_fresh</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Genv.find_funct_ptr_not_fresh</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Genv.find_var_info_not_fresh</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Ple_refl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Genv.initmem_inject</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">transf_final_states</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">st1</span> <span class="id">st2</span> <span class="id">r</span>,<br/>
&nbsp;&nbsp;<span class="id">match_states</span> <span class="id">st1</span> <span class="id">st2</span> -&gt; <span class="id">final_state</span> <span class="id">st1</span> <span class="id">r</span> -&gt; <span class="id">final_state</span> <span class="id">st2</span> <span class="id">r</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2657')">Proof.</div>
<div class="proofscript" id="proof2657">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">match_stacks_empty</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">EQ</span>; <span class="tactic">subst</span>. <span class="id">inv</span> <span class="id">VINJ</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">match_stacks_inside_empty</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Theorem</span> <span class="id">transf_program_correct</span>:<br/>
&nbsp;&nbsp;<span class="id">forward_simulation</span> (<span class="id">semantics</span> <span class="id">prog</span>) (<span class="id">semantics</span> <span class="id">tprog</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2658')">Proof.</div>
<div class="proofscript" id="proof2658">
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">forward_simulation_star</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">senv_preserved</span>.<br/>
&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">transf_initial_states</span>.<br/>
&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">transf_final_states</span>.<br/>
&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">step_simulation</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">INLINING</span>.<br/>
</div>
<div class="footer"><hr/>Generated by coq2html</div>
</body>
</html>
