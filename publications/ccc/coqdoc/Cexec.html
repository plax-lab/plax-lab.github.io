<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Cexec</title>
<meta name="description" content="Documentation of Coq module Cexec" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Cexec</h1>
<div class="coq">
<br/>
<div class="doc">Animating the CompCert C semantics </div>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Axioms</span> <span class="id">Classical</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">String</span> <span class="id">Coqlib</span> <span class="id">Decidableplus</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Errors</span> <span class="id">Maps</span> <span class="id">Integers</span> <span class="id">Floats</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">AST</span> <span class="id">Values</span> <span class="id">Memory</span> <span class="id">Events</span> <span class="id">Globalenvs</span> <span class="id">Determinism</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Ctypes</span> <span class="id">Cop</span> <span class="id">Csyntax</span> <span class="id">Csem</span>.<br/>
<span class="kwd">Require</span> <span class="id">Cstrategy</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string_scope</span>.<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">list_scope</span>.<br/>
<br/>
<div class="doc">Error monad with options or lists </div>
<br/>
<span class="kwd">Notation</span> "'<span class="tactic">do</span>' <span class="id">X</span> &lt;- <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">match</span> <span class="id">A</span> <span class="kwd">with</span> <span class="id">Some</span> <span class="id">X</span> =&gt; <span class="id">B</span> | <span class="id">None</span> =&gt; <span class="id">None</span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">X</span> <span class="id">ident</span>, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">option_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> "'<span class="tactic">do</span>' <span class="id">X</span> , <span class="id">Y</span> &lt;- <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">match</span> <span class="id">A</span> <span class="kwd">with</span> <span class="id">Some</span> (<span class="id">X</span>, <span class="id">Y</span>) =&gt; <span class="id">B</span> | <span class="id">None</span> =&gt; <span class="id">None</span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">X</span> <span class="id">ident</span>, <span class="id">Y</span> <span class="id">ident</span>, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">option_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> "'<span class="tactic">do</span>' <span class="id">X</span> , <span class="id">Y</span> , <span class="id">Z</span> &lt;- <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">match</span> <span class="id">A</span> <span class="kwd">with</span> <span class="id">Some</span> (<span class="id">X</span>, <span class="id">Y</span>, <span class="id">Z</span>) =&gt; <span class="id">B</span> | <span class="id">None</span> =&gt; <span class="id">None</span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">X</span> <span class="id">ident</span>, <span class="id">Y</span> <span class="id">ident</span>, <span class="id">Z</span> <span class="id">ident</span>, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">option_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> " '<span class="id">check</span>' <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">if</span> <span class="id">A</span> <span class="kwd">then</span> <span class="id">B</span> <span class="kwd">else</span> <span class="id">None</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">option_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> "'<span class="tactic">do</span>' <span class="id">X</span> &lt;- <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">match</span> <span class="id">A</span> <span class="kwd">with</span> <span class="id">Some</span> <span class="id">X</span> =&gt; <span class="id">B</span> | <span class="id">None</span> =&gt; <span class="id">nil</span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">X</span> <span class="id">ident</span>, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">list_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> " '<span class="id">check</span>' <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">if</span> <span class="id">A</span> <span class="kwd">then</span> <span class="id">B</span> <span class="kwd">else</span> <span class="id">nil</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">list_monad_scope</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">is_val</span> (<span class="id">a</span>: <span class="id">expr</span>) : <span class="id">option</span> (<span class="id">val</span> * <span class="id">type</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span> =&gt; <span class="id">Some</span>(<span class="id">v</span>, <span class="id">ty</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">is_val_inv</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">v</span> <span class="id">ty</span>, <span class="id">is_val</span> <span class="id">a</span> = <span class="id">Some</span>(<span class="id">v</span>, <span class="id">ty</span>) -&gt; <span class="id">a</span> = <span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4189')">Proof.</div>
<div class="proofscript" id="proof4189">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">ty</span>. <span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">simpl</span>; <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Definition</span> <span class="id">is_loc</span> (<span class="id">a</span>: <span class="id">expr</span>) : <span class="id">option</span> (<span class="id">block</span> * <span class="id">ptrofs</span> * <span class="id">type</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span> =&gt; <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">is_loc_inv</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span>, <span class="id">is_loc</span> <span class="id">a</span> = <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty</span>) -&gt; <span class="id">a</span> = <span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4190')">Proof.</div>
<div class="proofscript" id="proof4190">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">ty</span>. <span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">simpl</span>; <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">option_monad_scope</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">is_val_list</span> (<span class="id">al</span>: <span class="id">exprlist</span>) : <span class="id">option</span> (<span class="id">list</span> (<span class="id">val</span> * <span class="id">type</span>)) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">al</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Enil</span> =&gt; <span class="id">Some</span> <span class="id">nil</span><br/>
&nbsp;&nbsp;| <span class="id">Econs</span> <span class="id">a1</span> <span class="id">al</span> =&gt; <span class="tactic">do</span> <span class="id">vt1</span> &lt;- <span class="id">is_val</span> <span class="id">a1</span>; <span class="tactic">do</span> <span class="id">vtl</span> &lt;- <span class="id">is_val_list</span> <span class="id">al</span>; <span class="id">Some</span>(<span class="id">vt1</span>::<span class="id">vtl</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">is_skip</span> (<span class="id">s</span>: <span class="id">statement</span>) : {<span class="id">s</span> = <span class="id">Sskip</span>} + {<span class="id">s</span> &lt;&gt; <span class="id">Sskip</span>}.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4191')">Proof.</div>
<div class="proofscript" id="proof4191">
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">s</span>; (<span class="id">left</span>; <span class="tactic">congruence</span>) || (<span class="id">right</span>; <span class="tactic">congruence</span>).<br/>
Defined.</div>
<br/>
<h1> Events, volatile memory accesses, and external functions. </h1>
<br/>
<span class="kwd">Section</span> <span class="id">EXEC</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">ge</span>: <span class="id">genv</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">eventval_of_val</span> (<span class="id">v</span>: <span class="id">val</span>) (<span class="id">t</span>: <span class="id">typ</span>) : <span class="id">option</span> <span class="id">eventval</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">v</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Vint</span> <span class="id">i</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tint</span>); <span class="id">Some</span> (<span class="id">EVint</span> <span class="id">i</span>)<br/>
&nbsp;&nbsp;| <span class="id">Vfloat</span> <span class="id">f</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tfloat</span>); <span class="id">Some</span> (<span class="id">EVfloat</span> <span class="id">f</span>)<br/>
&nbsp;&nbsp;| <span class="id">Vsingle</span> <span class="id">f</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tsingle</span>); <span class="id">Some</span> (<span class="id">EVsingle</span> <span class="id">f</span>)<br/>
&nbsp;&nbsp;| <span class="id">Vlong</span> <span class="id">n</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tlong</span>); <span class="id">Some</span> (<span class="id">EVlong</span> <span class="id">n</span>)<br/>
&nbsp;&nbsp;| <span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">id</span> &lt;- <span class="id">Genv.invert_symbol</span> <span class="id">ge</span> <span class="id">b</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> (<span class="id">Genv.public_symbol</span> <span class="id">ge</span> <span class="id">id</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tptr</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">EVptr_global</span> <span class="id">id</span> <span class="id">ofs</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">list_eventval_of_val</span> (<span class="id">vl</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">tl</span>: <span class="id">list</span> <span class="id">typ</span>) : <span class="id">option</span> (<span class="id">list</span> <span class="id">eventval</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vl</span>, <span class="id">tl</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">nil</span>, <span class="id">nil</span> =&gt; <span class="id">Some</span> <span class="id">nil</span><br/>
&nbsp;&nbsp;| <span class="id">v1</span>::<span class="id">vl</span>, <span class="id">t1</span>::<span class="id">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">ev1</span> &lt;- <span class="id">eventval_of_val</span> <span class="id">v1</span> <span class="id">t1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">evl</span> &lt;- <span class="id">list_eventval_of_val</span> <span class="id">vl</span> <span class="id">tl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">ev1</span> :: <span class="id">evl</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">val_of_eventval</span> (<span class="id">ev</span>: <span class="id">eventval</span>) (<span class="id">t</span>: <span class="id">typ</span>) : <span class="id">option</span> <span class="id">val</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">ev</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">EVint</span> <span class="id">i</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tint</span>); <span class="id">Some</span> (<span class="id">Vint</span> <span class="id">i</span>)<br/>
&nbsp;&nbsp;| <span class="id">EVfloat</span> <span class="id">f</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tfloat</span>); <span class="id">Some</span> (<span class="id">Vfloat</span> <span class="id">f</span>)<br/>
&nbsp;&nbsp;| <span class="id">EVsingle</span> <span class="id">f</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tsingle</span>); <span class="id">Some</span> (<span class="id">Vsingle</span> <span class="id">f</span>)<br/>
&nbsp;&nbsp;| <span class="id">EVlong</span> <span class="id">n</span> =&gt; <span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tlong</span>); <span class="id">Some</span> (<span class="id">Vlong</span> <span class="id">n</span>)<br/>
&nbsp;&nbsp;| <span class="id">EVptr_global</span> <span class="id">id</span> <span class="id">ofs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> (<span class="id">Genv.public_symbol</span> <span class="id">ge</span> <span class="id">id</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> (<span class="id">typ_eq</span> <span class="id">t</span> <span class="id">AST.Tptr</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">id</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">mydestr</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| [ |- <span class="id">None</span> = <span class="id">Some</span> <span class="id">_</span> -&gt; <span class="id">_</span> ] =&gt; <span class="kwd">let</span> <span class="id">X</span> := <span class="tactic">fresh</span> "<span class="id">X</span>" <span class="kwd">in</span> <span class="tactic">intro</span> <span class="id">X</span>; <span class="tactic">discriminate</span><br/>
&nbsp;&nbsp;| [ |- <span class="id">Some</span> <span class="id">_</span> = <span class="id">Some</span> <span class="id">_</span> -&gt; <span class="id">_</span> ] =&gt; <span class="kwd">let</span> <span class="id">X</span> := <span class="tactic">fresh</span> "<span class="id">X</span>" <span class="kwd">in</span> <span class="tactic">intro</span> <span class="id">X</span>; <span class="id">inv</span> <span class="id">X</span><br/>
&nbsp;&nbsp;| [ |- <span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">Some</span> <span class="id">_</span> =&gt; <span class="id">_</span> | <span class="id">None</span> =&gt; <span class="id">_</span> <span class="kwd">end</span> = <span class="id">Some</span> <span class="id">_</span> -&gt; <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">x</span> <span class="id">eqn</span>:?; <span class="id">mydestr</span><br/>
&nbsp;&nbsp;| [ |- <span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">true</span> =&gt; <span class="id">_</span> | <span class="id">false</span> =&gt; <span class="id">_</span> <span class="kwd">end</span> = <span class="id">Some</span> <span class="id">_</span> -&gt; <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">x</span> <span class="id">eqn</span>:?; <span class="id">mydestr</span><br/>
&nbsp;&nbsp;| [ |- <span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">left</span> <span class="id">_</span> =&gt; <span class="id">_</span> | <span class="id">right</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span> = <span class="id">Some</span> <span class="id">_</span> -&gt; <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">x</span>; <span class="id">mydestr</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">idtac</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">eventval_of_val_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span> <span class="id">t</span> <span class="id">ev</span>, <span class="id">eventval_of_val</span> <span class="id">v</span> <span class="id">t</span> = <span class="id">Some</span> <span class="id">ev</span> -&gt; <span class="id">eventval_match</span> <span class="id">ge</span> <span class="id">ev</span> <span class="id">t</span> <span class="id">v</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4192')">Proof.</div>
<div class="proofscript" id="proof4192">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">ev</span>. <span class="tactic">destruct</span> <span class="id">v</span>; <span class="tactic">simpl</span>; <span class="id">mydestr</span>; <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">Genv.invert_find_symbol</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">eventval_of_val_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ev</span> <span class="id">t</span> <span class="id">v</span>, <span class="id">eventval_match</span> <span class="id">ge</span> <span class="id">ev</span> <span class="id">t</span> <span class="id">v</span> -&gt; <span class="id">eventval_of_val</span> <span class="id">v</span> <span class="id">t</span> = <span class="id">Some</span> <span class="id">ev</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4193')">Proof.</div>
<div class="proofscript" id="proof4193">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">rewrite</span> (<span class="id">Genv.find_invert_symbol</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H0</span>). <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">rewrite</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="tactic">auto</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_eventval_of_val_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">vl</span> <span class="id">tl</span> <span class="id">evl</span>, <span class="id">list_eventval_of_val</span> <span class="id">vl</span> <span class="id">tl</span> = <span class="id">Some</span> <span class="id">evl</span> -&gt; <span class="id">eventval_list_match</span> <span class="id">ge</span> <span class="id">evl</span> <span class="id">tl</span> <span class="id">vl</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4194')">Proof with</div>
<div class="proofscript" id="proof4194">
 <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">vl</span>; <span class="tactic">destruct</span> <span class="id">tl</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">eventval_of_val</span> <span class="id">a</span> <span class="id">t</span>) <span class="kwd">as</span> [<span class="id">ev1</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">list_eventval_of_val</span> <span class="id">vl</span> <span class="id">tl</span>) <span class="kwd">as</span> [<span class="id">evl</span>'|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H1</span>. <span class="id">constructor</span>. <span class="tactic">apply</span> <span class="id">eventval_of_val_sound</span>; <span class="tactic">auto</span>. <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">list_eventval_of_val_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">evl</span> <span class="id">tl</span> <span class="id">vl</span>, <span class="id">eventval_list_match</span> <span class="id">ge</span> <span class="id">evl</span> <span class="id">tl</span> <span class="id">vl</span> -&gt; <span class="id">list_eventval_of_val</span> <span class="id">vl</span> <span class="id">tl</span> = <span class="id">Some</span> <span class="id">evl</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4195')">Proof.</div>
<div class="proofscript" id="proof4195">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">eventval_of_val_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span>). <span class="tactic">rewrite</span> <span class="id">IHeventval_list_match</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">val_of_eventval_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ev</span> <span class="id">t</span> <span class="id">v</span>, <span class="id">val_of_eventval</span> <span class="id">ev</span> <span class="id">t</span> = <span class="id">Some</span> <span class="id">v</span> -&gt; <span class="id">eventval_match</span> <span class="id">ge</span> <span class="id">ev</span> <span class="id">t</span> <span class="id">v</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4196')">Proof.</div>
<div class="proofscript" id="proof4196">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">v</span>. <span class="tactic">destruct</span> <span class="id">ev</span>; <span class="tactic">simpl</span>; <span class="id">mydestr</span>; <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">val_of_eventval_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ev</span> <span class="id">t</span> <span class="id">v</span>, <span class="id">eventval_match</span> <span class="id">ge</span> <span class="id">ev</span> <span class="id">t</span> <span class="id">v</span> -&gt; <span class="id">val_of_eventval</span> <span class="id">ev</span> <span class="id">t</span> = <span class="id">Some</span> <span class="id">v</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4197')">Proof.</div>
<div class="proofscript" id="proof4197">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">auto</span>.<br/>
- <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="tactic">rewrite</span> <span class="id">H</span>, <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="tactic">auto</span>.  <br/>
Qed.</div>
<br/>
<div class="doc">Volatile memory accesses. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">do_volatile_load</span> (<span class="id">w</span>: <span class="id">world</span>) (<span class="id">chunk</span>: <span class="id">memory_chunk</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">b</span>: <span class="id">block</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">Genv.block_is_volatile</span> <span class="id">ge</span> <span class="id">b</span> <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">id</span> &lt;- <span class="id">Genv.invert_symbol</span> <span class="id">ge</span> <span class="id">b</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">nextworld_vload</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">id</span> <span class="id">ofs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">res</span>, <span class="id">w</span>') =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">vres</span> &lt;- <span class="id">val_of_eventval</span> <span class="id">res</span> (<span class="id">type_of_chunk</span> <span class="id">chunk</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>', <span class="id">Event_vload</span> <span class="id">chunk</span> <span class="id">id</span> <span class="id">ofs</span> <span class="id">res</span> :: <span class="id">nil</span>, <span class="id">Val.load_result</span> <span class="id">chunk</span> <span class="id">vres</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;<span class="kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">Mem.load</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">v</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_volatile_store</span> (<span class="id">w</span>: <span class="id">world</span>) (<span class="id">chunk</span>: <span class="id">memory_chunk</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">b</span>: <span class="id">block</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>) (<span class="id">v</span>: <span class="id">val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">Genv.block_is_volatile</span> <span class="id">ge</span> <span class="id">b</span> <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">id</span> &lt;- <span class="id">Genv.invert_symbol</span> <span class="id">ge</span> <span class="id">b</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">ev</span> &lt;- <span class="id">eventval_of_val</span> (<span class="id">Val.load_result</span> <span class="id">chunk</span> <span class="id">v</span>) (<span class="id">type_of_chunk</span> <span class="id">chunk</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span>' &lt;- <span class="id">nextworld_vstore</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">id</span> <span class="id">ofs</span> <span class="id">ev</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>', <span class="id">Event_vstore</span> <span class="id">chunk</span> <span class="id">id</span> <span class="id">ofs</span> <span class="id">ev</span> :: <span class="id">nil</span>, <span class="id">m</span>)<br/>
&nbsp;&nbsp;<span class="kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.store</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>) <span class="id">v</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">m</span>').<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_volatile_load_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">do_volatile_load</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">volatile_load</span> <span class="id">ge</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">t</span> <span class="id">v</span> /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4198')">Proof.</div>
<div class="proofscript" id="proof4198">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">v</span>. <span class="tactic">unfold</span> <span class="id">do_volatile_load</span>. <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span> <span class="kwd">as</span> [<span class="id">ev</span> <span class="id">w</span>'']. <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">Genv.invert_find_symbol</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">val_of_eventval_sound</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>. <span class="id">constructor</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="id">constructor</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_volatile_load_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">volatile_load</span> <span class="id">ge</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">t</span> <span class="id">v</span> -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_volatile_load</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">v</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4199')">Proof.</div>
<div class="proofscript" id="proof4199">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_volatile_load</span>; <span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">rewrite</span> (<span class="id">Genv.find_invert_symbol</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H2</span>). <span class="id">inv</span> <span class="id">H0</span>. <span class="id">inv</span> <span class="id">H8</span>. <span class="id">inv</span> <span class="id">H6</span>. <span class="tactic">rewrite</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">val_of_eventval_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H3</span>). <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">rewrite</span> <span class="id">H2</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_volatile_store_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">do_volatile_store</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">m</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">volatile_store</span> <span class="id">ge</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">t</span> <span class="id">m</span>' /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4200')">Proof.</div>
<div class="proofscript" id="proof4200">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">m</span>'. <span class="tactic">unfold</span> <span class="id">do_volatile_store</span>. <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">Genv.invert_find_symbol</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">eventval_of_val_sound</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>. <span class="id">constructor</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">constructor</span>; <span class="tactic">auto</span>. <span class="id">constructor</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_volatile_store_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">volatile_store</span> <span class="id">ge</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">t</span> <span class="id">m</span>' -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_volatile_store</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">m</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4201')">Proof.</div>
<div class="proofscript" id="proof4201">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_volatile_store</span>; <span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">rewrite</span> (<span class="id">Genv.find_invert_symbol</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H2</span>).<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">eventval_of_val_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H3</span>).<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="id">inv</span> <span class="id">H8</span>. <span class="id">inv</span> <span class="id">H6</span>. <span class="tactic">rewrite</span> <span class="id">H9</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">rewrite</span> <span class="id">H2</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Accessing locations </div>
<br/>
<span class="kwd">Definition</span> <span class="id">do_deref_loc</span> (<span class="id">w</span>: <span class="id">world</span>) (<span class="id">ty</span>: <span class="id">type</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">b</span>: <span class="id">block</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">access_mode</span> <span class="id">ty</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">By_value</span> <span class="id">chunk</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type_is_volatile</span> <span class="id">ty</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">false</span> =&gt; <span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">Mem.loadv</span> <span class="id">chunk</span> <span class="id">m</span> (<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>); <span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">true</span> =&gt; <span class="id">do_volatile_load</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">By_reference</span> =&gt; <span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>)<br/>
&nbsp;&nbsp;| <span class="id">By_copy</span> =&gt; <span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">assign_copy_ok</span> (<span class="id">ty</span>: <span class="id">type</span>) (<span class="id">b</span>: <span class="id">block</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>) (<span class="id">b</span>': <span class="id">block</span>) (<span class="id">ofs</span>': <span class="id">ptrofs</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;(<span class="id">alignof_blockcopy</span> <span class="id">ge</span> <span class="id">ty</span> | <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>') /\ (<span class="id">alignof_blockcopy</span> <span class="id">ge</span> <span class="id">ty</span> | <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>) /\<br/>
&nbsp;&nbsp;(<span class="id">b</span>' &lt;&gt; <span class="id">b</span> \/ <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>' = <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/ <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>' + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span> &lt;= <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/ <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span> &lt;= <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>').<br/>
<br/>
<span class="kwd">Remark</span> <span class="id">check_assign_copy</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">ty</span>: <span class="id">type</span>) (<span class="id">b</span>: <span class="id">block</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>) (<span class="id">b</span>': <span class="id">block</span>) (<span class="id">ofs</span>': <span class="id">ptrofs</span>),<br/>
&nbsp;&nbsp;{ <span class="id">assign_copy_ok</span> <span class="id">ty</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">b</span>' <span class="id">ofs</span>' } + {~ <span class="id">assign_copy_ok</span> <span class="id">ty</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">b</span>' <span class="id">ofs</span>' }.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4202')">Proof with</div>
<div class="proofscript" id="proof4202">
 <span class="tactic">try</span> (<span class="id">right</span>; <span class="tactic">intuition</span> <span class="tactic">omega</span>).<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">assign_copy_ok</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">alignof_blockcopy</span> <span class="id">ge</span> <span class="id">ty</span> &gt; 0) <span class="tactic">by</span> <span class="tactic">apply</span> <span class="id">alignof_blockcopy_pos</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Zdivide_dec</span> (<span class="id">alignof_blockcopy</span> <span class="id">ge</span> <span class="id">ty</span>) (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>')); <span class="tactic">auto</span>...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Zdivide_dec</span> (<span class="id">alignof_blockcopy</span> <span class="id">ge</span> <span class="id">ty</span>) (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>)); <span class="tactic">auto</span>...<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Y</span>: {<span class="id">b</span>' &lt;&gt; <span class="id">b</span> \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>' = <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>' + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span> &lt;= <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span> &lt;= <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>'} +<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{~(<span class="id">b</span>' &lt;&gt; <span class="id">b</span> \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>' = <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>' + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span> &lt;= <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> \/<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span> &lt;= <span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>')}).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">eq_block</span> <span class="id">b</span>' <span class="id">b</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zeq</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>') (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>)); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>' + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span>) (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>)); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span> + <span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span>) (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>')); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>; <span class="tactic">intuition</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">Y</span>... <span class="id">left</span>; <span class="tactic">intuition</span> <span class="tactic">omega</span>.<br/>
Defined.</div>
<br/>
<span class="kwd">Definition</span> <span class="id">do_assign_loc</span> (<span class="id">w</span>: <span class="id">world</span>) (<span class="id">ty</span>: <span class="id">type</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">b</span>: <span class="id">block</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>) (<span class="id">v</span>: <span class="id">val</span>): <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">access_mode</span> <span class="id">ty</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">By_value</span> <span class="id">chunk</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type_is_volatile</span> <span class="id">ty</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">false</span> =&gt; <span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.storev</span> <span class="id">chunk</span> <span class="id">m</span> (<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>) <span class="id">v</span>; <span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">m</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">true</span> =&gt; <span class="id">do_volatile_store</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">By_copy</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">v</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Vptr</span> <span class="id">b</span>' <span class="id">ofs</span>' =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">check_assign_copy</span> <span class="id">ty</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">b</span>' <span class="id">ofs</span>' <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">bytes</span> &lt;- <span class="id">Mem.loadbytes</span> <span class="id">m</span> <span class="id">b</span>' (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>') (<span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.storebytes</span> <span class="id">m</span> <span class="id">b</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">ofs</span>) <span class="id">bytes</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">m</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_deref_loc_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">deref_loc</span> <span class="id">ge</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">t</span> <span class="id">v</span> /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4203')">Proof.</div>
<div class="proofscript" id="proof4203">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_deref_loc</span>; <span class="tactic">intros</span> <span class="id">until</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">access_mode</span> <span class="id">ty</span>) <span class="id">eqn</span>:?; <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">do_volatile_load_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intuition</span>. <span class="tactic">eapply</span> <span class="id">deref_loc_volatile</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">deref_loc_value</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">deref_loc_reference</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">deref_loc_copy</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_deref_loc_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">deref_loc</span> <span class="id">ge</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">t</span> <span class="id">v</span> -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">v</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4204')">Proof.</div>
<div class="proofscript" id="proof4204">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_deref_loc</span>; <span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>; <span class="tactic">rewrite</span> <span class="id">H2</span>; <span class="tactic">rewrite</span> <span class="id">H3</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>; <span class="tactic">rewrite</span> <span class="id">H2</span>. <span class="tactic">apply</span> <span class="id">do_volatile_load_complete</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_assign_loc_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">do_assign_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">m</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">assign_loc</span> <span class="id">ge</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">t</span> <span class="id">m</span>' /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4205')">Proof.</div>
<div class="proofscript" id="proof4205">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_assign_loc</span>; <span class="tactic">intros</span> <span class="id">until</span> <span class="id">m</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">access_mode</span> <span class="id">ty</span>) <span class="id">eqn</span>:?; <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">do_volatile_store_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intuition</span>. <span class="tactic">eapply</span> <span class="id">assign_loc_volatile</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">assign_loc_value</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">v</span>; <span class="id">mydestr</span>. <span class="tactic">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [<span class="id">P</span> [<span class="id">Q</span> <span class="id">R</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">assign_loc_copy</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_assign_loc_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">assign_loc</span> <span class="id">ge</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">t</span> <span class="id">m</span>' -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_assign_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">m</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4206')">Proof.</div>
<div class="proofscript" id="proof4206">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_assign_loc</span>; <span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>; <span class="tactic">rewrite</span> <span class="id">H2</span>; <span class="tactic">rewrite</span> <span class="id">H3</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>; <span class="tactic">rewrite</span> <span class="id">H2</span>. <span class="tactic">apply</span> <span class="id">do_volatile_store_complete</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">destruct</span> (<span class="id">check_assign_copy</span> <span class="id">ty</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">b</span>' <span class="id">ofs</span>').<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H5</span>; <span class="tactic">rewrite</span> <span class="id">H6</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">elim</span> <span class="id">n</span>. <span class="tactic">red</span>; <span class="tactic">tauto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">External calls </div>
<br/>
<span class="kwd">Variable</span> <span class="id">do_external_function</span>:<br/>
&nbsp;&nbsp;<span class="id">string</span> -&gt; <span class="id">signature</span> -&gt; <span class="id">Senv.t</span> -&gt; <span class="id">world</span> -&gt; <span class="id">list</span> <span class="id">val</span> -&gt; <span class="id">mem</span> -&gt; <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>).<br/>
<br/>
<span class="kwd">Hypothesis</span> <span class="id">do_external_function_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">id</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' <span class="id">w</span> <span class="id">w</span>',<br/>
&nbsp;&nbsp;<span class="id">do_external_function</span> <span class="id">id</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">vres</span>, <span class="id">m</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">external_functions_sem</span> <span class="id">id</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<br/>
<span class="kwd">Hypothesis</span> <span class="id">do_external_function_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">id</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' <span class="id">w</span> <span class="id">w</span>',<br/>
&nbsp;&nbsp;<span class="id">external_functions_sem</span> <span class="id">id</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_external_function</span> <span class="id">id</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">vres</span>, <span class="id">m</span>').<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">do_inline_assembly</span>:<br/>
&nbsp;&nbsp;<span class="id">string</span> -&gt; <span class="id">signature</span> -&gt; <span class="id">Senv.t</span> -&gt; <span class="id">world</span> -&gt; <span class="id">list</span> <span class="id">val</span> -&gt; <span class="id">mem</span> -&gt; <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>).<br/>
<br/>
<span class="kwd">Hypothesis</span> <span class="id">do_inline_assembly_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">txt</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' <span class="id">w</span> <span class="id">w</span>',<br/>
&nbsp;&nbsp;<span class="id">do_inline_assembly</span> <span class="id">txt</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">vres</span>, <span class="id">m</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">inline_assembly_sem</span> <span class="id">txt</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<br/>
<span class="kwd">Hypothesis</span> <span class="id">do_inline_assembly_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">txt</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' <span class="id">w</span> <span class="id">w</span>',<br/>
&nbsp;&nbsp;<span class="id">inline_assembly_sem</span> <span class="id">txt</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_inline_assembly</span> <span class="id">txt</span> <span class="id">sg</span> <span class="id">ge</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">vres</span>, <span class="id">m</span>').<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_volatile_load</span> (<span class="id">chunk</span>: <span class="id">memory_chunk</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span> :: <span class="id">nil</span> =&gt; <span class="tactic">do</span> <span class="id">w</span>',<span class="id">t</span>,<span class="id">v</span> &lt;- <span class="id">do_volatile_load</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span>; <span class="id">Some</span>(<span class="id">w</span>',<span class="id">t</span>,<span class="id">v</span>,<span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_volatile_store</span> (<span class="id">chunk</span>: <span class="id">memory_chunk</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span> :: <span class="id">v</span> :: <span class="id">nil</span> =&gt; <span class="tactic">do</span> <span class="id">w</span>',<span class="id">t</span>,<span class="id">m</span>' &lt;- <span class="id">do_volatile_store</span> <span class="id">w</span> <span class="id">chunk</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span>; <span class="id">Some</span>(<span class="id">w</span>',<span class="id">t</span>,<span class="id">Vundef</span>,<span class="id">m</span>')<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_volatile_load_global</span> (<span class="id">chunk</span>: <span class="id">memory_chunk</span>) (<span class="id">id</span>: <span class="id">ident</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">id</span>; <span class="id">do_ef_volatile_load</span> <span class="id">chunk</span> <span class="id">w</span> (<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span> :: <span class="id">vargs</span>) <span class="id">m</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_volatile_store_global</span> (<span class="id">chunk</span>: <span class="id">memory_chunk</span>) (<span class="id">id</span>: <span class="id">ident</span>) (<span class="id">ofs</span>: <span class="id">ptrofs</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">id</span>; <span class="id">do_ef_volatile_store</span> <span class="id">chunk</span> <span class="id">w</span> (<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span> :: <span class="id">vargs</span>) <span class="id">m</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_alloc_size</span> (<span class="id">v</span>: <span class="id">val</span>) : <span class="id">option</span> <span class="id">ptrofs</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">v</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Vint</span> <span class="id">n</span> =&gt; <span class="kwd">if</span> <span class="id">Archi.ptr64</span> <span class="kwd">then</span> <span class="id">None</span> <span class="kwd">else</span> <span class="id">Some</span> (<span class="id">Ptrofs.of_int</span> <span class="id">n</span>)<br/>
&nbsp;&nbsp;| <span class="id">Vlong</span> <span class="id">n</span> =&gt; <span class="kwd">if</span> <span class="id">Archi.ptr64</span> <span class="kwd">then</span> <span class="id">Some</span> (<span class="id">Ptrofs.of_int64</span> <span class="id">n</span>) <span class="kwd">else</span> <span class="id">None</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_malloc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">v</span> :: <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">sz</span> &lt;- <span class="id">do_alloc_size</span> <span class="id">v</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">m</span>', <span class="id">b</span>) := <span class="id">Mem.alloc</span> <span class="id">m</span> (- <span class="id">size_chunk</span> <span class="id">Mptr</span>) (<span class="id">Ptrofs.unsigned</span> <span class="id">sz</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>'' &lt;- <span class="id">Mem.store</span> <span class="id">Mptr</span> <span class="id">m</span>' <span class="id">b</span> (- <span class="id">size_chunk</span> <span class="id">Mptr</span>) <span class="id">v</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">Vptr</span> <span class="id">b</span> <span class="id">Ptrofs.zero</span>, <span class="id">m</span>'')<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_free</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Vptr</span> <span class="id">b</span> <span class="id">lo</span> :: <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">vsz</span> &lt;- <span class="id">Mem.load</span> <span class="id">Mptr</span> <span class="id">m</span> <span class="id">b</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">lo</span> - <span class="id">size_chunk</span> <span class="id">Mptr</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">sz</span> &lt;- <span class="id">do_alloc_size</span> <span class="id">vsz</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> (<span class="id">zlt</span> 0 (<span class="id">Ptrofs.unsigned</span> <span class="id">sz</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.free</span> <span class="id">m</span> <span class="id">b</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">lo</span> - <span class="id">size_chunk</span> <span class="id">Mptr</span>) (<span class="id">Ptrofs.unsigned</span> <span class="id">lo</span> + <span class="id">Ptrofs.unsigned</span> <span class="id">sz</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">Vundef</span>, <span class="id">m</span>')<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">memcpy_args_ok</span><br/>
&nbsp;&nbsp;(<span class="id">sz</span> <span class="id">al</span>: <span class="id">Z</span>) (<span class="id">bdst</span>: <span class="id">block</span>) (<span class="id">odst</span>: <span class="id">Z</span>) (<span class="id">bsrc</span>: <span class="id">block</span>) (<span class="id">osrc</span>: <span class="id">Z</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">al</span> = 1 \/ <span class="id">al</span> = 2 \/ <span class="id">al</span> = 4 \/ <span class="id">al</span> = 8)<br/>
&nbsp;&nbsp;&nbsp;/\ <span class="id">sz</span> &gt;= 0 /\ (<span class="id">al</span> | <span class="id">sz</span>)<br/>
&nbsp;&nbsp;&nbsp;/\ (<span class="id">sz</span> &gt; 0 -&gt; (<span class="id">al</span> | <span class="id">osrc</span>))<br/>
&nbsp;&nbsp;&nbsp;/\ (<span class="id">sz</span> &gt; 0 -&gt; (<span class="id">al</span> | <span class="id">odst</span>))<br/>
&nbsp;&nbsp;&nbsp;/\ (<span class="id">bsrc</span> &lt;&gt; <span class="id">bdst</span> \/ <span class="id">osrc</span> = <span class="id">odst</span> \/ <span class="id">osrc</span> + <span class="id">sz</span> &lt;= <span class="id">odst</span> \/ <span class="id">odst</span> + <span class="id">sz</span> &lt;= <span class="id">osrc</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_memcpy</span> (<span class="id">sz</span> <span class="id">al</span>: <span class="id">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Vptr</span> <span class="id">bdst</span> <span class="id">odst</span> :: <span class="id">Vptr</span> <span class="id">bsrc</span> <span class="id">osrc</span> :: <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">decide</span> (<span class="id">memcpy_args_ok</span> <span class="id">sz</span> <span class="id">al</span> <span class="id">bdst</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">odst</span>) <span class="id">bsrc</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">osrc</span>)) <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">bytes</span> &lt;- <span class="id">Mem.loadbytes</span> <span class="id">m</span> <span class="id">bsrc</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">osrc</span>) <span class="id">sz</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.storebytes</span> <span class="id">m</span> <span class="id">bdst</span> (<span class="id">Ptrofs.unsigned</span> <span class="id">odst</span>) <span class="id">bytes</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">Vundef</span>, <span class="id">m</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">None</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_annot</span> (<span class="id">text</span>: <span class="id">string</span>) (<span class="id">targs</span>: <span class="id">list</span> <span class="id">typ</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">args</span> &lt;- <span class="id">list_eventval_of_val</span> <span class="id">vargs</span> <span class="id">targs</span>;<br/>
&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">Event_annot</span> <span class="id">text</span> <span class="id">args</span> :: <span class="id">E0</span>, <span class="id">Vundef</span>, <span class="id">m</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_annot_val</span> (<span class="id">text</span>: <span class="id">string</span>) (<span class="id">targ</span>: <span class="id">typ</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">varg</span> :: <span class="id">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">arg</span> &lt;- <span class="id">eventval_of_val</span> <span class="id">varg</span> <span class="id">targ</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">Event_annot</span> <span class="id">text</span> (<span class="id">arg</span> :: <span class="id">nil</span>) :: <span class="id">E0</span>, <span class="id">varg</span>, <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_ef_debug</span> (<span class="id">kind</span>: <span class="id">positive</span>) (<span class="id">text</span>: <span class="id">ident</span>) (<span class="id">targs</span>: <span class="id">list</span> <span class="id">typ</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">w</span>: <span class="id">world</span>) (<span class="id">vargs</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="id">Some</span>(<span class="id">w</span>, <span class="id">E0</span>, <span class="id">Vundef</span>, <span class="id">m</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_external</span> (<span class="id">ef</span>: <span class="id">external_function</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">world</span> -&gt; <span class="id">list</span> <span class="id">val</span> -&gt; <span class="id">mem</span> -&gt; <span class="id">option</span> (<span class="id">world</span> * <span class="id">trace</span> * <span class="id">val</span> * <span class="id">mem</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">ef</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">EF_external</span> <span class="id">name</span> <span class="id">sg</span> =&gt; <span class="id">do_external_function</span> <span class="id">name</span> <span class="id">sg</span> <span class="id">ge</span><br/>
&nbsp;&nbsp;| <span class="id">EF_builtin</span> <span class="id">name</span> <span class="id">sg</span> =&gt; <span class="id">do_external_function</span> <span class="id">name</span> <span class="id">sg</span> <span class="id">ge</span><br/>
&nbsp;&nbsp;| <span class="id">EF_runtime</span> <span class="id">name</span> <span class="id">sg</span> =&gt; <span class="id">do_external_function</span> <span class="id">name</span> <span class="id">sg</span> <span class="id">ge</span><br/>
&nbsp;&nbsp;| <span class="id">EF_vload</span> <span class="id">chunk</span> =&gt; <span class="id">do_ef_volatile_load</span> <span class="id">chunk</span><br/>
&nbsp;&nbsp;| <span class="id">EF_vstore</span> <span class="id">chunk</span> =&gt; <span class="id">do_ef_volatile_store</span> <span class="id">chunk</span><br/>
&nbsp;&nbsp;| <span class="id">EF_malloc</span> =&gt; <span class="id">do_ef_malloc</span><br/>
&nbsp;&nbsp;| <span class="id">EF_free</span> =&gt; <span class="id">do_ef_free</span><br/>
&nbsp;&nbsp;| <span class="id">EF_memcpy</span> <span class="id">sz</span> <span class="id">al</span> =&gt; <span class="id">do_ef_memcpy</span> <span class="id">sz</span> <span class="id">al</span><br/>
&nbsp;&nbsp;| <span class="id">EF_annot</span> <span class="id">text</span> <span class="id">targs</span> =&gt; <span class="id">do_ef_annot</span> <span class="id">text</span> <span class="id">targs</span><br/>
&nbsp;&nbsp;| <span class="id">EF_annot_val</span> <span class="id">text</span> <span class="id">targ</span> =&gt; <span class="id">do_ef_annot_val</span> <span class="id">text</span> <span class="id">targ</span><br/>
&nbsp;&nbsp;| <span class="id">EF_inline_asm</span> <span class="id">text</span> <span class="id">sg</span> <span class="id">clob</span> =&gt; <span class="id">do_inline_assembly</span> <span class="id">text</span> <span class="id">sg</span> <span class="id">ge</span><br/>
&nbsp;&nbsp;| <span class="id">EF_debug</span> <span class="id">kind</span> <span class="id">text</span> <span class="id">targs</span> =&gt; <span class="id">do_ef_debug</span> <span class="id">kind</span> <span class="id">text</span> <span class="id">targs</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_ef_external_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ef</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">do_external</span> <span class="id">ef</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">vres</span>, <span class="id">m</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">external_call</span> <span class="id">ef</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4207')">Proof with</div>
<div class="proofscript" id="proof4207">
 <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">SIZE</span>: <span class="kwd">forall</span> <span class="id">v</span> <span class="id">sz</span>, <span class="id">do_alloc_size</span> <span class="id">v</span> = <span class="id">Some</span> <span class="id">sz</span> -&gt; <span class="id">v</span> = <span class="id">Vptrofs</span> <span class="id">sz</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">intros</span> <span class="id">until</span> <span class="id">sz</span>; <span class="tactic">unfold</span> <span class="id">Vptrofs</span>; <span class="tactic">destruct</span> <span class="id">v</span>; <span class="tactic">simpl</span>; <span class="tactic">destruct</span> <span class="id">Archi.ptr64</span> <span class="id">eqn</span>:<span class="id">SF</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">EQ</span>; <span class="id">inv</span> <span class="id">EQ</span>; <span class="tactic">f_equal</span>; <span class="tactic">symmetry</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">ptrofs</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">m</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">ef</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;EF_external&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_external_function_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_builtin&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_external_function_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_runtime&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_external_function_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_vload&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_volatile_load</span>. <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="tactic">destruct</span> <span class="id">v</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>...<br/>
&nbsp;&nbsp;<span class="id">mydestr</span>. <span class="tactic">destruct</span> <span class="id">p</span> <span class="kwd">as</span> [[<span class="id">w</span>'' <span class="id">t</span>''] <span class="id">v</span>]; <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_volatile_load_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intuition</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;EF_vstore&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_volatile_store</span>. <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="tactic">destruct</span> <span class="id">v</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>...<br/>
&nbsp;&nbsp;<span class="id">mydestr</span>. <span class="tactic">destruct</span> <span class="id">p</span> <span class="kwd">as</span> [[<span class="id">w</span>'' <span class="id">t</span>''] <span class="id">m</span>'']. <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_volatile_store_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intuition</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;EF_malloc&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_malloc</span>. <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Mem.alloc</span> <span class="id">m</span> (- <span class="id">size_chunk</span> <span class="id">Mptr</span>) (<span class="id">Ptrofs.unsigned</span> <span class="id">i</span>)) <span class="kwd">as</span> [<span class="id">m1</span> <span class="id">b</span>] <span class="id">eqn</span>:?. <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">SIZE</span> <span class="kwd">in</span> <span class="id">Heqo</span>. <span class="tactic">subst</span> <span class="id">v</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;EF_free&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_free</span>. <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="tactic">destruct</span> <span class="id">v</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>...<br/>
&nbsp;&nbsp;<span class="id">mydestr</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">SIZE</span> <span class="kwd">in</span> <span class="id">Heqo0</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>. <span class="tactic">omega</span>. <span class="id">constructor</span>.<br/>
&nbsp;EF_memcpy&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_memcpy</span>. <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="tactic">destruct</span> <span class="id">v</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">v</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="id">mydestr</span>. <br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">Decidable_sound</span> <span class="kwd">in</span> <span class="id">Heqb1</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">Heqb1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>; <span class="tactic">tauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;EF_annot&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_annot</span>. <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">constructor</span>. <span class="tactic">apply</span> <span class="id">list_eventval_of_val_sound</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>. <span class="id">constructor</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;EF_annot_val&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_annot_val</span>. <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="tactic">destruct</span> <span class="id">vargs</span>... <span class="id">mydestr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>. <span class="id">constructor</span>. <span class="tactic">apply</span> <span class="id">eventval_of_val_sound</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>. <span class="id">constructor</span>; <span class="tactic">eauto</span>. <span class="id">constructor</span>.<br/>
&nbsp;EF_inline_asm&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_inline_assembly_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_debug&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_ef_debug</span>. <span class="id">mydestr</span>. <span class="tactic">split</span>; <span class="id">constructor</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_ef_external_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ef</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">w</span>' <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">external_call</span> <span class="id">ef</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_external</span> <span class="id">ef</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> = <span class="id">Some</span>(<span class="id">w</span>', <span class="id">t</span>, <span class="id">vres</span>, <span class="id">m</span>').<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4208')">Proof.</div>
<div class="proofscript" id="proof4208">
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">SIZE</span>: <span class="kwd">forall</span> <span class="id">n</span>, <span class="id">do_alloc_size</span> (<span class="id">Vptrofs</span> <span class="id">n</span>) = <span class="id">Some</span> <span class="id">n</span>).<br/>
&nbsp;&nbsp;{ <span class="tactic">unfold</span> <span class="id">Vptrofs</span>, <span class="id">do_alloc_size</span>; <span class="tactic">intros</span>; <span class="tactic">destruct</span> <span class="id">Archi.ptr64</span> <span class="id">eqn</span>:<span class="id">SF</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Ptrofs.of_int64_to_int64</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">Ptrofs.of_int_to_int</span>; <span class="tactic">auto</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">ef</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;EF_external&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_external_function_complete</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_builtin&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_external_function_complete</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_runtime&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_external_function_complete</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_vload&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">unfold</span> <span class="id">do_ef_volatile_load</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_volatile_load_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">EQ</span>; <span class="tactic">rewrite</span> <span class="id">EQ</span>; <span class="tactic">auto</span>.<br/>
&nbsp;EF_vstore&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">unfold</span> <span class="id">do_ef_volatile_store</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_volatile_store_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">EQ</span>; <span class="tactic">rewrite</span> <span class="id">EQ</span>; <span class="tactic">auto</span>.<br/>
&nbsp;EF_malloc&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">unfold</span> <span class="id">do_ef_malloc</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="id">erewrite</span> <span class="id">SIZE</span> <span class="tactic">by</span> <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>, <span class="id">H2</span>. <span class="tactic">auto</span>.<br/>
&nbsp;EF_free&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">unfold</span> <span class="id">do_ef_free</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="id">erewrite</span> <span class="id">SIZE</span> <span class="tactic">by</span> <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">zlt_true</span>. <span class="tactic">rewrite</span> <span class="id">H3</span>. <span class="tactic">auto</span>. <span class="tactic">omega</span>.<br/>
&nbsp;EF_memcpy&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">unfold</span> <span class="id">do_ef_memcpy</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">Decidable_complete</span>. <span class="tactic">rewrite</span> <span class="id">H7</span>; <span class="tactic">rewrite</span> <span class="id">H8</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>. <span class="tactic">tauto</span>.<br/>
&nbsp;EF_annot&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">unfold</span> <span class="id">do_ef_annot</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="id">inv</span> <span class="id">H6</span>. <span class="id">inv</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">list_eventval_of_val_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H1</span>). <span class="tactic">auto</span>.<br/>
&nbsp;EF_annot_val&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">unfold</span> <span class="id">do_ef_annot_val</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="id">inv</span> <span class="id">H6</span>. <span class="id">inv</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">eventval_of_val_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H1</span>). <span class="tactic">auto</span>.<br/>
&nbsp;EF_inline_asm&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_inline_assembly_complete</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;EF_debug&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">reflexivity</span>.<br/>
Qed.</div>
<br/>
<h1> Reduction of expressions </h1>
<br/>
<span class="kwd">Inductive</span> <span class="id">reduction</span>: <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">Lred</span> (<span class="id">rule</span>: <span class="id">string</span>) (<span class="id">l</span>': <span class="id">expr</span>) (<span class="id">m</span>': <span class="id">mem</span>)<br/>
&nbsp;&nbsp;| <span class="id">Rred</span> (<span class="id">rule</span>: <span class="id">string</span>) (<span class="id">r</span>': <span class="id">expr</span>) (<span class="id">m</span>': <span class="id">mem</span>) (<span class="id">t</span>: <span class="id">trace</span>)<br/>
&nbsp;&nbsp;| <span class="id">Callred</span> (<span class="id">rule</span>: <span class="id">string</span>) (<span class="id">fd</span>: <span class="id">fundef</span>) (<span class="id">args</span>: <span class="id">list</span> <span class="id">val</span>) (<span class="id">tyres</span>: <span class="id">type</span>) (<span class="id">m</span>': <span class="id">mem</span>)<br/>
&nbsp;&nbsp;| <span class="id">Stuckred</span>.<br/>
<br/>
<span class="kwd">Section</span> <span class="id">EXPRS</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">e</span>: <span class="id">env</span>.<br/>
<span class="kwd">Variable</span> <span class="id">w</span>: <span class="id">world</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">sem_cast_arguments</span> (<span class="id">vtl</span>: <span class="id">list</span> (<span class="id">val</span> * <span class="id">type</span>)) (<span class="id">tl</span>: <span class="id">typelist</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="id">option</span> (<span class="id">list</span> <span class="id">val</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">vtl</span>, <span class="id">tl</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">nil</span>, <span class="id">Tnil</span> =&gt; <span class="id">Some</span> <span class="id">nil</span><br/>
&nbsp;&nbsp;| (<span class="id">v1</span>,<span class="id">t1</span>)::<span class="id">vtl</span>, <span class="id">Tcons</span> <span class="id">t1</span>' <span class="id">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">sem_cast</span> <span class="id">v1</span> <span class="id">t1</span> <span class="id">t1</span>' <span class="id">m</span>; <span class="tactic">do</span> <span class="id">vl</span> &lt;- <span class="id">sem_cast_arguments</span> <span class="id">vtl</span> <span class="id">tl</span> <span class="id">m</span>; <span class="id">Some</span>(<span class="id">v</span>::<span class="id">vl</span>)<br/>
&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">The result of stepping an expression is a list <span class="bracket"><span class="id">ll</span></span> of possible reducts.
  Each element of <span class="bracket"><span class="id">ll</span></span> is a pair of a context and the result of reducing
  inside this context (see type <span class="bracket"><span class="id">reduction</span></span> above).
  The list <span class="bracket"><span class="id">ll</span></span> is empty if the expression is fully reduced
   (it's <span class="bracket"><span class="kwd">Eval</span></span> for a r-value and <span class="bracket"><span class="id">Eloc</span></span> for a l-value).
</div>
<br/>
<span class="kwd">Definition</span> <span class="id">reducts</span> (<span class="id">A</span>: <span class="kwd">Type</span>): <span class="kwd">Type</span> := <span class="id">list</span> ((<span class="id">expr</span> -&gt; <span class="id">A</span>) * <span class="id">reduction</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">topred</span> (<span class="id">r</span>: <span class="id">reduction</span>) : <span class="id">reducts</span> <span class="id">expr</span> :=<br/>
&nbsp;&nbsp;((<span class="kwd">fun</span> (<span class="id">x</span>: <span class="id">expr</span>) =&gt; <span class="id">x</span>), <span class="id">r</span>) :: <span class="id">nil</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">stuck</span> : <span class="id">reducts</span> <span class="id">expr</span> :=<br/>
&nbsp;&nbsp;((<span class="kwd">fun</span> (<span class="id">x</span>: <span class="id">expr</span>) =&gt; <span class="id">x</span>), <span class="id">Stuckred</span>) :: <span class="id">nil</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">incontext</span> {<span class="id">A</span> <span class="id">B</span>: <span class="kwd">Type</span>} (<span class="id">ctx</span>: <span class="id">A</span> -&gt; <span class="id">B</span>) (<span class="id">ll</span>: <span class="id">reducts</span> <span class="id">A</span>) : <span class="id">reducts</span> <span class="id">B</span> :=<br/>
&nbsp;&nbsp;<span class="id">map</span> (<span class="kwd">fun</span> <span class="id">z</span> =&gt; ((<span class="kwd">fun</span> (<span class="id">x</span>: <span class="id">expr</span>) =&gt; <span class="id">ctx</span>(<span class="id">fst</span> <span class="id">z</span> <span class="id">x</span>)), <span class="id">snd</span> <span class="id">z</span>)) <span class="id">ll</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">incontext2</span> {<span class="id">A1</span> <span class="id">A2</span> <span class="id">B</span>: <span class="kwd">Type</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ctx1</span>: <span class="id">A1</span> -&gt; <span class="id">B</span>) (<span class="id">ll1</span>: <span class="id">reducts</span> <span class="id">A1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ctx2</span>: <span class="id">A2</span> -&gt; <span class="id">B</span>) (<span class="id">ll2</span>: <span class="id">reducts</span> <span class="id">A2</span>) : <span class="id">reducts</span> <span class="id">B</span> :=<br/>
&nbsp;&nbsp;<span class="id">incontext</span> <span class="id">ctx1</span> <span class="id">ll1</span> ++ <span class="id">incontext</span> <span class="id">ctx2</span> <span class="id">ll2</span>.<br/>
<br/>
<span class="kwd">Notation</span> "'<span class="tactic">do</span>' <span class="id">X</span> &lt;- <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">match</span> <span class="id">A</span> <span class="kwd">with</span> <span class="id">Some</span> <span class="id">X</span> =&gt; <span class="id">B</span> | <span class="id">None</span> =&gt; <span class="id">stuck</span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">X</span> <span class="id">ident</span>, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">reducts_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> "'<span class="tactic">do</span>' <span class="id">X</span> , <span class="id">Y</span> &lt;- <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">match</span> <span class="id">A</span> <span class="kwd">with</span> <span class="id">Some</span> (<span class="id">X</span>, <span class="id">Y</span>) =&gt; <span class="id">B</span> | <span class="id">None</span> =&gt; <span class="id">stuck</span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">X</span> <span class="id">ident</span>, <span class="id">Y</span> <span class="id">ident</span>, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">reducts_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> "'<span class="tactic">do</span>' <span class="id">X</span> , <span class="id">Y</span> , <span class="id">Z</span> &lt;- <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">match</span> <span class="id">A</span> <span class="kwd">with</span> <span class="id">Some</span> (<span class="id">X</span>, <span class="id">Y</span>, <span class="id">Z</span>) =&gt; <span class="id">B</span> | <span class="id">None</span> =&gt; <span class="id">stuck</span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">X</span> <span class="id">ident</span>, <span class="id">Y</span> <span class="id">ident</span>, <span class="id">Z</span> <span class="id">ident</span>, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">reducts_monad_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> " '<span class="id">check</span>' <span class="id">A</span> ; <span class="id">B</span>" := (<span class="kwd">if</span> <span class="id">A</span> <span class="kwd">then</span> <span class="id">B</span> <span class="kwd">else</span> <span class="id">stuck</span>)<br/>
&nbsp;&nbsp;(<span class="tactic">at</span> <span class="id">level</span> 200, <span class="id">A</span> <span class="tactic">at</span> <span class="id">level</span> 100, <span class="id">B</span> <span class="tactic">at</span> <span class="id">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id">reducts_monad_scope</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">reducts_monad_scope</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">step_expr</span> (<span class="id">k</span>: <span class="id">kind</span>) (<span class="id">a</span>: <span class="id">expr</span>) (<span class="id">m</span>: <span class="id">mem</span>): <span class="id">reducts</span> <span class="id">expr</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">k</span>, <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">LV</span>, <span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nil</span><br/>
&nbsp;&nbsp;| <span class="id">LV</span>, <span class="id">Evar</span> <span class="id">x</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span>!<span class="id">x</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ty</span>') =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> <span class="id">type_eq</span> <span class="id">ty</span> <span class="id">ty</span>';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Lred</span> "<span class="id">red_var_local</span>" (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">Ptrofs.zero</span> <span class="id">ty</span>) <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">x</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Lred</span> "<span class="id">red_var_global</span>" (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">Ptrofs.zero</span> <span class="id">ty</span>) <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">LV</span>, <span class="id">Ederef</span> <span class="id">r</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>, <span class="id">ty</span>') =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Lred</span> "<span class="id">red_deref</span>" (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span>) <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">stuck</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ederef</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">LV</span>, <span class="id">Efield</span> <span class="id">r</span> <span class="id">f</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>, <span class="id">ty</span>') =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">ty</span>' <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tstruct</span> <span class="id">id</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">co</span> &lt;- <span class="id">ge</span>.(<span class="id">genv_cenv</span>)!<span class="id">id</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">field_offset</span> <span class="id">ge</span> <span class="id">f</span> (<span class="id">co_members</span> <span class="id">co</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Error</span> <span class="id">_</span> =&gt; <span class="id">stuck</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">OK</span> <span class="id">delta</span> =&gt; <span class="id">topred</span> (<span class="id">Lred</span> "<span class="id">red_field_struct</span>" (<span class="id">Eloc</span> <span class="id">b</span> (<span class="id">Ptrofs.add</span> <span class="id">ofs</span> (<span class="id">Ptrofs.repr</span> <span class="id">delta</span>)) <span class="id">ty</span>) <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tunion</span> <span class="id">id</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">co</span> &lt;- <span class="id">ge</span>.(<span class="id">genv_cenv</span>)!<span class="id">id</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Lred</span> "<span class="id">red_field_union</span>" (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span>) <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">stuck</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">stuck</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Efield</span> <span class="id">x</span> <span class="id">f</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nil</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Evalof</span> <span class="id">l</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_loc</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty</span>') =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> <span class="id">type_eq</span> <span class="id">ty</span> <span class="id">ty</span>';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span>',<span class="id">t</span>,<span class="id">v</span> &lt;- <span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_rvalof</span>" (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Evalof</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">LV</span> <span class="id">l</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Eaddrof</span> <span class="id">l</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_loc</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty</span>') =&gt; <span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_addrof</span>" (<span class="kwd">Eval</span> (<span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span>) <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eaddrof</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">LV</span> <span class="id">l</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Eunop</span> <span class="id">op</span> <span class="id">r1</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">v1</span>, <span class="id">ty1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">sem_unary_operation</span> <span class="id">op</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_unop</span>" (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eunop</span> <span class="id">op</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Ebinop</span> <span class="id">op</span> <span class="id">r1</span> <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span>, <span class="id">is_val</span> <span class="id">r2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">v1</span>, <span class="id">ty1</span>), <span class="id">Some</span>(<span class="id">v2</span>, <span class="id">ty2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">sem_binary_operation</span> <span class="id">ge</span> <span class="id">op</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">v2</span> <span class="id">ty2</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_binop</span>" (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext2</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ebinop</span> <span class="id">op</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ebinop</span> <span class="id">op</span> <span class="id">r1</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r2</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Ecast</span> <span class="id">r1</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">v1</span>, <span class="id">ty1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">sem_cast</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">ty</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_cast</span>" (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecast</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Eseqand</span> <span class="id">r1</span> <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">v1</span>, <span class="id">ty1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">bool_val</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">b</span> <span class="kwd">then</span> <span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_seqand_true</span>" (<span class="id">Eparen</span> <span class="id">r2</span> <span class="id">type_bool</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_seqand_false</span>" (<span class="kwd">Eval</span> (<span class="id">Vint</span> <span class="id">Int.zero</span>) <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eseqand</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Eseqor</span> <span class="id">r1</span> <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">v1</span>, <span class="id">ty1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">bool_val</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">b</span> <span class="kwd">then</span> <span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_seqor_true</span>" (<span class="kwd">Eval</span> (<span class="id">Vint</span> <span class="id">Int.one</span>) <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_seqor_false</span>" (<span class="id">Eparen</span> <span class="id">r2</span> <span class="id">type_bool</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eseqor</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Econdition</span> <span class="id">r1</span> <span class="id">r2</span> <span class="id">r3</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">v1</span>, <span class="id">ty1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">bool_val</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_condition</span>" (<span class="id">Eparen</span> (<span class="kwd">if</span> <span class="id">b</span> <span class="kwd">then</span> <span class="id">r2</span> <span class="kwd">else</span> <span class="id">r3</span>) <span class="id">ty</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econdition</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">r3</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Esizeof</span> <span class="id">ty</span>' <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_sizeof</span>" (<span class="kwd">Eval</span> (<span class="id">Vptrofs</span> (<span class="id">Ptrofs.repr</span> (<span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span>'))) <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Ealignof</span> <span class="id">ty</span>' <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_alignof</span>" (<span class="kwd">Eval</span> (<span class="id">Vptrofs</span> (<span class="id">Ptrofs.repr</span> (<span class="id">alignof</span> <span class="id">ge</span> <span class="id">ty</span>'))) <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Eassign</span> <span class="id">l1</span> <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_loc</span> <span class="id">l1</span>, <span class="id">is_val</span> <span class="id">r2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty1</span>), <span class="id">Some</span>(<span class="id">v2</span>, <span class="id">ty2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> <span class="id">type_eq</span> <span class="id">ty1</span> <span class="id">ty</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">sem_cast</span> <span class="id">v2</span> <span class="id">ty2</span> <span class="id">ty1</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span>',<span class="id">t</span>,<span class="id">m</span>' &lt;- <span class="id">do_assign_loc</span> <span class="id">w</span> <span class="id">ty1</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_assign</span>" (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span>' <span class="id">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext2</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassign</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">LV</span> <span class="id">l1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassign</span> <span class="id">l1</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r2</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Eassignop</span> <span class="id">op</span> <span class="id">l1</span> <span class="id">r2</span> <span class="id">tyres</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_loc</span> <span class="id">l1</span>, <span class="id">is_val</span> <span class="id">r2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty1</span>), <span class="id">Some</span>(<span class="id">v2</span>, <span class="id">ty2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> <span class="id">type_eq</span> <span class="id">ty1</span> <span class="id">ty</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span>',<span class="id">t</span>,<span class="id">v1</span> &lt;- <span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty1</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">r</span>' := <span class="id">Eassign</span> (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Ebinop</span> <span class="id">op</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) (<span class="kwd">Eval</span> <span class="id">v2</span> <span class="id">ty2</span>) <span class="id">tyres</span>) <span class="id">ty1</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_assignop</span>" <span class="id">r</span>' <span class="id">m</span> <span class="id">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext2</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassignop</span> <span class="id">op</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">tyres</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">LV</span> <span class="id">l1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassignop</span> <span class="id">op</span> <span class="id">l1</span> <span class="id">x</span> <span class="id">tyres</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r2</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Epostincr</span> <span class="id">id</span> <span class="id">l</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_loc</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> <span class="id">type_eq</span> <span class="id">ty1</span> <span class="id">ty</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span>',<span class="id">t</span>, <span class="id">v1</span> &lt;- <span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">op</span> := <span class="kwd">match</span> <span class="id">id</span> <span class="kwd">with</span> <span class="id">Incr</span> =&gt; <span class="id">Oadd</span> | <span class="id">Decr</span> =&gt; <span class="id">Osub</span> <span class="kwd">end</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">r</span>' :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ecomma</span> (<span class="id">Eassign</span> (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Ebinop</span> <span class="id">op</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty</span>) (<span class="kwd">Eval</span> (<span class="id">Vint</span> <span class="id">Int.one</span>) <span class="id">type_int32s</span>) (<span class="id">incrdecr_type</span> <span class="id">ty</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty</span>) <span class="id">ty</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_postincr</span>" <span class="id">r</span>' <span class="id">m</span> <span class="id">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Epostincr</span> <span class="id">id</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">LV</span> <span class="id">l</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Ecomma</span> <span class="id">r1</span> <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> <span class="id">type_eq</span> (<span class="id">typeof</span> <span class="id">r2</span>) <span class="id">ty</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_comma</span>" <span class="id">r2</span> <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecomma</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Eparen</span> <span class="id">r1</span> <span class="id">tycast</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">v1</span>, <span class="id">ty1</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span> &lt;- <span class="id">sem_cast</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">tycast</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_paren</span>" (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span> <span class="id">E0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eparen</span> <span class="id">x</span> <span class="id">tycast</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Ecall</span> <span class="id">r1</span> <span class="id">rargs</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">r1</span>, <span class="id">is_val_list</span> <span class="id">rargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">vf</span>, <span class="id">tyf</span>), <span class="id">Some</span> <span class="id">vtl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">classify_fun</span> <span class="id">tyf</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">fun_case_f</span> <span class="id">tyargs</span> <span class="id">tyres</span> <span class="id">cconv</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">fd</span> &lt;- <span class="id">Genv.find_funct</span> <span class="id">ge</span> <span class="id">vf</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">vargs</span> &lt;- <span class="id">sem_cast_arguments</span> <span class="id">vtl</span> <span class="id">tyargs</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> <span class="id">type_eq</span> (<span class="id">type_of_fundef</span> <span class="id">fd</span>) (<span class="id">Tfunction</span> <span class="id">tyargs</span> <span class="id">tyres</span> <span class="id">cconv</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">topred</span> (<span class="id">Callred</span> "<span class="id">red_call</span>" <span class="id">fd</span> <span class="id">vargs</span> <span class="id">ty</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">stuck</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext2</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecall</span> <span class="id">x</span> <span class="id">rargs</span> <span class="id">ty</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecall</span> <span class="id">r1</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_exprlist</span> <span class="id">rargs</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Ebuiltin</span> <span class="id">ef</span> <span class="id">tyargs</span> <span class="id">rargs</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val_list</span> <span class="id">rargs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">vtl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">vargs</span> &lt;- <span class="id">sem_cast_arguments</span> <span class="id">vtl</span> <span class="id">tyargs</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">do_external</span> <span class="id">ef</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">stuck</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">w</span>',<span class="id">t</span>,<span class="id">v</span>,<span class="id">m</span>') =&gt; <span class="id">topred</span> (<span class="id">Rred</span> "<span class="id">red_builtin</span>" (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span>' <span class="id">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ebuiltin</span> <span class="id">ef</span> <span class="id">tyargs</span> <span class="id">x</span> <span class="id">ty</span>) (<span class="id">step_exprlist</span> <span class="id">rargs</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">stuck</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
<span class="kwd">with</span> <span class="id">step_exprlist</span> (<span class="id">rl</span>: <span class="id">exprlist</span>) (<span class="id">m</span>: <span class="id">mem</span>): <span class="id">reducts</span> <span class="id">exprlist</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">rl</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Enil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">nil</span><br/>
&nbsp;&nbsp;| <span class="id">Econs</span> <span class="id">r1</span> <span class="id">rs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">incontext2</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econs</span> <span class="id">x</span> <span class="id">rs</span>) (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econs</span> <span class="id">r1</span> <span class="id">x</span>) (<span class="id">step_exprlist</span> <span class="id">rs</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Technical properties on safe expressions. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id">imm_safe_t</span>: <span class="id">kind</span> -&gt; <span class="id">expr</span> -&gt; <span class="id">mem</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">imm_safe_t_val</span>: <span class="kwd">forall</span> <span class="id">v</span> <span class="id">ty</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">imm_safe_t</span> <span class="id">RV</span> (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">m</span><br/>
&nbsp;&nbsp;| <span class="id">imm_safe_t_loc</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">imm_safe_t</span> <span class="id">LV</span> (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span>) <span class="id">m</span><br/>
&nbsp;&nbsp;| <span class="id">imm_safe_t_lred</span>: <span class="kwd">forall</span> <span class="id">to</span> <span class="id">C</span> <span class="id">l</span> <span class="id">m</span> <span class="id">l</span>' <span class="id">m</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lred</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">l</span> <span class="id">m</span> <span class="id">l</span>' <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context</span> <span class="id">LV</span> <span class="id">to</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">imm_safe_t</span> <span class="id">to</span> (<span class="id">C</span> <span class="id">l</span>) <span class="id">m</span><br/>
&nbsp;&nbsp;| <span class="id">imm_safe_t_rred</span>: <span class="kwd">forall</span> <span class="id">to</span> <span class="id">C</span> <span class="id">r</span> <span class="id">m</span> <span class="id">t</span> <span class="id">r</span>' <span class="id">m</span>' <span class="id">w</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rred</span> <span class="id">ge</span> <span class="id">r</span> <span class="id">m</span> <span class="id">t</span> <span class="id">r</span>' <span class="id">m</span>' -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context</span> <span class="id">RV</span> <span class="id">to</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">imm_safe_t</span> <span class="id">to</span> (<span class="id">C</span> <span class="id">r</span>) <span class="id">m</span><br/>
&nbsp;&nbsp;| <span class="id">imm_safe_t_callred</span>: <span class="kwd">forall</span> <span class="id">to</span> <span class="id">C</span> <span class="id">r</span> <span class="id">m</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">ty</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">callred</span> <span class="id">ge</span> <span class="id">r</span> <span class="id">m</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">ty</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context</span> <span class="id">RV</span> <span class="id">to</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">imm_safe_t</span> <span class="id">to</span> (<span class="id">C</span> <span class="id">r</span>) <span class="id">m</span>.<br/>
<br/>
<span class="kwd">Remark</span> <span class="id">imm_safe_t_imm_safe</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>, <span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> -&gt; <span class="id">imm_safe</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4209')">Proof.</div>
<div class="proofscript" id="proof4209">
&nbsp;&nbsp;<span class="tactic">induction</span> 1.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">imm_safe_lred</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">imm_safe_rred</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">imm_safe_callred</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">exprlist_all_values</span> (<span class="id">rl</span>: <span class="id">exprlist</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">rl</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Enil</span> =&gt; <span class="id">True</span><br/>
&nbsp;&nbsp;| <span class="id">Econs</span> (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>) <span class="id">rl</span>' =&gt; <span class="id">exprlist_all_values</span> <span class="id">rl</span>'<br/>
&nbsp;&nbsp;| <span class="id">Econs</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">invert_expr_prop</span> (<span class="id">a</span>: <span class="id">expr</span>) (<span class="id">m</span>: <span class="id">mem</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span> =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;| <span class="id">Evar</span> <span class="id">x</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">e</span>!<span class="id">x</span> = <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/ (<span class="id">e</span>!<span class="id">x</span> = <span class="id">None</span> /\ <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">x</span> = <span class="id">Some</span> <span class="id">b</span>)<br/>
&nbsp;&nbsp;| <span class="id">Ederef</span> (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty1</span>) <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>, <span class="id">exists</span> <span class="id">ofs</span>, <span class="id">v</span> = <span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span><br/>
&nbsp;&nbsp;| <span class="id">Efield</span> (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty1</span>) <span class="id">f</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>, <span class="id">exists</span> <span class="id">ofs</span>, <span class="id">v</span> = <span class="id">Vptr</span> <span class="id">b</span> <span class="id">ofs</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">ty1</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tstruct</span> <span class="id">id</span> <span class="id">_</span> =&gt; <span class="id">exists</span> <span class="id">co</span> <span class="id">delta</span>, <span class="id">ge</span>.(<span class="id">genv_cenv</span>)!<span class="id">id</span> = <span class="id">Some</span> <span class="id">co</span> /\ <span class="id">field_offset</span> <span class="id">ge</span> <span class="id">f</span> (<span class="id">co_members</span> <span class="id">co</span>) = <span class="id">OK</span> <span class="id">delta</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Tunion</span>  <span class="id">id</span> <span class="id">_</span> =&gt; <span class="id">exists</span> <span class="id">co</span>, <span class="id">ge</span>.(<span class="id">genv_cenv</span>)!<span class="id">id</span> = <span class="id">Some</span> <span class="id">co</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;| <span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span> =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;| <span class="id">Evalof</span> (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span>') <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ty</span>' = <span class="id">ty</span> /\ <span class="id">exists</span> <span class="id">t</span>, <span class="id">exists</span> <span class="id">v</span>, <span class="id">exists</span> <span class="id">w</span>', <span class="id">deref_loc</span> <span class="id">ge</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">t</span> <span class="id">v</span> /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'<br/>
&nbsp;&nbsp;| <span class="id">Eunop</span> <span class="id">op</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>, <span class="id">sem_unary_operation</span> <span class="id">op</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">Ebinop</span> <span class="id">op</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) (<span class="kwd">Eval</span> <span class="id">v2</span> <span class="id">ty2</span>) <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>, <span class="id">sem_binary_operation</span> <span class="id">ge</span> <span class="id">op</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">v2</span> <span class="id">ty2</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">Ecast</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>, <span class="id">sem_cast</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">ty</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">Eseqand</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>, <span class="id">bool_val</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">b</span><br/>
&nbsp;&nbsp;| <span class="id">Eseqor</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>, <span class="id">bool_val</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">b</span><br/>
&nbsp;&nbsp;| <span class="id">Econdition</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) <span class="id">r1</span> <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>, <span class="id">bool_val</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">b</span><br/>
&nbsp;&nbsp;| <span class="id">Eassign</span> (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty1</span>) (<span class="kwd">Eval</span> <span class="id">v2</span> <span class="id">ty2</span>) <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>, <span class="id">exists</span> <span class="id">m</span>', <span class="id">exists</span> <span class="id">t</span>, <span class="id">exists</span> <span class="id">w</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ty</span> = <span class="id">ty1</span> /\ <span class="id">sem_cast</span> <span class="id">v2</span> <span class="id">ty2</span> <span class="id">ty1</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">v</span> /\ <span class="id">assign_loc</span> <span class="id">ge</span> <span class="id">ty1</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span> <span class="id">t</span> <span class="id">m</span>' /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'<br/>
&nbsp;&nbsp;| <span class="id">Eassignop</span> <span class="id">op</span> (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty1</span>) (<span class="kwd">Eval</span> <span class="id">v2</span> <span class="id">ty2</span>) <span class="id">tyres</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">t</span>, <span class="id">exists</span> <span class="id">v1</span>, <span class="id">exists</span> <span class="id">w</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ty</span> = <span class="id">ty1</span> /\ <span class="id">deref_loc</span> <span class="id">ge</span> <span class="id">ty1</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">t</span> <span class="id">v1</span> /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'<br/>
&nbsp;&nbsp;| <span class="id">Epostincr</span> <span class="id">id</span> (<span class="id">Eloc</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty1</span>) <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">t</span>, <span class="id">exists</span> <span class="id">v1</span>, <span class="id">exists</span> <span class="id">w</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ty</span> = <span class="id">ty1</span> /\ <span class="id">deref_loc</span> <span class="id">ge</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">t</span> <span class="id">v1</span> /\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'<br/>
&nbsp;&nbsp;| <span class="id">Ecomma</span> (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty1</span>) <span class="id">r2</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">typeof</span> <span class="id">r2</span> = <span class="id">ty</span><br/>
&nbsp;&nbsp;| <span class="id">Eparen</span> (<span class="kwd">Eval</span> <span class="id">v1</span> <span class="id">ty1</span>) <span class="id">tycast</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>, <span class="id">sem_cast</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">tycast</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">Ecall</span> (<span class="kwd">Eval</span> <span class="id">vf</span> <span class="id">tyf</span>) <span class="id">rargs</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exprlist_all_values</span> <span class="id">rargs</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">tyargs</span> <span class="id">tyres</span> <span class="id">cconv</span> <span class="id">fd</span> <span class="id">vl</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">classify_fun</span> <span class="id">tyf</span> = <span class="id">fun_case_f</span> <span class="id">tyargs</span> <span class="id">tyres</span> <span class="id">cconv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">Genv.find_funct</span> <span class="id">ge</span> <span class="id">vf</span> = <span class="id">Some</span> <span class="id">fd</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">cast_arguments</span> <span class="id">m</span> <span class="id">rargs</span> <span class="id">tyargs</span> <span class="id">vl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">type_of_fundef</span> <span class="id">fd</span> = <span class="id">Tfunction</span> <span class="id">tyargs</span> <span class="id">tyres</span> <span class="id">cconv</span><br/>
&nbsp;&nbsp;| <span class="id">Ebuiltin</span> <span class="id">ef</span> <span class="id">tyargs</span> <span class="id">rargs</span> <span class="id">ty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exprlist_all_values</span> <span class="id">rargs</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">vargs</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>' <span class="id">w</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cast_arguments</span> <span class="id">m</span> <span class="id">rargs</span> <span class="id">tyargs</span> <span class="id">vargs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">external_call</span> <span class="id">ef</span> <span class="id">ge</span> <span class="id">vargs</span> <span class="id">m</span> <span class="id">t</span> <span class="id">vres</span> <span class="id">m</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">True</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">lred_invert</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">l</span> <span class="id">m</span> <span class="id">l</span>' <span class="id">m</span>', <span class="id">lred</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">l</span> <span class="id">m</span> <span class="id">l</span>' <span class="id">m</span>' -&gt; <span class="id">invert_expr_prop</span> <span class="id">l</span> <span class="id">m</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4210')">Proof.</div>
<div class="proofscript" id="proof4210">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="id">exists</span> <span class="id">ofs</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="id">exists</span> <span class="id">ofs</span>; <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">co</span>, <span class="id">delta</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="id">exists</span> <span class="id">ofs</span>; <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">co</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">rred_invert</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span>' <span class="id">r</span> <span class="id">m</span> <span class="id">t</span> <span class="id">r</span>' <span class="id">m</span>', <span class="id">rred</span> <span class="id">ge</span> <span class="id">r</span> <span class="id">m</span> <span class="id">t</span> <span class="id">r</span>' <span class="id">m</span>' -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt; <span class="id">invert_expr_prop</span> <span class="id">r</span> <span class="id">m</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4211')">Proof.</div>
<div class="proofscript" id="proof4211">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">auto</span>; <span class="id">exists</span> <span class="id">t</span>; <span class="id">exists</span> <span class="id">v</span>; <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">true</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">false</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">true</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">false</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">b</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>; <span class="id">exists</span> <span class="id">m</span>'; <span class="id">exists</span> <span class="id">t</span>; <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">t</span>; <span class="id">exists</span> <span class="id">v1</span>; <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">t</span>; <span class="id">exists</span> <span class="id">v1</span>; <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">v</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="id">exists</span> <span class="id">vargs</span>; <span class="id">exists</span> <span class="id">t</span>; <span class="id">exists</span> <span class="id">vres</span>; <span class="id">exists</span> <span class="id">m</span>'; <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">callred_invert</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">ty</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id">callred</span> <span class="id">ge</span> <span class="id">r</span> <span class="id">m</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">ty</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">invert_expr_prop</span> <span class="id">r</span> <span class="id">m</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4212')">Proof.</div>
<div class="proofscript" id="proof4212">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>. <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exists</span> <span class="id">tyargs</span>, <span class="id">tyres</span>, <span class="id">cconv</span>, <span class="id">fd</span>, <span class="id">args</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Scheme</span> <span class="id">context_ind2</span> := <span class="id">Minimality</span> <span class="kwd">for</span> <span class="id">context</span> <span class="kwd">Sort</span> <span class="kwd">Prop</span><br/>
&nbsp;&nbsp;<span class="kwd">with</span> <span class="id">contextlist_ind2</span> := <span class="id">Minimality</span> <span class="kwd">for</span> <span class="id">contextlist</span> <span class="kwd">Sort</span> <span class="kwd">Prop</span>.<br/>
<span class="id">Combined</span> <span class="kwd">Scheme</span> <span class="id">context_contextlist_ind</span> <span class="id">from</span> <span class="id">context_ind2</span>, <span class="id">contextlist_ind2</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">invert_expr_context</span>:<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">from</span> <span class="id">to</span> <span class="id">C</span>, <span class="id">context</span> <span class="id">from</span> <span class="id">to</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id">invert_expr_prop</span> <span class="id">a</span> <span class="id">m</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="id">invert_expr_prop</span> (<span class="id">C</span> <span class="id">a</span>) <span class="id">m</span>)<br/>
/\(<span class="kwd">forall</span> <span class="id">from</span> <span class="id">C</span>, <span class="id">contextlist</span> <span class="id">from</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id">invert_expr_prop</span> <span class="id">a</span> <span class="id">m</span> -&gt;<br/>
&nbsp;&nbsp;~<span class="id">exprlist_all_values</span> (<span class="id">C</span> <span class="id">a</span>)).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4213')">Proof.</div>
<div class="proofscript" id="proof4213">
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">context_contextlist_ind</span>; <span class="tactic">intros</span>; <span class="tactic">try</span> (<span class="id">exploit</span> <span class="id">H0</span>; [<span class="tactic">eauto</span>|<span class="tactic">intros</span>]); <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e1</span>; <span class="tactic">auto</span>; <span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e1</span>; <span class="tactic">auto</span>; <span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e1</span>; <span class="tactic">auto</span>; <span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">e1</span>; <span class="tactic">auto</span>. <span class="tactic">intros</span>. <span class="tactic">elim</span> (<span class="id">H0</span> <span class="id">a</span> <span class="id">m</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">elim</span> (<span class="id">H0</span> <span class="id">a</span> <span class="id">m</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">a</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">e1</span>; <span class="tactic">auto</span>. <span class="tactic">elim</span> (<span class="id">H0</span> <span class="id">a</span> <span class="id">m</span>); <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">imm_safe_t_inv</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Eloc</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">True</span><br/>
&nbsp;&nbsp;| <span class="kwd">Eval</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">True</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">invert_expr_prop</span> <span class="id">a</span> <span class="id">m</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4214')">Proof.</div>
<div class="proofscript" id="proof4214">
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">invert_expr_context</span> <span class="kwd">as</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">invert_expr_prop</span> (<span class="id">C</span> <span class="id">l</span>) <span class="id">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">A</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">lred_invert</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">l</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">invert_expr_prop</span> (<span class="id">C</span> <span class="id">r</span>) <span class="id">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">A</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">rred_invert</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">r</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">invert_expr_prop</span> (<span class="id">C</span> <span class="id">r</span>) <span class="id">m</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">A</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">callred_invert</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">destruct</span> (<span class="id">C</span> <span class="id">r</span>); <span class="tactic">auto</span>; <span class="id">contradiction</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Soundness: if <span class="bracket"><span class="id">step_expr</span></span> returns <span class="bracket"><span class="id">Some</span> <span class="id">ll</span></span>, then every element
  of <span class="bracket"><span class="id">ll</span></span> is a reduct. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">context_compose</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k2</span> <span class="id">k3</span> <span class="id">C2</span>, <span class="id">context</span> <span class="id">k2</span> <span class="id">k3</span> <span class="id">C2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k1</span> <span class="id">C1</span>, <span class="id">context</span> <span class="id">k1</span> <span class="id">k2</span> <span class="id">C1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">context</span> <span class="id">k1</span> <span class="id">k3</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C2</span>(<span class="id">C1</span> <span class="id">x</span>))<br/>
<span class="kwd">with</span> <span class="id">contextlist_compose</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k2</span> <span class="id">C2</span>, <span class="id">contextlist</span> <span class="id">k2</span> <span class="id">C2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k1</span> <span class="id">C1</span>, <span class="id">context</span> <span class="id">k1</span> <span class="id">k2</span> <span class="id">C1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">contextlist</span> <span class="id">k1</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C2</span>(<span class="id">C1</span> <span class="id">x</span>)).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4215')">Proof.</div>
<div class="proofscript" id="proof4215">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>; <span class="tactic">try</span> (<span class="id">constructor</span>; <span class="tactic">eauto</span>).<br/>
&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C1</span> <span class="id">x</span>) <span class="kwd">with</span> <span class="id">C1</span>. <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="tactic">extensionality</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">intros</span>; <span class="id">constructor</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Hint</span> <span class="id">Constructors</span> <span class="id">context</span> <span class="id">contextlist</span>.<br/>
<span class="kwd">Hint</span> <span class="kwd">Resolve</span> <span class="id">context_compose</span> <span class="id">contextlist_compose</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">reduction_ok</span> (<span class="id">k</span>: <span class="id">kind</span>) (<span class="id">a</span>: <span class="id">expr</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">rd</span>: <span class="id">reduction</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">k</span>, <span class="id">rd</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">LV</span>, <span class="id">Lred</span> <span class="id">_</span> <span class="id">l</span>' <span class="id">m</span>' =&gt; <span class="id">lred</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">a</span> <span class="id">m</span> <span class="id">l</span>' <span class="id">m</span>'<br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Rred</span> <span class="id">_</span> <span class="id">r</span>' <span class="id">m</span>' <span class="id">t</span> =&gt; <span class="id">rred</span> <span class="id">ge</span> <span class="id">a</span> <span class="id">m</span> <span class="id">t</span> <span class="id">r</span>' <span class="id">m</span>' /\ <span class="id">exists</span> <span class="id">w</span>', <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'<br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Callred</span> <span class="id">_</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">tyres</span> <span class="id">m</span>' =&gt; <span class="id">callred</span> <span class="id">ge</span> <span class="id">a</span> <span class="id">m</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">tyres</span> /\ <span class="id">m</span>' = <span class="id">m</span><br/>
&nbsp;&nbsp;| <span class="id">LV</span>, <span class="id">Stuckred</span> =&gt; ~<span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span><br/>
&nbsp;&nbsp;| <span class="id">RV</span>, <span class="id">Stuckred</span> =&gt; ~<span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span><br/>
&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">reducts_ok</span> (<span class="id">k</span>: <span class="id">kind</span>) (<span class="id">a</span>: <span class="id">expr</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">ll</span>: <span class="id">reducts</span> <span class="id">expr</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">C</span> <span class="id">rd</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">In</span> (<span class="id">C</span>, <span class="id">rd</span>) <span class="id">ll</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>', <span class="id">exists</span> <span class="id">k</span>', <span class="id">context</span> <span class="id">k</span>' <span class="id">k</span> <span class="id">C</span> /\ <span class="id">a</span> = <span class="id">C</span> <span class="id">a</span>' /\ <span class="id">reduction_ok</span> <span class="id">k</span>' <span class="id">a</span>' <span class="id">m</span> <span class="id">rd</span>)<br/>
&nbsp;&nbsp;/\ (<span class="id">ll</span> = <span class="id">nil</span> -&gt; <span class="kwd">match</span> <span class="id">k</span> <span class="kwd">with</span> <span class="id">LV</span> =&gt; <span class="id">is_loc</span> <span class="id">a</span> &lt;&gt; <span class="id">None</span> | <span class="id">RV</span> =&gt; <span class="id">is_val</span> <span class="id">a</span> &lt;&gt; <span class="id">None</span> <span class="kwd">end</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">list_reducts_ok</span> (<span class="id">al</span>: <span class="id">exprlist</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">ll</span>: <span class="id">reducts</span> <span class="id">exprlist</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">C</span> <span class="id">rd</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">In</span> (<span class="id">C</span>, <span class="id">rd</span>) <span class="id">ll</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>', <span class="id">exists</span> <span class="id">k</span>', <span class="id">contextlist</span> <span class="id">k</span>' <span class="id">C</span> /\ <span class="id">al</span> = <span class="id">C</span> <span class="id">a</span>' /\ <span class="id">reduction_ok</span> <span class="id">k</span>' <span class="id">a</span>' <span class="id">m</span> <span class="id">rd</span>)<br/>
&nbsp;&nbsp;/\ (<span class="id">ll</span> = <span class="id">nil</span> -&gt; <span class="id">is_val_list</span> <span class="id">al</span> &lt;&gt; <span class="id">None</span>).<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">monadInv</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| [ <span class="id">H</span>: <span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">Some</span> <span class="id">_</span> =&gt; <span class="id">_</span> | <span class="id">None</span> =&gt; <span class="id">None</span> <span class="kwd">end</span> = <span class="id">Some</span> ?<span class="id">y</span> |- <span class="id">_</span> ] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">x</span> <span class="id">eqn</span>:?; [<span class="id">monadInv</span>|<span class="tactic">discriminate</span>]<br/>
&nbsp;&nbsp;| [ <span class="id">H</span>: <span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">left</span> <span class="id">_</span> =&gt; <span class="id">_</span> | <span class="id">right</span> <span class="id">_</span> =&gt; <span class="id">None</span> <span class="kwd">end</span> = <span class="id">Some</span> ?<span class="id">y</span> |- <span class="id">_</span> ] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">x</span>; [<span class="id">monadInv</span>|<span class="tactic">discriminate</span>]<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">idtac</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">sem_cast_arguments_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">m</span> <span class="id">rargs</span> <span class="id">vtl</span> <span class="id">tyargs</span> <span class="id">vargs</span>,<br/>
&nbsp;&nbsp;<span class="id">is_val_list</span> <span class="id">rargs</span> = <span class="id">Some</span> <span class="id">vtl</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">sem_cast_arguments</span> <span class="id">vtl</span> <span class="id">tyargs</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">vargs</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">cast_arguments</span> <span class="id">m</span> <span class="id">rargs</span> <span class="id">tyargs</span> <span class="id">vargs</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4216')">Proof.</div>
<div class="proofscript" id="proof4216">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">rargs</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>. <span class="tactic">destruct</span> <span class="id">tyargs</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H0</span>; <span class="id">inv</span> <span class="id">H0</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span>. <span class="id">inv</span> <span class="id">H</span>. <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">destruct</span> <span class="id">p</span> <span class="kwd">as</span> [<span class="id">v1</span> <span class="id">t1</span>]. <span class="tactic">destruct</span> <span class="id">tyargs</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="id">monadInv</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>). <span class="id">constructor</span>. <span class="tactic">auto</span>. <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">sem_cast_arguments_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">m</span> <span class="id">al</span> <span class="id">tyl</span> <span class="id">vl</span>,<br/>
&nbsp;&nbsp;<span class="id">cast_arguments</span> <span class="id">m</span> <span class="id">al</span> <span class="id">tyl</span> <span class="id">vl</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">vtl</span>, <span class="id">is_val_list</span> <span class="id">al</span> = <span class="id">Some</span> <span class="id">vtl</span> /\ <span class="id">sem_cast_arguments</span> <span class="id">vtl</span> <span class="id">tyl</span> <span class="id">m</span> = <span class="id">Some</span> <span class="id">vl</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4217')">Proof.</div>
<div class="proofscript" id="proof4217">
&nbsp;&nbsp;<span class="tactic">induction</span> 1.<br/>
&nbsp;&nbsp;<span class="id">exists</span> (@<span class="id">nil</span> (<span class="id">val</span> * <span class="id">type</span>)); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">IHcast_arguments</span> <span class="kwd">as</span> [<span class="id">vtl</span> [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> ((<span class="id">v</span>, <span class="id">ty</span>) :: <span class="id">vtl</span>); <span class="tactic">simpl</span>. <span class="tactic">rewrite</span> <span class="id">A</span>; <span class="tactic">rewrite</span> <span class="id">B</span>; <span class="tactic">rewrite</span> <span class="id">H</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">topred_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> <span class="id">rd</span>,<br/>
&nbsp;&nbsp;<span class="id">reduction_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> <span class="id">rd</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> (<span class="id">topred</span> <span class="id">rd</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4218')">Proof.</div>
<div class="proofscript" id="proof4218">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">topred</span>; <span class="tactic">split</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">try</span> <span class="id">contradiction</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="id">exists</span> <span class="id">a</span>; <span class="id">exists</span> <span class="id">k</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">stuck_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;~<span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> <span class="id">stuck</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4219')">Proof.</div>
<div class="proofscript" id="proof4219">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">stuck</span>; <span class="tactic">split</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">try</span> <span class="id">contradiction</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="id">exists</span> <span class="id">a</span>; <span class="id">exists</span> <span class="id">k</span>; <span class="tactic">intuition</span>. <span class="tactic">red</span>. <span class="tactic">destruct</span> <span class="id">k</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">wrong_kind_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id">k</span> &lt;&gt; <span class="id">Cstrategy.expr_kind</span> <span class="id">a</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> <span class="id">stuck</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4220')">Proof.</div>
<div class="proofscript" id="proof4220">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">stuck_ok</span>. <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">Cstrategy.imm_safe_kind</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">imm_safe_t_imm_safe</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">not_invert_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Eloc</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;| <span class="kwd">Eval</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">invert_expr_prop</span> <span class="id">a</span> <span class="id">m</span> -&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> <span class="id">stuck</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4221')">Proof.</div>
<div class="proofscript" id="proof4221">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">stuck_ok</span>. <span class="tactic">red</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">imm_safe_t_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">incontext_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> <span class="id">C</span> <span class="id">res</span> <span class="id">k</span>' <span class="id">a</span>',<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k</span>' <span class="id">a</span>' <span class="id">m</span> <span class="id">res</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">a</span> = <span class="id">C</span> <span class="id">a</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">context</span> <span class="id">k</span>' <span class="id">k</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">k</span>' <span class="kwd">with</span> <span class="id">LV</span> =&gt; <span class="id">is_loc</span> <span class="id">a</span>' = <span class="id">None</span> | <span class="id">RV</span> =&gt; <span class="id">is_val</span> <span class="id">a</span>' = <span class="id">None</span> <span class="kwd">end</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> (<span class="id">incontext</span> <span class="id">C</span> <span class="id">res</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4222')">Proof.</div>
<div class="proofscript" id="proof4222">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_ok</span>, <span class="id">incontext</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C1</span> <span class="id">rd1</span>] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">context_compose</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">res</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="tactic">destruct</span> <span class="id">k</span>'; <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">incontext2_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> <span class="id">k1</span> <span class="id">a1</span> <span class="id">res1</span> <span class="id">k2</span> <span class="id">a2</span> <span class="id">res2</span> <span class="id">C1</span> <span class="id">C2</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k1</span> <span class="id">a1</span> <span class="id">m</span> <span class="id">res1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k2</span> <span class="id">a2</span> <span class="id">m</span> <span class="id">res2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">a</span> = <span class="id">C1</span> <span class="id">a1</span> -&gt; <span class="id">a</span> = <span class="id">C2</span> <span class="id">a2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">context</span> <span class="id">k1</span> <span class="id">k</span> <span class="id">C1</span> -&gt; <span class="id">context</span> <span class="id">k2</span> <span class="id">k</span> <span class="id">C2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">k1</span> <span class="kwd">with</span> <span class="id">LV</span> =&gt; <span class="id">is_loc</span> <span class="id">a1</span> = <span class="id">None</span> | <span class="id">RV</span> =&gt; <span class="id">is_val</span> <span class="id">a1</span> = <span class="id">None</span> <span class="kwd">end</span><br/>
&nbsp;&nbsp;\/ <span class="kwd">match</span> <span class="id">k2</span> <span class="kwd">with</span> <span class="id">LV</span> =&gt; <span class="id">is_loc</span> <span class="id">a2</span> = <span class="id">None</span> | <span class="id">RV</span> =&gt; <span class="id">is_val</span> <span class="id">a2</span> = <span class="id">None</span> <span class="kwd">end</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> (<span class="id">incontext2</span> <span class="id">C1</span> <span class="id">res1</span> <span class="id">C2</span> <span class="id">res2</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4223')">Proof.</div>
<div class="proofscript" id="proof4223">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_ok</span>, <span class="id">incontext2</span>, <span class="id">incontext</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>; <span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">in_app_or</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H8</span>).<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C</span>' <span class="id">rd</span>'] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">context_compose</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C</span>' <span class="id">rd</span>'] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H0</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">context_compose</span>; <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">H2</span>; <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">res1</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H8</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="tactic">destruct</span> <span class="id">res2</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H8</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H5</span>. <span class="tactic">destruct</span> <span class="id">k1</span>; <span class="tactic">intuition</span> <span class="tactic">congruence</span>. <span class="tactic">destruct</span> <span class="id">k2</span>; <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">incontext_list_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ef</span> <span class="id">tyargs</span> <span class="id">al</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">res</span>,<br/>
&nbsp;&nbsp;<span class="id">list_reducts_ok</span> <span class="id">al</span> <span class="id">m</span> <span class="id">res</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">is_val_list</span> <span class="id">al</span> = <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">RV</span> (<span class="id">Ebuiltin</span> <span class="id">ef</span> <span class="id">tyargs</span> <span class="id">al</span> <span class="id">ty</span>) <span class="id">m</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">incontext</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ebuiltin</span> <span class="id">ef</span> <span class="id">tyargs</span> <span class="id">x</span> <span class="id">ty</span>) <span class="id">res</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4224')">Proof.</div>
<div class="proofscript" id="proof4224">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_ok</span>, <span class="id">incontext</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C1</span> <span class="id">rd1</span>] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">res</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H2</span>. <span class="tactic">elim</span> <span class="id">H1</span>; <span class="tactic">auto</span>. <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">incontext2_list_ok</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a1</span> <span class="id">a2</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">res1</span> <span class="id">res2</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">RV</span> <span class="id">a1</span> <span class="id">m</span> <span class="id">res1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">list_reducts_ok</span> <span class="id">a2</span> <span class="id">m</span> <span class="id">res2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">is_val</span> <span class="id">a1</span> = <span class="id">None</span> \/ <span class="id">is_val_list</span> <span class="id">a2</span> = <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">RV</span> (<span class="id">Ecall</span> <span class="id">a1</span> <span class="id">a2</span> <span class="id">ty</span>) <span class="id">m</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">incontext2</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecall</span> <span class="id">x</span> <span class="id">a2</span> <span class="id">ty</span>) <span class="id">res1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecall</span> <span class="id">a1</span> <span class="id">x</span> <span class="id">ty</span>) <span class="id">res2</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4225')">Proof.</div>
<div class="proofscript" id="proof4225">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_ok</span>, <span class="id">incontext2</span>, <span class="id">incontext</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">H</span>; <span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">in_app_or</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H4</span>).<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C</span>' <span class="id">rd</span>'] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C</span>' <span class="id">rd</span>'] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H0</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">res1</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="tactic">destruct</span> <span class="id">res2</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H4</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">tauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">incontext2_list_ok</span>':<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a1</span> <span class="id">a2</span> <span class="id">m</span> <span class="id">res1</span> <span class="id">res2</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_ok</span> <span class="id">RV</span> <span class="id">a1</span> <span class="id">m</span> <span class="id">res1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">list_reducts_ok</span> <span class="id">a2</span> <span class="id">m</span> <span class="id">res2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">list_reducts_ok</span> (<span class="id">Econs</span> <span class="id">a1</span> <span class="id">a2</span>) <span class="id">m</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">incontext2</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econs</span> <span class="id">x</span> <span class="id">a2</span>) <span class="id">res1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econs</span> <span class="id">a1</span> <span class="id">x</span>) <span class="id">res2</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4226')">Proof.</div>
<div class="proofscript" id="proof4226">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_ok</span>, <span class="id">list_reducts_ok</span>, <span class="id">incontext2</span>, <span class="id">incontext</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H</span>; <span class="tactic">destruct</span> <span class="id">H0</span>. <span class="tactic">split</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">in_app_or</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H3</span>).<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C</span>' <span class="id">rd</span>'] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C</span>' <span class="id">rd</span>'] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="id">inv</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H0</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>'' [<span class="id">k</span>'' [<span class="id">U</span> [<span class="id">V</span> <span class="id">W</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">a</span>''; <span class="id">exists</span> <span class="id">k</span>''. <span class="tactic">split</span>. <span class="tactic">eauto</span>. <span class="tactic">rewrite</span> <span class="id">V</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">res1</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H3</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="tactic">destruct</span> <span class="id">res2</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H3</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a1</span>). <span class="tactic">destruct</span> (<span class="id">is_val_list</span> <span class="id">a2</span>). <span class="tactic">congruence</span>. <span class="tactic">intuition</span> <span class="tactic">congruence</span>. <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">is_val_list_all_values</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">al</span> <span class="id">vtl</span>, <span class="id">is_val_list</span> <span class="id">al</span> = <span class="id">Some</span> <span class="id">vtl</span> -&gt; <span class="id">exprlist_all_values</span> <span class="id">al</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4227')">Proof.</div>
<div class="proofscript" id="proof4227">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">al</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">r1</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>]|] <span class="id">eqn</span>:?; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val_list</span> <span class="id">al</span>) <span class="kwd">as</span> [<span class="id">vtl</span>'|] <span class="id">eqn</span>:?; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>). <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Ltac</span> <span class="id">myinv</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| [ <span class="id">H</span>: <span class="id">False</span> |- <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| [ <span class="id">H</span>: <span class="id">_</span> /\ <span class="id">_</span> |- <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">H</span>; <span class="id">myinv</span><br/>
&nbsp;&nbsp;| [ <span class="id">H</span>: <span class="id">exists</span> <span class="id">_</span>, <span class="id">_</span> |- <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">H</span>; <span class="id">myinv</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">idtac</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Theorem</span> <span class="id">step_expr_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">k</span> <span class="id">m</span>, <span class="id">reducts_ok</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> (<span class="id">step_expr</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>)<br/>
<span class="kwd">with</span> <span class="id">step_exprlist_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">al</span> <span class="id">m</span>, <span class="id">list_reducts_ok</span> <span class="id">al</span> <span class="id">m</span> (<span class="id">step_exprlist</span> <span class="id">al</span> <span class="id">m</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4228')">Proof with</div>
<div class="proofscript" id="proof4228">
 (<span class="tactic">try</span> (<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intro</span>; <span class="id">myinv</span>; <span class="tactic">intuition</span> <span class="tactic">congruence</span>; <span class="tactic">fail</span>)).<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">a</span>; <span class="tactic">intros</span>; <span class="tactic">simpl</span>; <span class="tactic">destruct</span> <span class="id">k</span>; <span class="tactic">try</span> (<span class="tactic">apply</span> <span class="id">wrong_kind_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">congruence</span>).<br/>
&nbsp;Eval&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">intros</span>. <span class="tactic">tauto</span>. <span class="tactic">simpl</span>; <span class="tactic">congruence</span>.<br/>
&nbsp;Evar&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">e</span>!<span class="id">x</span>) <span class="kwd">as</span> [[<span class="id">b</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">type_eq</span> <span class="id">ty</span> <span class="id">ty</span>')...<br/>
&nbsp;&nbsp;<span class="tactic">subst</span>. <span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">red_var_local</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">x</span>) <span class="kwd">as</span> [<span class="id">b</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">red_var_global</span>; <span class="tactic">auto</span>.<br/>
&nbsp;Efield&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">v</span>...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">ty</span>'...<br/>
&nbsp;top&nbsp;struct&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">ge</span>.(<span class="id">genv_cenv</span>)!<span class="id">i0</span>) <span class="kwd">as</span> [<span class="id">co</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">field_offset</span> <span class="id">ge</span> <span class="id">f</span> (<span class="id">co_members</span> <span class="id">co</span>)) <span class="kwd">as</span> [<span class="id">delta</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id">red_field_struct</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;top&nbsp;union&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">ge</span>.(<span class="id">genv_cenv</span>)!<span class="id">i0</span>) <span class="kwd">as</span> [<span class="id">co</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id">red_field_union</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;in&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;Evalof&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> <span class="id">a</span>) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_loc_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">type_eq</span> <span class="id">ty</span> <span class="id">ty</span>')... <span class="tactic">subst</span> <span class="id">ty</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span>) <span class="kwd">as</span> [[[<span class="id">w</span>' <span class="id">t</span>] <span class="id">v</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_deref_loc_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">red</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_rvalof</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">exploit</span> <span class="id">do_deref_loc_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;Ederef&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">v</span>... <span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">red_deref</span>; <span class="tactic">auto</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;Eaddrof&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> <span class="id">a</span>) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_loc_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_addrof</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;unop&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">sem_unary_operation</span> <span class="id">op</span> <span class="id">v</span> <span class="id">ty</span>' <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>'|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_unop</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;binop&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a1</span>) <span class="kwd">as</span> [[<span class="id">v1</span> <span class="id">ty1</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a2</span>) <span class="kwd">as</span> [[<span class="id">v2</span> <span class="id">ty2</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>). <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo0</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">sem_binary_operation</span> <span class="id">ge</span> <span class="id">op</span> <span class="id">v1</span> <span class="id">ty1</span> <span class="id">v2</span> <span class="id">ty2</span> <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_binop</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;cast&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">sem_cast</span> <span class="id">v</span> <span class="id">ty</span>' <span class="id">ty</span> <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>'|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_cast</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;seqand&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a1</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">bool_val</span> <span class="id">v</span> <span class="id">ty</span>' <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>'|] <span class="id">eqn</span>:?... <span class="tactic">destruct</span> <span class="id">v</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">red_seqand_true</span>; <span class="tactic">eauto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">red_seqand_false</span>; <span class="tactic">eauto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;seqor&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a1</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">bool_val</span> <span class="id">v</span> <span class="id">ty</span>' <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>'|] <span class="id">eqn</span>:?... <span class="tactic">destruct</span> <span class="id">v</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">red_seqor_true</span>; <span class="tactic">eauto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">red_seqor_false</span>; <span class="tactic">eauto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;condition&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a1</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">bool_val</span> <span class="id">v</span> <span class="id">ty</span>' <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>'|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">eapply</span> <span class="id">red_condition</span>; <span class="tactic">eauto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;sizeof&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_sizeof</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;alignof&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_alignof</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;assign&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> <span class="id">a1</span>) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty1</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a2</span>) <span class="kwd">as</span> [[<span class="id">v2</span> <span class="id">ty2</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_loc_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>). <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo0</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">type_eq</span> <span class="id">ty1</span> <span class="id">ty</span>)... <span class="tactic">subst</span> <span class="id">ty1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">sem_cast</span> <span class="id">v2</span> <span class="id">ty2</span> <span class="id">ty</span> <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">do_assign_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">v</span>) <span class="kwd">as</span> [[[<span class="id">w</span>' <span class="id">t</span>] <span class="id">m</span>']|] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_assign_loc_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">P</span> <span class="id">Q</span>].<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_assign</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">exploit</span> <span class="id">do_assign_loc_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;assignop&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> <span class="id">a1</span>) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty1</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a2</span>) <span class="kwd">as</span> [[<span class="id">v2</span> <span class="id">ty2</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_loc_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>). <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo0</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">type_eq</span> <span class="id">ty1</span> <span class="id">ty</span>)... <span class="tactic">subst</span> <span class="id">ty1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span>) <span class="kwd">as</span> [[[<span class="id">w</span>' <span class="id">t</span>] <span class="id">v</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_deref_loc_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">red</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_assignop</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">exploit</span> <span class="id">do_deref_loc_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;postincr&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> <span class="id">a</span>) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_loc_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">type_eq</span> <span class="id">ty</span>' <span class="id">ty</span>)... <span class="tactic">subst</span> <span class="id">ty</span>'.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">do_deref_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span>) <span class="kwd">as</span> [[[<span class="id">w</span>' <span class="id">t</span>] <span class="id">v</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_deref_loc_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">red</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_postincr</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">exploit</span> <span class="id">do_deref_loc_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;comma&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a1</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">type_eq</span> (<span class="id">typeof</span> <span class="id">a2</span>) <span class="id">ty</span>)... <span class="tactic">subst</span> <span class="id">ty</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_comma</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;call&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a</span>) <span class="kwd">as</span> [[<span class="id">vf</span> <span class="id">tyf</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val_list</span> <span class="id">rargs</span>) <span class="kwd">as</span> [<span class="id">vtl</span> | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>). <span class="id">exploit</span> <span class="id">is_val_list_all_values</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">ALLVAL</span>.<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">classify_fun</span> <span class="id">tyf</span>) <span class="kwd">as</span> [<span class="id">tyargs</span> <span class="id">tyres</span> <span class="id">cconv</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">Genv.find_funct</span> <span class="id">ge</span> <span class="id">vf</span>) <span class="kwd">as</span> [<span class="id">fd</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">sem_cast_arguments</span> <span class="id">vtl</span> <span class="id">tyargs</span> <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">vargs</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">type_eq</span> (<span class="id">type_of_fundef</span> <span class="id">fd</span>) (<span class="id">Tfunction</span> <span class="id">tyargs</span> <span class="id">tyres</span> <span class="id">cconv</span>))...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">red</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id">red_call</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sem_cast_arguments_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">ALLVAL</span>). <span class="id">myinv</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">ALLVAL</span>). <span class="id">myinv</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">sem_cast_arguments_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">vtl</span>' [<span class="id">P</span> <span class="id">Q</span>]]. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">ALLVAL</span>). <span class="id">myinv</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">ALLVAL</span>). <span class="id">myinv</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_list_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_list_ok</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;builtin&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val_list</span> <span class="id">rargs</span>) <span class="kwd">as</span> [<span class="id">vtl</span> | ] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">is_val_list_all_values</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">ALLVAL</span>.<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">sem_cast_arguments</span> <span class="id">vtl</span> <span class="id">tyargs</span> <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">vargs</span>|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">do_external</span> <span class="id">ef</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span>) <span class="kwd">as</span> [[[[? ?] <span class="id">v</span>] <span class="id">m</span>'] | ] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_ef_external_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">EC</span> <span class="id">PT</span>].<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">red</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">eapply</span> <span class="id">red_builtin</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">sem_cast_arguments_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">w0</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">ALLVAL</span>). <span class="id">myinv</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">x</span> = <span class="id">vargs</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">sem_cast_arguments_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">vtl</span>' [<span class="id">A</span> <span class="id">B</span>]]. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">x</span>. <span class="id">exploit</span> <span class="id">do_ef_external_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">not_invert_ok</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>; <span class="id">myinv</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">ALLVAL</span>). <span class="id">myinv</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">sem_cast_arguments_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">vtl</span>' [<span class="id">A</span> <span class="id">B</span>]]. <span class="tactic">congruence</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_list_ok</span>; <span class="tactic">eauto</span>.<br/>
<br/>
&nbsp;loc&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">intros</span>. <span class="tactic">tauto</span>. <span class="tactic">simpl</span>; <span class="tactic">congruence</span>.<br/>
&nbsp;paren&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">a</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>'] | ] <span class="id">eqn</span>:?. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">sem_cast</span> <span class="id">v</span> <span class="id">ty</span>' <span class="id">tycast</span> <span class="id">m</span>) <span class="kwd">as</span> [<span class="id">v</span>'|] <span class="id">eqn</span>:?...<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">topred_ok</span>; <span class="tactic">auto</span>. <span class="tactic">split</span>. <span class="tactic">apply</span> <span class="id">red_paren</span>; <span class="tactic">auto</span>. <span class="id">exists</span> <span class="id">w</span>; <span class="id">constructor</span>.<br/>
&nbsp;depth&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext_ok</span>; <span class="tactic">eauto</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">al</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;nil&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">split</span>; <span class="tactic">intros</span>. <span class="tactic">tauto</span>. <span class="tactic">simpl</span>; <span class="tactic">congruence</span>.<br/>
&nbsp;cons&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">incontext2_list_ok</span>'; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">step_exprlist_val_list</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">m</span> <span class="id">al</span>, <span class="id">is_val_list</span> <span class="id">al</span> &lt;&gt; <span class="id">None</span> -&gt; <span class="id">step_exprlist</span> <span class="id">al</span> <span class="id">m</span> = <span class="id">nil</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4229')">Proof.</div>
<div class="proofscript" id="proof4229">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">al</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">r1</span>) <span class="kwd">as</span> [[<span class="id">v1</span> <span class="id">ty1</span>]|] <span class="id">eqn</span>:?; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val_list</span> <span class="id">al</span>) <span class="id">eqn</span>:?; <span class="tactic">try</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">IHal</span>. <span class="tactic">auto</span>. <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Completeness part 1: <span class="bracket"><span class="id">step_expr</span></span> contains all possible non-error reducts. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">lred_topred</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">l1</span> <span class="id">m1</span> <span class="id">l2</span> <span class="id">m2</span>,<br/>
&nbsp;&nbsp;<span class="id">lred</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">l1</span> <span class="id">m1</span> <span class="id">l2</span> <span class="id">m2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">rule</span>, <span class="id">step_expr</span> <span class="id">LV</span> <span class="id">l1</span> <span class="id">m1</span> = <span class="id">topred</span> (<span class="id">Lred</span> <span class="id">rule</span> <span class="id">l2</span> <span class="id">m2</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4230')">Proof.</div>
<div class="proofscript" id="proof4230">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>.<br/>
&nbsp;var&nbsp;local&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;var&nbsp;global&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">rewrite</span> <span class="id">H0</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;deref&nbsp;*)</span>&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;field&nbsp;struct&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>, <span class="id">H0</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;field&nbsp;union&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">rred_topred</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span>' <span class="id">r1</span> <span class="id">m1</span> <span class="id">t</span> <span class="id">r2</span> <span class="id">m2</span>,<br/>
&nbsp;&nbsp;<span class="id">rred</span> <span class="id">ge</span> <span class="id">r1</span> <span class="id">m1</span> <span class="id">t</span> <span class="id">r2</span> <span class="id">m2</span> -&gt; <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">rule</span>, <span class="id">step_expr</span> <span class="id">RV</span> <span class="id">r1</span> <span class="id">m1</span> = <span class="id">topred</span> (<span class="id">Rred</span> <span class="id">rule</span> <span class="id">r2</span> <span class="id">m2</span> <span class="id">t</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4231')">Proof.</div>
<div class="proofscript" id="proof4231">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;valof&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">do_deref_loc_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span> <span class="id">H0</span>). <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;addrof&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;unop&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;binop&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;cast&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;seqand&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;seqor&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;condition&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;sizeof&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;alignof&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;assign&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="tactic">rewrite</span> <span class="id">H</span>. <span class="tactic">rewrite</span> (<span class="id">do_assign_loc_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H0</span> <span class="id">H1</span>).<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;assignop&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="tactic">rewrite</span> (<span class="id">do_deref_loc_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span> <span class="id">H0</span>).<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;postincr&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="tactic">subst</span>. <span class="tactic">rewrite</span> (<span class="id">do_deref_loc_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span> <span class="id">H1</span>).<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;comma&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;paren&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;builtin&nbsp;*)</span>&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">sem_cast_arguments_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">vtl</span> [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_ef_external_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> <span class="id">C</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">A</span>. <span class="tactic">rewrite</span> <span class="id">B</span>. <span class="tactic">rewrite</span> <span class="id">C</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">callred_topred</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">ty</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id">callred</span> <span class="id">ge</span> <span class="id">a</span> <span class="id">m</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">ty</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">rule</span>, <span class="id">step_expr</span> <span class="id">RV</span> <span class="id">a</span> <span class="id">m</span> = <span class="id">topred</span> (<span class="id">Callred</span> <span class="id">rule</span> <span class="id">fd</span> <span class="id">args</span> <span class="id">ty</span> <span class="id">m</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4232')">Proof.</div>
<div class="proofscript" id="proof4232">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H2</span>. <span class="id">exploit</span> <span class="id">sem_cast_arguments_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">vtl</span> [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">A</span>; <span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">rewrite</span> <span class="id">B</span>; <span class="tactic">rewrite</span> <span class="id">H1</span>; <span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Definition</span> <span class="id">reducts_incl</span> {<span class="id">A</span> <span class="id">B</span>: <span class="kwd">Type</span>} (<span class="id">C</span>: <span class="id">A</span> -&gt; <span class="id">B</span>) (<span class="id">res1</span>: <span class="id">reducts</span> <span class="id">A</span>) (<span class="id">res2</span>: <span class="id">reducts</span> <span class="id">B</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">C1</span> <span class="id">rd</span>, <span class="id">In</span> (<span class="id">C1</span>, <span class="id">rd</span>) <span class="id">res1</span> -&gt; <span class="id">In</span> ((<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C</span>(<span class="id">C1</span> <span class="id">x</span>)), <span class="id">rd</span>) <span class="id">res2</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_trans</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A1</span> <span class="id">A2</span>: <span class="kwd">Type</span>) (<span class="id">C</span>: <span class="id">A1</span> -&gt; <span class="id">A2</span>) <span class="id">res1</span> <span class="id">res2</span>, <span class="id">reducts_incl</span> <span class="id">C</span> <span class="id">res1</span> <span class="id">res2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A3</span>: <span class="kwd">Type</span>) (<span class="id">C</span>': <span class="id">A2</span> -&gt; <span class="id">A3</span>) <span class="id">res3</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_incl</span> <span class="id">C</span>' <span class="id">res2</span> <span class="id">res3</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">reducts_incl</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C</span>'(<span class="id">C</span> <span class="id">x</span>)) <span class="id">res1</span> <span class="id">res3</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4233')">Proof.</div>
<div class="proofscript" id="proof4233">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_incl</span>; <span class="tactic">intros</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_nil</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span> <span class="id">B</span>: <span class="kwd">Type</span>) (<span class="id">C</span>: <span class="id">A</span> -&gt; <span class="id">B</span>) <span class="id">res</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_incl</span> <span class="id">C</span> <span class="id">nil</span> <span class="id">res</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4234')">Proof.</div>
<div class="proofscript" id="proof4234">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>. <span class="tactic">intros</span>; <span class="id">contradiction</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_val</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span>: <span class="kwd">Type</span>) <span class="id">a</span> <span class="id">m</span> <span class="id">v</span> <span class="id">ty</span> (<span class="id">C</span>: <span class="id">expr</span> -&gt; <span class="id">A</span>) <span class="id">res</span>,<br/>
&nbsp;&nbsp;<span class="id">is_val</span> <span class="id">a</span> = <span class="id">Some</span>(<span class="id">v</span>, <span class="id">ty</span>) -&gt; <span class="id">reducts_incl</span> <span class="id">C</span> (<span class="id">step_expr</span> <span class="id">RV</span> <span class="id">a</span> <span class="id">m</span>) <span class="id">res</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4235')">Proof.</div>
<div class="proofscript" id="proof4235">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span>). <span class="tactic">apply</span> <span class="id">reducts_incl_nil</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_loc</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span>: <span class="kwd">Type</span>) <span class="id">a</span> <span class="id">m</span> <span class="id">b</span> <span class="id">ofs</span> <span class="id">ty</span> (<span class="id">C</span>: <span class="id">expr</span> -&gt; <span class="id">A</span>) <span class="id">res</span>,<br/>
&nbsp;&nbsp;<span class="id">is_loc</span> <span class="id">a</span> = <span class="id">Some</span>(<span class="id">b</span>, <span class="id">ofs</span>, <span class="id">ty</span>) -&gt; <span class="id">reducts_incl</span> <span class="id">C</span> (<span class="id">step_expr</span> <span class="id">LV</span> <span class="id">a</span> <span class="id">m</span>) <span class="id">res</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4236')">Proof.</div>
<div class="proofscript" id="proof4236">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> (<span class="id">is_loc_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span>). <span class="tactic">apply</span> <span class="id">reducts_incl_nil</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_listval</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span>: <span class="kwd">Type</span>) <span class="id">a</span> <span class="id">m</span> <span class="id">vtl</span> (<span class="id">C</span>: <span class="id">exprlist</span> -&gt; <span class="id">A</span>) <span class="id">res</span>,<br/>
&nbsp;&nbsp;<span class="id">is_val_list</span> <span class="id">a</span> = <span class="id">Some</span> <span class="id">vtl</span> -&gt; <span class="id">reducts_incl</span> <span class="id">C</span> (<span class="id">step_exprlist</span> <span class="id">a</span> <span class="id">m</span>) <span class="id">res</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4237')">Proof.</div>
<div class="proofscript" id="proof4237">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">step_exprlist_val_list</span>. <span class="tactic">apply</span> <span class="id">reducts_incl_nil</span>. <span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_incontext</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span> <span class="id">B</span>: <span class="kwd">Type</span>) (<span class="id">C</span>: <span class="id">A</span> -&gt; <span class="id">B</span>) <span class="id">res</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_incl</span> <span class="id">C</span> <span class="id">res</span> (<span class="id">incontext</span> <span class="id">C</span> <span class="id">res</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4238')">Proof.</div>
<div class="proofscript" id="proof4238">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_incl</span>, <span class="id">incontext</span>. <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">f</span> := <span class="kwd">fun</span> <span class="id">z</span> : (<span class="id">expr</span> -&gt; <span class="id">A</span>) * <span class="id">reduction</span> =&gt; (<span class="kwd">fun</span> <span class="id">x</span> : <span class="id">expr</span> =&gt; <span class="id">C</span> (<span class="id">fst</span> <span class="id">z</span> <span class="id">x</span>), <span class="id">snd</span> <span class="id">z</span>)).<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">In</span> (<span class="id">f</span> (<span class="id">C1</span>, <span class="id">rd</span>)) (<span class="id">map</span> <span class="id">f</span> <span class="id">res</span>)). <span class="tactic">apply</span> <span class="id">in_map</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_incontext2_left</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A1</span> <span class="id">A2</span> <span class="id">B</span>: <span class="kwd">Type</span>) (<span class="id">C1</span>: <span class="id">A1</span> -&gt; <span class="id">B</span>) <span class="id">res1</span> (<span class="id">C2</span>: <span class="id">A2</span> -&gt; <span class="id">B</span>) <span class="id">res2</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_incl</span> <span class="id">C1</span> <span class="id">res1</span> (<span class="id">incontext2</span> <span class="id">C1</span> <span class="id">res1</span> <span class="id">C2</span> <span class="id">res2</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4239')">Proof.</div>
<div class="proofscript" id="proof4239">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_incl</span>, <span class="id">incontext2</span>, <span class="id">incontext</span>. <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">in_app_iff</span>. <span class="id">left</span>.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">f</span> := <span class="kwd">fun</span> <span class="id">z</span> : (<span class="id">expr</span> -&gt; <span class="id">A1</span>) * <span class="id">reduction</span> =&gt; (<span class="kwd">fun</span> <span class="id">x</span> : <span class="id">expr</span> =&gt; <span class="id">C1</span> (<span class="id">fst</span> <span class="id">z</span> <span class="id">x</span>), <span class="id">snd</span> <span class="id">z</span>)).<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">In</span> (<span class="id">f</span> (<span class="id">C0</span>, <span class="id">rd</span>)) (<span class="id">map</span> <span class="id">f</span> <span class="id">res1</span>)). <span class="tactic">apply</span> <span class="id">in_map</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">reducts_incl_incontext2_right</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A1</span> <span class="id">A2</span> <span class="id">B</span>: <span class="kwd">Type</span>) (<span class="id">C1</span>: <span class="id">A1</span> -&gt; <span class="id">B</span>) <span class="id">res1</span> (<span class="id">C2</span>: <span class="id">A2</span> -&gt; <span class="id">B</span>) <span class="id">res2</span>,<br/>
&nbsp;&nbsp;<span class="id">reducts_incl</span> <span class="id">C2</span> <span class="id">res2</span> (<span class="id">incontext2</span> <span class="id">C1</span> <span class="id">res1</span> <span class="id">C2</span> <span class="id">res2</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4240')">Proof.</div>
<div class="proofscript" id="proof4240">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">reducts_incl</span>, <span class="id">incontext2</span>, <span class="id">incontext</span>. <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">in_app_iff</span>. <span class="id">right</span>.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">f</span> := <span class="kwd">fun</span> <span class="id">z</span> : (<span class="id">expr</span> -&gt; <span class="id">A2</span>) * <span class="id">reduction</span> =&gt; (<span class="kwd">fun</span> <span class="id">x</span> : <span class="id">expr</span> =&gt; <span class="id">C2</span> (<span class="id">fst</span> <span class="id">z</span> <span class="id">x</span>), <span class="id">snd</span> <span class="id">z</span>)).<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">In</span> (<span class="id">f</span> (<span class="id">C0</span>, <span class="id">rd</span>)) (<span class="id">map</span> <span class="id">f</span> <span class="id">res2</span>)). <span class="tactic">apply</span> <span class="id">in_map</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Hint</span> <span class="kwd">Resolve</span> <span class="id">reducts_incl_val</span> <span class="id">reducts_incl_loc</span> <span class="id">reducts_incl_listval</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reducts_incl_incontext</span> <span class="id">reducts_incl_incontext2_left</span> <span class="id">reducts_incl_incontext2_right</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">step_expr_context</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">from</span> <span class="id">to</span> <span class="id">C</span>, <span class="id">context</span> <span class="id">from</span> <span class="id">to</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">m</span>, <span class="id">reducts_incl</span> <span class="id">C</span> (<span class="id">step_expr</span> <span class="id">from</span> <span class="id">a</span> <span class="id">m</span>) (<span class="id">step_expr</span> <span class="id">to</span> (<span class="id">C</span> <span class="id">a</span>) <span class="id">m</span>)<br/>
<span class="kwd">with</span> <span class="id">step_exprlist_context</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">from</span> <span class="id">C</span>, <span class="id">contextlist</span> <span class="id">from</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">a</span> <span class="id">m</span>, <span class="id">reducts_incl</span> <span class="id">C</span> (<span class="id">step_expr</span> <span class="id">from</span> <span class="id">a</span> <span class="id">m</span>) (<span class="id">step_exprlist</span> (<span class="id">C</span> <span class="id">a</span>) <span class="id">m</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4241')">Proof.</div>
<div class="proofscript" id="proof4241">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;top&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">red</span>. <span class="tactic">destruct</span> (<span class="id">step_expr</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">try</span> <span class="comment">(*&nbsp;no&nbsp;eta&nbsp;in&nbsp;8.3&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;(<span class="tactic">intros</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C1</span> <span class="id">x</span>) <span class="kwd">with</span> <span class="id">C1</span> <span class="tactic">by</span> (<span class="tactic">apply</span> <span class="tactic">extensionality</span>; <span class="tactic">auto</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">auto</span>).<br/>
&nbsp;deref&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ederef</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;field&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Efield</span> <span class="id">x</span> <span class="id">f</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;valof&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Evalof</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;addrof&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eaddrof</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;unop&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eunop</span> <span class="id">op</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;binop&nbsp;left&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ebinop</span> <span class="id">op</span> <span class="id">x</span> <span class="id">e2</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;binop&nbsp;right&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ebinop</span> <span class="id">op</span> <span class="id">e1</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">e1</span>) <span class="kwd">as</span> [[<span class="id">v1</span> <span class="id">ty1</span>]|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v2</span> <span class="id">ty2</span>]|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;cast&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecast</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;seqand&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eseqand</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;seqor&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eseqor</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;condition&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econdition</span> <span class="id">x</span> <span class="id">r2</span> <span class="id">r3</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;assign&nbsp;left&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassign</span> <span class="id">x</span> <span class="id">e2</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;assign&nbsp;right&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassign</span> <span class="id">e1</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> <span class="id">e1</span>) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty1</span>]|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v2</span> <span class="id">ty2</span>]|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;assignop&nbsp;left&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassignop</span> <span class="id">op</span> <span class="id">x</span> <span class="id">e2</span> <span class="id">tyres</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;assignop&nbsp;right&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eassignop</span> <span class="id">op</span> <span class="id">e1</span> <span class="id">x</span> <span class="id">tyres</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> <span class="id">e1</span>) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty1</span>]|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v2</span> <span class="id">ty2</span>]|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;postincr&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Epostincr</span> <span class="id">id</span> <span class="id">x</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_loc</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[[<span class="id">b</span> <span class="id">ofs</span>] <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;call&nbsp;left&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecall</span> <span class="id">x</span> <span class="id">el</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;call&nbsp;right&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecall</span> <span class="id">e1</span> <span class="id">x</span> <span class="id">ty</span>). <span class="tactic">apply</span> <span class="id">step_exprlist_context</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">e1</span>) <span class="kwd">as</span> [[<span class="id">v1</span> <span class="id">ty1</span>]|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val_list</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [<span class="id">vl</span>|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;builtin&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ebuiltin</span> <span class="id">ef</span> <span class="id">tyargs</span> <span class="id">x</span> <span class="id">ty</span>). <span class="tactic">apply</span> <span class="id">step_exprlist_context</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val_list</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [<span class="id">vl</span>|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;comma&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Ecomma</span> <span class="id">x</span> <span class="id">e2</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
&nbsp;paren&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Eparen</span> <span class="id">x</span> <span class="id">tycast</span> <span class="id">ty</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> (<span class="id">C</span> <span class="id">a</span>)) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>']|] <span class="id">eqn</span>:?; <span class="tactic">eauto</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;cons&nbsp;left&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econs</span> <span class="id">x</span> <span class="id">el</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">step_expr_context</span>; <span class="tactic">eauto</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;binop&nbsp;right&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">reducts_incl_trans</span> <span class="kwd">with</span> (<span class="id">C</span>' := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">Econs</span> <span class="id">e1</span> <span class="id">x</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">step_exprlist_context</span>; <span class="tactic">eauto</span>. <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Completeness part 2: if we can reduce to <span class="bracket"><span class="id">Stuckstate</span></span>, <span class="bracket"><span class="id">step_expr</span></span>
    contains at least one <span class="bracket"><span class="id">Stuckred</span></span> reduction. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">not_stuckred_imm_safe</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">m</span> <span class="id">a</span> <span class="id">k</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">C</span>, ~<span class="id">In</span> (<span class="id">C</span>, <span class="id">Stuckred</span>) (<span class="id">step_expr</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>)) -&gt; <span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4242')">Proof.</div>
<div class="proofscript" id="proof4242">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">generalize</span> (<span class="id">step_expr_sound</span> <span class="id">a</span> <span class="id">k</span> <span class="id">m</span>). <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>].<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">step_expr</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>) <span class="kwd">as</span> [|[<span class="id">C</span> <span class="id">rd</span>] <span class="id">res</span>] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">B</span> (<span class="id">refl_equal</span> <span class="id">_</span>)). <span class="tactic">destruct</span> <span class="id">k</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">B</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">B</span>; <span class="tactic">try</span> <span class="tactic">congruence</span>. <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">NOTSTUCK</span>: <span class="id">rd</span> &lt;&gt; <span class="id">Stuckred</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">elim</span> (<span class="id">H</span> <span class="id">C</span>); <span class="tactic">subst</span> <span class="id">rd</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">coqlib</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">A</span>. <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">coqlib</span>. <span class="tactic">intros</span> [<span class="id">a</span>' [<span class="id">k</span>' [<span class="id">P</span> [<span class="id">Q</span> <span class="id">R</span>]]]].<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">k</span>'; <span class="tactic">destruct</span> <span class="id">rd</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">R</span>; <span class="tactic">intuition</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">a</span>. <span class="tactic">eapply</span> <span class="id">imm_safe_t_lred</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">a</span>. <span class="tactic">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> [<span class="id">w</span>' <span class="id">PT</span>]. <span class="tactic">eapply</span> <span class="id">imm_safe_t_rred</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span>. <span class="tactic">eapply</span> <span class="id">imm_safe_t_callred</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">not_imm_safe_stuck_red</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">m</span> <span class="id">a</span> <span class="id">k</span> <span class="id">C</span>,<br/>
&nbsp;&nbsp;<span class="id">context</span> <span class="id">k</span> <span class="id">RV</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;~<span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">C</span>', <span class="id">In</span> (<span class="id">C</span>', <span class="id">Stuckred</span>) (<span class="id">step_expr</span> <span class="id">RV</span> (<span class="id">C</span> <span class="id">a</span>) <span class="id">m</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4243')">Proof.</div>
<div class="proofscript" id="proof4243">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">exists</span> <span class="id">C</span>', <span class="id">In</span> (<span class="id">C</span>', <span class="id">Stuckred</span>) (<span class="id">step_expr</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">classic</span> (<span class="id">exists</span> <span class="id">C</span>', <span class="id">In</span> (<span class="id">C</span>', <span class="id">Stuckred</span>) (<span class="id">step_expr</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>))); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">elim</span> <span class="id">H0</span>. <span class="tactic">apply</span> <span class="id">not_stuckred_imm_safe</span>. <span class="tactic">apply</span> <span class="id">not_ex_all_not</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> [<span class="id">C</span>' <span class="id">IN</span>].<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">step_expr_context</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span> <span class="id">a</span> <span class="id">m</span>). <span class="tactic">unfold</span> <span class="id">reducts_incl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intro</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; (<span class="id">C</span> (<span class="id">C</span>' <span class="id">x</span>))). <span class="tactic">apply</span> <span class="id">H1</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Connections between <span class="bracket"><span class="id">imm_safe_t</span></span> and <span class="bracket"><span class="id">imm_safe</span></span> </div>
<br/>
<span class="kwd">Lemma</span> <span class="id">imm_safe_imm_safe_t</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span>,<br/>
&nbsp;&nbsp;<span class="id">imm_safe</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">imm_safe_t</span> <span class="id">k</span> <span class="id">a</span> <span class="id">m</span> \/<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">C</span>, <span class="id">exists</span> <span class="id">a1</span>, <span class="id">exists</span> <span class="id">t</span>, <span class="id">exists</span> <span class="id">a1</span>', <span class="id">exists</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context</span> <span class="id">RV</span> <span class="id">k</span> <span class="id">C</span> /\ <span class="id">a</span> = <span class="id">C</span> <span class="id">a1</span> /\ <span class="id">rred</span> <span class="id">ge</span> <span class="id">a1</span> <span class="id">m</span> <span class="id">t</span> <span class="id">a1</span>' <span class="id">m</span>' /\ <span class="kwd">forall</span> <span class="id">w</span>', ~<span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4244')">Proof.</div>
<div class="proofscript" id="proof4244">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">apply</span> <span class="id">imm_safe_t_val</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">apply</span> <span class="id">imm_safe_t_loc</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">eapply</span> <span class="id">imm_safe_t_lred</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">classic</span> (<span class="id">exists</span> <span class="id">w</span>', <span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>')) <span class="kwd">as</span> [[<span class="id">w</span>' <span class="id">A</span>] | <span class="id">A</span>].<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">eapply</span> <span class="id">imm_safe_t_rred</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="id">exists</span> <span class="id">C</span>; <span class="id">exists</span> <span class="id">e0</span>; <span class="id">exists</span> <span class="id">t</span>; <span class="id">exists</span> <span class="id">e</span>'; <span class="id">exists</span> <span class="id">m</span>'; <span class="tactic">intuition</span>. <span class="tactic">apply</span> <span class="id">A</span>; <span class="id">exists</span> <span class="id">w</span>'; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">eapply</span> <span class="id">imm_safe_t_callred</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">A state can "crash the world" if it can make an observable transition
  whose trace is not accepted by the external world. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">can_crash_world</span> (<span class="id">w</span>: <span class="id">world</span>) (<span class="id">S</span>: <span class="id">state</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">t</span>, <span class="id">exists</span> <span class="id">S</span>', <span class="id">Csem.step</span> <span class="id">ge</span> <span class="id">S</span> <span class="id">t</span> <span class="id">S</span>' /\ <span class="kwd">forall</span> <span class="id">w</span>', ~<span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>'.<br/>
<br/>
<span class="kwd">Theorem</span> <span class="id">not_imm_safe_t</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">K</span> <span class="id">C</span> <span class="id">a</span> <span class="id">m</span> <span class="id">f</span> <span class="id">k</span>,<br/>
&nbsp;&nbsp;<span class="id">context</span> <span class="id">K</span> <span class="id">RV</span> <span class="id">C</span> -&gt;<br/>
&nbsp;&nbsp;~<span class="id">imm_safe_t</span> <span class="id">K</span> <span class="id">a</span> <span class="id">m</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Csem.step</span> <span class="id">ge</span> (<span class="id">ExprState</span> <span class="id">f</span> (<span class="id">C</span> <span class="id">a</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>) <span class="id">E0</span> <span class="id">Stuckstate</span> \/ <span class="id">can_crash_world</span> <span class="id">w</span> (<span class="id">ExprState</span> <span class="id">f</span> (<span class="id">C</span> <span class="id">a</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4245')">Proof.</div>
<div class="proofscript" id="proof4245">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">classic</span> (<span class="id">imm_safe</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">K</span> <span class="id">a</span> <span class="id">m</span>)).<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">imm_safe_imm_safe_t</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> [<span class="id">A</span> | [<span class="id">C1</span> [<span class="id">a1</span> [<span class="id">t</span> [<span class="id">a1</span>' [<span class="id">m</span>' [<span class="id">A</span> [<span class="id">B</span> [<span class="id">D</span> <span class="id">E</span>]]]]]]]]]. <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="tactic">red</span>. <span class="id">exists</span> <span class="id">t</span>; <span class="id">econstructor</span>; <span class="tactic">split</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">rewrite</span> <span class="id">B</span>. <span class="tactic">eapply</span> <span class="id">step_rred</span> <span class="kwd">with</span> (<span class="id">C</span> := <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C</span>(<span class="id">C1</span> <span class="id">x</span>)). <span class="tactic">eauto</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="id">left</span>. <span class="tactic">eapply</span> <span class="id">step_stuck</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">EXPRS</span>.<br/>
<br/>
<h1> Transitions over states. </h1>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">do_alloc_variables</span> (<span class="id">e</span>: <span class="id">env</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">l</span>: <span class="id">list</span> (<span class="id">ident</span> * <span class="id">type</span>)) {<span class="kwd">struct</span> <span class="id">l</span>} : <span class="id">env</span> * <span class="id">mem</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">nil</span> =&gt; (<span class="id">e</span>,<span class="id">m</span>)<br/>
&nbsp;&nbsp;| (<span class="id">id</span>, <span class="id">ty</span>) :: <span class="id">l</span>' =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">m1</span>,<span class="id">b1</span>) := <span class="id">Mem.alloc</span> <span class="id">m</span> 0 (<span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">do_alloc_variables</span> (<span class="id">PTree.set</span> <span class="id">id</span> (<span class="id">b1</span>, <span class="id">ty</span>) <span class="id">e</span>) <span class="id">m1</span> <span class="id">l</span>'<br/>
<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_alloc_variables_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">l</span> <span class="id">e</span> <span class="id">m</span>, <span class="id">alloc_variables</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> (<span class="id">fst</span> (<span class="id">do_alloc_variables</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span>)) (<span class="id">snd</span> (<span class="id">do_alloc_variables</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span>)).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4246')">Proof.</div>
<div class="proofscript" id="proof4246">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l</span>; <span class="tactic">intros</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [<span class="id">id</span> <span class="id">ty</span>]. <span class="tactic">destruct</span> (<span class="id">Mem.alloc</span> <span class="id">m</span> 0 (<span class="id">sizeof</span> <span class="id">ge</span> <span class="id">ty</span>)) <span class="kwd">as</span> [<span class="id">m1</span> <span class="id">b1</span>] <span class="id">eqn</span>:?; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">do_alloc_variables_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">e1</span> <span class="id">m1</span> <span class="id">l</span> <span class="id">e2</span> <span class="id">m2</span>, <span class="id">alloc_variables</span> <span class="id">ge</span> <span class="id">e1</span> <span class="id">m1</span> <span class="id">l</span> <span class="id">e2</span> <span class="id">m2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">do_alloc_variables</span> <span class="id">e1</span> <span class="id">m1</span> <span class="id">l</span> = (<span class="id">e2</span>, <span class="id">m2</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4247')">Proof.</div>
<div class="proofscript" id="proof4247">
&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>; <span class="tactic">rewrite</span> <span class="id">IHalloc_variables</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="id">Function</span> <span class="id">sem_bind_parameters</span> (<span class="id">w</span>: <span class="id">world</span>) (<span class="id">e</span>: <span class="id">env</span>) (<span class="id">m</span>: <span class="id">mem</span>) (<span class="id">l</span>: <span class="id">list</span> (<span class="id">ident</span> * <span class="id">type</span>)) (<span class="id">lv</span>: <span class="id">list</span> <span class="id">val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="kwd">struct</span> <span class="id">l</span>} : <span class="id">option</span> <span class="id">mem</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">l</span>, <span class="id">lv</span>  <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">nil</span>, <span class="id">nil</span> =&gt; <span class="id">Some</span> <span class="id">m</span><br/>
&nbsp;&nbsp;| (<span class="id">id</span>, <span class="id">ty</span>) :: <span class="id">params</span>, <span class="id">v1</span>::<span class="id">lv</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">PTree.get</span> <span class="id">id</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">b</span>, <span class="id">ty</span>') =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> (<span class="id">type_eq</span> <span class="id">ty</span> <span class="id">ty</span>');<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span>', <span class="id">t</span>, <span class="id">m1</span> &lt;- <span class="id">do_assign_loc</span> <span class="id">w</span> <span class="id">ty</span> <span class="id">m</span> <span class="id">b</span> <span class="id">Ptrofs.zero</span> <span class="id">v1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t</span> <span class="kwd">with</span> <span class="id">nil</span> =&gt; <span class="id">sem_bind_parameters</span> <span class="id">w</span> <span class="id">e</span> <span class="id">m1</span> <span class="id">params</span> <span class="id">lv</span> | <span class="id">_</span> =&gt; <span class="id">None</span> <span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">None</span><br/>
<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">sem_bind_parameters_sound</span> : <span class="kwd">forall</span> <span class="id">w</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> <span class="id">lv</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">sem_bind_parameters</span> <span class="id">w</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> <span class="id">lv</span> = <span class="id">Some</span> <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">bind_parameters</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> <span class="id">lv</span> <span class="id">m</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4248')">Proof.</div>
<div class="proofscript" id="proof4248">
&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="id">functional</span> <span class="tactic">induction</span> (<span class="id">sem_bind_parameters</span> <span class="id">w</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> <span class="id">lv</span>); <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H</span>; <span class="id">constructor</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_assign_loc_sound</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">sem_bind_parameters_complete</span> : <span class="kwd">forall</span> <span class="id">w</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> <span class="id">lv</span> <span class="id">m</span>',<br/>
&nbsp;&nbsp;<span class="id">bind_parameters</span> <span class="id">ge</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> <span class="id">lv</span> <span class="id">m</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">sem_bind_parameters</span> <span class="id">w</span> <span class="id">e</span> <span class="id">m</span> <span class="id">l</span> <span class="id">lv</span> = <span class="id">Some</span> <span class="id">m</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4249')">Proof.</div>
<div class="proofscript" id="proof4249">
&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id">dec_eq_true</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">possible_trace</span> <span class="id">w</span> <span class="id">E0</span> <span class="id">w</span>) <span class="tactic">by</span> <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">do_assign_loc_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H0</span> <span class="id">H2</span>).<br/>
&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Inductive</span> <span class="id">transition</span> : <span class="kwd">Type</span> := <span class="id">TR</span> (<span class="id">rule</span>: <span class="id">string</span>) (<span class="id">t</span>: <span class="id">trace</span>) (<span class="id">S</span>': <span class="id">state</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">expr_final_state</span> (<span class="id">f</span>: <span class="id">function</span>) (<span class="id">k</span>: <span class="id">cont</span>) (<span class="id">e</span>: <span class="id">env</span>) (<span class="id">C_rd</span>: (<span class="id">expr</span> -&gt; <span class="id">expr</span>) * <span class="id">reduction</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">snd</span> <span class="id">C_rd</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Lred</span> <span class="id">rule</span> <span class="id">a</span> <span class="id">m</span> =&gt; <span class="id">TR</span> <span class="id">rule</span> <span class="id">E0</span> (<span class="id">ExprState</span> <span class="id">f</span> (<span class="id">fst</span> <span class="id">C_rd</span> <span class="id">a</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">Rred</span> <span class="id">rule</span> <span class="id">a</span> <span class="id">m</span> <span class="id">t</span> =&gt; <span class="id">TR</span> <span class="id">rule</span> <span class="id">t</span> (<span class="id">ExprState</span> <span class="id">f</span> (<span class="id">fst</span> <span class="id">C_rd</span> <span class="id">a</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">Callred</span> <span class="id">rule</span> <span class="id">fd</span> <span class="id">vargs</span> <span class="id">ty</span> <span class="id">m</span> =&gt; <span class="id">TR</span> <span class="id">rule</span> <span class="id">E0</span> (<span class="id">Callstate</span> <span class="id">fd</span> <span class="id">vargs</span> (<span class="id">Kcall</span> <span class="id">f</span> <span class="id">e</span> (<span class="id">fst</span> <span class="id">C_rd</span>) <span class="id">ty</span> <span class="id">k</span>) <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">Stuckred</span> =&gt; <span class="id">TR</span> "<span class="id">step_stuck</span>" <span class="id">E0</span> <span class="id">Stuckstate</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">list_monad_scope</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">ret</span> (<span class="id">rule</span>: <span class="id">string</span>) (<span class="id">S</span>: <span class="id">state</span>) : <span class="id">list</span> <span class="id">transition</span> :=<br/>
&nbsp;&nbsp;<span class="id">TR</span> <span class="id">rule</span> <span class="id">E0</span> <span class="id">S</span> :: <span class="id">nil</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_step</span> (<span class="id">w</span>: <span class="id">world</span>) (<span class="id">s</span>: <span class="id">state</span>) : <span class="id">list</span> <span class="id">transition</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">s</span> <span class="kwd">with</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">ExprState</span> <span class="id">f</span> <span class="id">a</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">is_val</span> <span class="id">a</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">v</span>, <span class="id">ty</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">k</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Kdo</span> <span class="id">k</span> =&gt; <span class="id">ret</span> "<span class="id">step_do_2</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> )<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Kifthenelse</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">bool_val</span> <span class="id">v</span> <span class="id">ty</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_ifthenelse_2</span>" (<span class="id">State</span> <span class="id">f</span> (<span class="kwd">if</span> <span class="id">b</span> <span class="kwd">then</span> <span class="id">s1</span> <span class="kwd">else</span> <span class="id">s2</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Kwhile1</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">bool_val</span> <span class="id">v</span> <span class="id">ty</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">ret</span> "<span class="id">step_while_true</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">s</span> (<span class="id">Kwhile2</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">ret</span> "<span class="id">step_while_false</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Kdowhile2</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">bool_val</span> <span class="id">v</span> <span class="id">ty</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">ret</span> "<span class="id">step_dowhile_true</span>" (<span class="id">State</span> <span class="id">f</span> (<span class="id">Sdowhile</span> <span class="id">x</span> <span class="id">s</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">ret</span> "<span class="id">step_dowhile_false</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Kfor2</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">bool_val</span> <span class="id">v</span> <span class="id">ty</span> <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">ret</span> "<span class="id">step_for_true</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">s</span> (<span class="id">Kfor3</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">ret</span> "<span class="id">step_for_false</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Kreturn</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">v</span>' &lt;- <span class="id">sem_cast</span> <span class="id">v</span> <span class="id">ty</span> <span class="id">f</span>.(<span class="id">fn_return</span>) <span class="id">m</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.free_list</span> <span class="id">m</span> (<span class="id">blocks_of_env</span> <span class="id">ge</span> <span class="id">e</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_return_2</span>" (<span class="id">Returnstate</span> <span class="id">v</span>' (<span class="id">call_cont</span> <span class="id">k</span>) <span class="id">m</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Kswitch1</span> <span class="id">sl</span> <span class="id">k</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">n</span> &lt;- <span class="id">sem_switch_arg</span> <span class="id">v</span> <span class="id">ty</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_expr_switch</span>" (<span class="id">State</span> <span class="id">f</span> (<span class="id">seq_of_labeled_statement</span> (<span class="id">select_switch</span> <span class="id">n</span> <span class="id">sl</span>)) (<span class="id">Kswitch2</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">map</span> (<span class="id">expr_final_state</span> <span class="id">f</span> <span class="id">k</span> <span class="id">e</span>) (<span class="id">step_expr</span> <span class="id">e</span> <span class="id">w</span> <span class="id">RV</span> <span class="id">a</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sdo</span> <span class="id">x</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_do_1</span>" (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">x</span> (<span class="id">Kdo</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Ssequence</span> <span class="id">s1</span> <span class="id">s2</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_seq</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">s1</span> (<span class="id">Kseq</span> <span class="id">s2</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> (<span class="id">Kseq</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_skip_seq</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">s</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Scontinue</span> (<span class="id">Kseq</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_continue_seq</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Scontinue</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Sbreak</span> (<span class="id">Kseq</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_break_seq</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sbreak</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sifthenelse</span> <span class="id">a</span> <span class="id">s1</span> <span class="id">s2</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_ifthenelse_1</span>" (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">a</span> (<span class="id">Kifthenelse</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Swhile</span> <span class="id">x</span> <span class="id">s</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_while</span>" (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">x</span> (<span class="id">Kwhile1</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sskip</span>|<span class="id">Scontinue</span>) (<span class="id">Kwhile2</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_skip_or_continue_while</span>" (<span class="id">State</span> <span class="id">f</span> (<span class="id">Swhile</span> <span class="id">x</span> <span class="id">s</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Sbreak</span> (<span class="id">Kwhile2</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_break_while</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sdowhile</span> <span class="id">a</span> <span class="id">s</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_dowhile</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">s</span> (<span class="id">Kdowhile1</span> <span class="id">a</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sskip</span>|<span class="id">Scontinue</span>) (<span class="id">Kdowhile1</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_skip_or_continue_dowhile</span>" (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">x</span> (<span class="id">Kdowhile2</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Sbreak</span> (<span class="id">Kdowhile1</span> <span class="id">x</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_break_dowhile</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sfor</span> <span class="id">a1</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">is_skip</span> <span class="id">a1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">then</span> <span class="id">ret</span> "<span class="id">step_for</span>" (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">a2</span> (<span class="id">Kfor2</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span> <span class="id">ret</span> "<span class="id">step_for_start</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">a1</span> (<span class="id">Kseq</span> (<span class="id">Sfor</span> <span class="id">Sskip</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span>) <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sskip</span>|<span class="id">Scontinue</span>) (<span class="id">Kfor3</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_skip_or_continue_for3</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">a3</span> (<span class="id">Kfor4</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Sbreak</span> (<span class="id">Kfor3</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_break_for3</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> (<span class="id">Kfor4</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_skip_for4</span>" (<span class="id">State</span> <span class="id">f</span> (<span class="id">Sfor</span> <span class="id">Sskip</span> <span class="id">a2</span> <span class="id">a3</span> <span class="id">s</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sreturn</span> <span class="id">None</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.free_list</span> <span class="id">m</span> (<span class="id">blocks_of_env</span> <span class="id">ge</span> <span class="id">e</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_return_0</span>" (<span class="id">Returnstate</span> <span class="id">Vundef</span> (<span class="id">call_cont</span> <span class="id">k</span>) <span class="id">m</span>')<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sreturn</span> (<span class="id">Some</span> <span class="id">x</span>)) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_return_1</span>" (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">x</span> (<span class="id">Kreturn</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> ((<span class="id">Kstop</span> | <span class="id">Kcall</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) <span class="kwd">as</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m</span>' &lt;- <span class="id">Mem.free_list</span> <span class="id">m</span> (<span class="id">blocks_of_env</span> <span class="id">ge</span> <span class="id">e</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_skip_call</span>" (<span class="id">Returnstate</span> <span class="id">Vundef</span> <span class="id">k</span> <span class="id">m</span>')<br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sswitch</span> <span class="id">x</span> <span class="id">sl</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_switch</span>" (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">x</span> (<span class="id">Kswitch1</span> <span class="id">sl</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sskip</span>|<span class="id">Sbreak</span>) (<span class="id">Kswitch2</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_skip_break_switch</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Sskip</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> <span class="id">Scontinue</span> (<span class="id">Kswitch2</span> <span class="id">k</span>) <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_continue_switch</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">Scontinue</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Slabel</span> <span class="id">lbl</span> <span class="id">s</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_label</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">s</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;| <span class="id">State</span> <span class="id">f</span> (<span class="id">Sgoto</span> <span class="id">lbl</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">find_label</span> <span class="id">lbl</span> <span class="id">f</span>.(<span class="id">fn_body</span>) (<span class="id">call_cont</span> <span class="id">k</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">s</span>', <span class="id">k</span>') =&gt; <span class="id">ret</span> "<span class="id">step_goto</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">s</span>' <span class="id">k</span>' <span class="id">e</span> <span class="id">m</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">Callstate</span> (<span class="id">Internal</span> <span class="id">f</span>) <span class="id">vargs</span> <span class="id">k</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">check</span> (<span class="id">list_norepet_dec</span> <span class="id">ident_eq</span> (<span class="id">var_names</span> (<span class="id">fn_params</span> <span class="id">f</span>) ++ <span class="id">var_names</span> (<span class="id">fn_vars</span> <span class="id">f</span>)));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> (<span class="id">e</span>,<span class="id">m1</span>) := <span class="id">do_alloc_variables</span> <span class="id">empty_env</span> <span class="id">m</span> (<span class="id">f</span>.(<span class="id">fn_params</span>) ++ <span class="id">f</span>.(<span class="id">fn_vars</span>)) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m2</span> &lt;- <span class="id">sem_bind_parameters</span> <span class="id">w</span> <span class="id">e</span> <span class="id">m1</span> <span class="id">f</span>.(<span class="id">fn_params</span>) <span class="id">vargs</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_internal_function</span>" (<span class="id">State</span> <span class="id">f</span> <span class="id">f</span>.(<span class="id">fn_body</span>) <span class="id">k</span> <span class="id">e</span> <span class="id">m2</span>)<br/>
&nbsp;&nbsp;| <span class="id">Callstate</span> (<span class="id">External</span> <span class="id">ef</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">vargs</span> <span class="id">k</span> <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">do_external</span> <span class="id">ef</span> <span class="id">w</span> <span class="id">vargs</span> <span class="id">m</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span>(<span class="id">w</span>',<span class="id">t</span>,<span class="id">v</span>,<span class="id">m</span>') =&gt; <span class="id">TR</span> "<span class="id">step_external_function</span>" <span class="id">t</span> (<span class="id">Returnstate</span> <span class="id">v</span> <span class="id">k</span> <span class="id">m</span>') :: <span class="id">nil</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">Returnstate</span> <span class="id">v</span> (<span class="id">Kcall</span> <span class="id">f</span> <span class="id">e</span> <span class="id">C</span> <span class="id">ty</span> <span class="id">k</span>) <span class="id">m</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ret</span> "<span class="id">step_returnstate</span>" (<span class="id">ExprState</span> <span class="id">f</span> (<span class="id">C</span> (<span class="kwd">Eval</span> <span class="id">v</span> <span class="id">ty</span>)) <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">nil</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">myinv</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| [ |- <span class="id">In</span> <span class="id">_</span> <span class="id">nil</span> -&gt; <span class="id">_</span> ] =&gt; <span class="kwd">let</span> <span class="id">X</span> := <span class="tactic">fresh</span> "<span class="id">X</span>" <span class="kwd">in</span> <span class="tactic">intro</span> <span class="id">X</span>; <span class="tactic">elim</span> <span class="id">X</span><br/>
&nbsp;&nbsp;| [ |- <span class="id">In</span> <span class="id">_</span> (<span class="id">ret</span> <span class="id">_</span> <span class="id">_</span>) -&gt; <span class="id">_</span> ] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">X</span> := <span class="tactic">fresh</span> "<span class="id">X</span>" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intro</span> <span class="id">X</span>; <span class="tactic">elim</span> <span class="id">X</span>; <span class="tactic">clear</span> <span class="id">X</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="kwd">let</span> <span class="id">EQ</span> := <span class="tactic">fresh</span> "<span class="id">EQ</span>" <span class="kwd">in</span> <span class="tactic">intro</span> <span class="id">EQ</span>; <span class="tactic">unfold</span> <span class="id">ret</span> <span class="kwd">in</span> <span class="id">EQ</span>; <span class="id">inv</span> <span class="id">EQ</span>; <span class="id">myinv</span> | <span class="id">myinv</span>]<br/>
&nbsp;&nbsp;| [ |- <span class="id">In</span> <span class="id">_</span> (<span class="id">_</span> :: <span class="id">nil</span>) -&gt; <span class="id">_</span> ] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">X</span> := <span class="tactic">fresh</span> "<span class="id">X</span>" <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intro</span> <span class="id">X</span>; <span class="tactic">elim</span> <span class="id">X</span>; <span class="tactic">clear</span> <span class="id">X</span>; [<span class="kwd">let</span> <span class="id">EQ</span> := <span class="tactic">fresh</span> "<span class="id">EQ</span>" <span class="kwd">in</span> <span class="tactic">intro</span> <span class="id">EQ</span>; <span class="id">inv</span> <span class="id">EQ</span>; <span class="id">myinv</span> | <span class="id">myinv</span>]<br/>
&nbsp;&nbsp;| [ |- <span class="id">In</span> <span class="id">_</span> (<span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">Some</span> <span class="id">_</span> =&gt; <span class="id">_</span> | <span class="id">None</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>) -&gt; <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">x</span> <span class="id">eqn</span>:?; <span class="id">myinv</span><br/>
&nbsp;&nbsp;| [ |- <span class="id">In</span> <span class="id">_</span> (<span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">false</span> =&gt; <span class="id">_</span> | <span class="id">true</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>) -&gt; <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">x</span> <span class="id">eqn</span>:?; <span class="id">myinv</span><br/>
&nbsp;&nbsp;| [ |- <span class="id">In</span> <span class="id">_</span> (<span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">left</span> <span class="id">_</span> =&gt; <span class="id">_</span> | <span class="id">right</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>) -&gt; <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">x</span>; <span class="id">myinv</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">idtac</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Hint</span> <span class="kwd">Extern</span> 3 =&gt; <span class="tactic">exact</span> <span class="id">I</span>.<br/>
<br/>
<span class="kwd">Theorem</span> <span class="id">do_step_sound</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">S</span> <span class="id">rule</span> <span class="id">t</span> <span class="id">S</span>',<br/>
&nbsp;&nbsp;<span class="id">In</span> (<span class="id">TR</span> <span class="id">rule</span> <span class="id">t</span> <span class="id">S</span>') (<span class="id">do_step</span> <span class="id">w</span> <span class="id">S</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Csem.step</span> <span class="id">ge</span> <span class="id">S</span> <span class="id">t</span> <span class="id">S</span>' \/ (<span class="id">t</span> = <span class="id">E0</span> /\ <span class="id">S</span>' = <span class="id">Stuckstate</span> /\ <span class="id">can_crash_world</span> <span class="id">w</span> <span class="id">S</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4250')">Proof with</div>
<div class="proofscript" id="proof4250">
 <span class="tactic">try</span> (<span class="id">left</span>; <span class="id">right</span>; <span class="id">econstructor</span>; <span class="tactic">eauto</span>; <span class="tactic">fail</span>).<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">S</span>'. <span class="tactic">destruct</span> <span class="id">S</span>; <span class="tactic">simpl</span>.<br/>
&nbsp;State&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">s</span>; <span class="id">myinv</span>...<br/>
&nbsp;skip&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">k</span>; <span class="id">myinv</span>...<br/>
&nbsp;break&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">k</span>; <span class="id">myinv</span>...<br/>
&nbsp;continue&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">k</span>; <span class="id">myinv</span>...<br/>
&nbsp;goto&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span> <span class="kwd">as</span> [<span class="id">s</span>' <span class="id">k</span>']. <span class="id">myinv</span>...<br/>
&nbsp;ExprState&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">is_val</span> <span class="id">r</span>) <span class="kwd">as</span> [[<span class="id">v</span> <span class="id">ty</span>]|] <span class="id">eqn</span>:?.<br/>
&nbsp;expression&nbsp;is&nbsp;a&nbsp;value&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">is_val_inv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Heqo</span>).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">k</span>; <span class="id">myinv</span>...<br/>
&nbsp;expression&nbsp;reduces&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [[<span class="id">C</span> <span class="id">rd</span>] [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id">step_expr_sound</span> <span class="id">e</span> <span class="id">w</span> <span class="id">r</span> <span class="id">RV</span> <span class="id">m</span>). <span class="tactic">unfold</span> <span class="id">reducts_ok</span>. <span class="tactic">intros</span> [<span class="id">P</span> <span class="id">Q</span>].<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">P</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">a</span>' [<span class="id">k</span>' [<span class="id">CTX</span> [<span class="id">EQ</span> <span class="id">RD</span>]]]].<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">expr_final_state</span> <span class="kwd">in</span> <span class="id">A</span>. <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">A</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">k</span>'; <span class="tactic">destruct</span> <span class="id">rd</span>; <span class="id">inv</span> <span class="id">A</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">RD</span>; <span class="tactic">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;lred&nbsp;*)</span>&nbsp;&nbsp;<span class="id">left</span>; <span class="id">left</span>; <span class="tactic">apply</span> <span class="id">step_lred</span>; <span class="tactic">auto</span>.<br/>
&nbsp;stuck&nbsp;lred&nbsp;*)</span>&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">not_imm_safe_t</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">R</span> | <span class="id">R</span>]; <span class="tactic">eauto</span>.<br/>
&nbsp;rred&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">RD</span>. <span class="id">left</span>; <span class="id">left</span>; <span class="tactic">apply</span> <span class="id">step_rred</span>; <span class="tactic">auto</span>.<br/>
&nbsp;callred&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">RD</span>; <span class="tactic">subst</span> <span class="id">m</span>'. <span class="id">left</span>; <span class="id">left</span>; <span class="tactic">apply</span> <span class="id">step_call</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;stuck&nbsp;rred&nbsp;*)</span>&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">not_imm_safe_t</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">R</span> | <span class="id">R</span>]; <span class="tactic">eauto</span>.<br/>
&nbsp;callstate&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">fd</span>; <span class="id">myinv</span>.<br/>
&nbsp;internal&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">do_alloc_variables</span> <span class="id">empty_env</span> <span class="id">m</span> (<span class="id">fn_params</span> <span class="id">f</span> ++ <span class="id">fn_vars</span> <span class="id">f</span>)) <span class="kwd">as</span> [<span class="id">e</span> <span class="id">m1</span>] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="id">myinv</span>. <span class="id">left</span>; <span class="id">right</span>; <span class="tactic">apply</span> <span class="id">step_internal_function</span> <span class="kwd">with</span> <span class="id">m1</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> <span class="id">e</span> <span class="kwd">with</span> (<span class="id">fst</span> (<span class="id">e</span>,<span class="id">m1</span>)). <span class="id">change</span> <span class="id">m1</span> <span class="kwd">with</span> (<span class="id">snd</span> (<span class="id">e</span>,<span class="id">m1</span>)) <span class="tactic">at</span> 2. <span class="tactic">rewrite</span> &lt;- <span class="id">Heqp</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">do_alloc_variables_sound</span>. <span class="tactic">eapply</span> <span class="id">sem_bind_parameters_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;external&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">p</span> <span class="kwd">as</span> [[[<span class="id">w</span>' <span class="id">tr</span>] <span class="id">v</span>] <span class="id">m</span>']. <span class="id">myinv</span>. <span class="id">left</span>; <span class="id">right</span>; <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">do_ef_external_sound</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;returnstate&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">k</span>; <span class="id">myinv</span>...<br/>
&nbsp;stuckstate&nbsp;*)</span>&nbsp;&nbsp;<span class="id">contradiction</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id">estep_not_val</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">f</span> <span class="id">a</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span> <span class="id">t</span> <span class="id">S</span>, <span class="id">estep</span> <span class="id">ge</span> (<span class="id">ExprState</span> <span class="id">f</span> <span class="id">a</span> <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>) <span class="id">t</span> <span class="id">S</span> -&gt; <span class="id">is_val</span> <span class="id">a</span> = <span class="id">None</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4251')">Proof.</div>
<div class="proofscript" id="proof4251">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="kwd">forall</span> <span class="id">b</span> <span class="id">from</span> <span class="id">to</span> <span class="id">C</span>, <span class="id">context</span> <span class="id">from</span> <span class="id">to</span> <span class="id">C</span> -&gt; (<span class="id">from</span> = <span class="id">to</span> /\ <span class="id">C</span> = <span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">x</span>) \/ <span class="id">is_val</span> (<span class="id">C</span> <span class="id">b</span>) = <span class="id">None</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">induction</span> 1; <span class="tactic">simpl</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">H0</span> <span class="id">a0</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H9</span>) <span class="kwd">as</span> [[<span class="id">A</span> <span class="id">B</span>] | <span class="id">A</span>]. <span class="tactic">subst</span>. <span class="id">inv</span> <span class="id">H8</span>; <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">H0</span> <span class="id">a0</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H9</span>) <span class="kwd">as</span> [[<span class="id">A</span> <span class="id">B</span>] | <span class="id">A</span>]. <span class="tactic">subst</span>. <span class="id">inv</span> <span class="id">H8</span>; <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">H0</span> <span class="id">a0</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H9</span>) <span class="kwd">as</span> [[<span class="id">A</span> <span class="id">B</span>] | <span class="id">A</span>]. <span class="tactic">subst</span>. <span class="id">inv</span> <span class="id">H8</span>; <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">H0</span> <span class="id">a0</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H8</span>) <span class="kwd">as</span> [[<span class="id">A</span> <span class="id">B</span>] | <span class="id">A</span>]. <span class="tactic">subst</span>. <span class="tactic">destruct</span> <span class="id">a0</span>; <span class="tactic">auto</span>. <span class="tactic">elim</span> <span class="id">H9</span>. <span class="id">constructor</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Theorem</span> <span class="id">do_step_complete</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">w</span> <span class="id">S</span> <span class="id">t</span> <span class="id">S</span>' <span class="id">w</span>',<br/>
&nbsp;&nbsp;<span class="id">possible_trace</span> <span class="id">w</span> <span class="id">t</span> <span class="id">w</span>' -&gt; <span class="id">Csem.step</span> <span class="id">ge</span> <span class="id">S</span> <span class="id">t</span> <span class="id">S</span>' -&gt; <span class="id">exists</span> <span class="id">rule</span>, <span class="id">In</span> (<span class="id">TR</span> <span class="id">rule</span> <span class="id">t</span> <span class="id">S</span>') (<span class="id">do_step</span> <span class="id">w</span> <span class="id">S</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4252')">Proof with</div>
<div class="proofscript" id="proof4252">
 (<span class="tactic">unfold</span> <span class="id">ret</span>; <span class="tactic">eauto</span> <span class="kwd">with</span> <span class="id">coqlib</span>).<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">w</span>'; <span class="tactic">intros</span> <span class="id">PT</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H</span>.<br/>
&nbsp;Expression&nbsp;step&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H</span>; <span class="tactic">subst</span>; <span class="id">exploit</span> <span class="id">estep_not_val</span>; <span class="tactic">eauto</span>; <span class="tactic">intro</span> <span class="id">NOTVAL</span>.<br/>
&nbsp;lred&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_step</span>; <span class="tactic">rewrite</span> <span class="id">NOTVAL</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">lred_topred</span>; <span class="tactic">eauto</span>. <span class="id">instantiate</span> (1 := <span class="id">w</span>). <span class="tactic">intros</span> (<span class="id">rule</span> &amp; <span class="id">STEP</span>).<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">rule</span>. <span class="id">change</span> (<span class="id">TR</span> <span class="id">rule</span> <span class="id">E0</span> (<span class="id">ExprState</span> <span class="id">f</span> (<span class="id">C</span> <span class="id">a</span>') <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>')) <span class="kwd">with</span> (<span class="id">expr_final_state</span> <span class="id">f</span> <span class="id">k</span> <span class="id">e</span> (<span class="id">C</span>, <span class="id">Lred</span> <span class="id">rule</span> <span class="id">a</span>' <span class="id">m</span>')).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">in_map</span>.<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id">step_expr_context</span> <span class="id">e</span> <span class="id">w</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H1</span> <span class="id">a</span> <span class="id">m</span>). <span class="tactic">unfold</span> <span class="id">reducts_incl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intro</span>. <span class="tactic">replace</span> <span class="id">C</span> <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C</span> <span class="id">x</span>). <span class="tactic">apply</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">STEP</span>. <span class="tactic">unfold</span> <span class="id">topred</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">coqlib</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="tactic">extensionality</span>; <span class="tactic">auto</span>.<br/>
&nbsp;rred&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_step</span>; <span class="tactic">rewrite</span> <span class="id">NOTVAL</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">rred_topred</span>; <span class="tactic">eauto</span>. <span class="id">instantiate</span> (1 := <span class="id">e</span>). <span class="tactic">intros</span> (<span class="id">rule</span> &amp; <span class="id">STEP</span>).<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">rule</span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">TR</span> <span class="id">rule</span> <span class="id">t</span> (<span class="id">ExprState</span> <span class="id">f</span> (<span class="id">C</span> <span class="id">a</span>') <span class="id">k</span> <span class="id">e</span> <span class="id">m</span>')) <span class="kwd">with</span> (<span class="id">expr_final_state</span> <span class="id">f</span> <span class="id">k</span> <span class="id">e</span> (<span class="id">C</span>, <span class="id">Rred</span> <span class="id">rule</span> <span class="id">a</span>' <span class="id">m</span>' <span class="id">t</span>)).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">in_map</span>.<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id">step_expr_context</span> <span class="id">e</span> <span class="id">w</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H1</span> <span class="id">a</span> <span class="id">m</span>). <span class="tactic">unfold</span> <span class="id">reducts_incl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intro</span>. <span class="tactic">replace</span> <span class="id">C</span> <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C</span> <span class="id">x</span>). <span class="tactic">apply</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">STEP</span>; <span class="tactic">unfold</span> <span class="id">topred</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">coqlib</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="tactic">extensionality</span>; <span class="tactic">auto</span>.<br/>
&nbsp;callred&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">do_step</span>; <span class="tactic">rewrite</span> <span class="id">NOTVAL</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">callred_topred</span>; <span class="tactic">eauto</span>. <span class="id">instantiate</span> (1 := <span class="id">w</span>). <span class="id">instantiate</span> (1 := <span class="id">e</span>).<br/>
&nbsp;&nbsp;<span class="tactic">intros</span> (<span class="id">rule</span> &amp; <span class="id">STEP</span>). <span class="id">exists</span> <span class="id">rule</span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">TR</span> <span class="id">rule</span> <span class="id">E0</span> (<span class="id">Callstate</span> <span class="id">fd</span> <span class="id">vargs</span> (<span class="id">Kcall</span> <span class="id">f</span> <span class="id">e</span> <span class="id">C</span> <span class="id">ty</span> <span class="id">k</span>) <span class="id">m</span>)) <span class="kwd">with</span> (<span class="id">expr_final_state</span> <span class="id">f</span> <span class="id">k</span> <span class="id">e</span> (<span class="id">C</span>, <span class="id">Callred</span> <span class="id">rule</span> <span class="id">fd</span> <span class="id">vargs</span> <span class="id">ty</span> <span class="id">m</span>)).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">in_map</span>.<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id">step_expr_context</span> <span class="id">e</span> <span class="id">w</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H1</span> <span class="id">a</span> <span class="id">m</span>). <span class="tactic">unfold</span> <span class="id">reducts_incl</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intro</span>. <span class="tactic">replace</span> <span class="id">C</span> <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">C</span> <span class="id">x</span>). <span class="tactic">apply</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">STEP</span>; <span class="tactic">unfold</span> <span class="id">topred</span>; <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">coqlib</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="tactic">extensionality</span>; <span class="tactic">auto</span>.<br/>
&nbsp;stuck&nbsp;*)</span>&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">not_imm_safe_stuck_red</span>. <span class="tactic">eauto</span>. <span class="tactic">red</span>; <span class="tactic">intros</span>; <span class="tactic">elim</span> <span class="id">H1</span>. <span class="tactic">eapply</span> <span class="id">imm_safe_t_imm_safe</span>. <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">instantiate</span> (1 := <span class="id">w</span>). <span class="tactic">intros</span> [<span class="id">C</span>' <span class="id">IN</span>].<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span> <span class="id">do_step</span>. <span class="tactic">rewrite</span> <span class="id">NOTVAL</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> "<span class="id">step_stuck</span>".<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">TR</span> "<span class="id">step_stuck</span>" <span class="id">E0</span> <span class="id">Stuckstate</span>) <span class="kwd">with</span> (<span class="id">expr_final_state</span> <span class="id">f</span> <span class="id">k</span> <span class="id">e</span> (<span class="id">C</span>', <span class="id">Stuckred</span>)).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">in_map</span>. <span class="tactic">auto</span>.<br/>
<br/>
&nbsp;Statement&nbsp;step&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv</span> <span class="id">H</span>; <span class="tactic">simpl</span>; <span class="id">econstructor</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">subst</span> <span class="id">s0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">subst</span> <span class="id">s0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">pred_dec_false</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">subst</span> <span class="id">x</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>; <span class="tactic">rewrite</span> <span class="id">H1</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">destruct</span> <span class="id">k</span>; <span class="tactic">try</span> <span class="id">contradiction</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H0</span>; <span class="tactic">subst</span> <span class="id">x</span>...<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>...<br/>
<br/>
&nbsp;Call&nbsp;step&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">pred_dec_true</span>; <span class="tactic">auto</span>. <span class="tactic">rewrite</span> (<span class="id">do_alloc_variables_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H1</span>).<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> (<span class="id">sem_bind_parameters_complete</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H2</span>)...<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">do_ef_external_complete</span>; <span class="tactic">eauto</span>. <span class="tactic">intro</span> <span class="id">EQ</span>; <span class="tactic">rewrite</span> <span class="id">EQ</span>. <span class="tactic">auto</span> <span class="kwd">with</span> <span class="id">coqlib</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">EXEC</span>.<br/>
<br/>
<span class="kwd">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">option_monad_scope</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">do_initial_state</span> (<span class="id">p</span>: <span class="id">program</span>): <span class="id">option</span> (<span class="id">genv</span> * <span class="id">state</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">ge</span> := <span class="id">globalenv</span> <span class="id">p</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">m0</span> &lt;- <span class="id">Genv.init_mem</span> <span class="id">p</span>;<br/>
&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">b</span> &lt;- <span class="id">Genv.find_symbol</span> <span class="id">ge</span> <span class="id">p</span>.(<span class="id">prog_main</span>);<br/>
&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">f</span> &lt;- <span class="id">Genv.find_funct_ptr</span> <span class="id">ge</span> <span class="id">b</span>;<br/>
&nbsp;&nbsp;<span class="id">check</span> (<span class="id">type_eq</span> (<span class="id">type_of_fundef</span> <span class="id">f</span>) (<span class="id">Tfunction</span> <span class="id">Tnil</span> <span class="id">type_int32s</span> <span class="id">cc_default</span>));<br/>
&nbsp;&nbsp;<span class="id">Some</span> (<span class="id">ge</span>, <span class="id">Callstate</span> <span class="id">f</span> <span class="id">nil</span> <span class="id">Kstop</span> <span class="id">m0</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">at_final_state</span> (<span class="id">S</span>: <span class="id">state</span>): <span class="id">option</span> <span class="id">int</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">S</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Returnstate</span> (<span class="id">Vint</span> <span class="id">r</span>) <span class="id">Kstop</span> <span class="id">m</span> =&gt; <span class="id">Some</span> <span class="id">r</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">None</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
</div>
<div class="footer"><hr/>Generated by coq2html</div>
</body>
</html>
