<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Inliningspec</title>
<meta name="description" content="Documentation of Coq module Inliningspec" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Inliningspec</h1>
<div class="coq">
<br/>
<div class="doc">RTL function inlining: relational specification </div>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Coqlib</span> <span class="id">Wfsimpl</span> <span class="id">Maps</span> <span class="id">Errors</span> <span class="id">Integers</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">AST</span> <span class="id">Linking</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Op</span> <span class="id">Registers</span> <span class="id">RTL</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Inlining</span>.<br/>
<br/>
<h2> Soundness of function environments. </h2>
<br/>
<div class="doc">A compile-time function environment is compatible with a whole
  program if the following condition holds. </div>
<br/>
<span class="kwd">Definition</span> <span class="id">fenv_compat</span> (<span class="id">p</span>: <span class="id">program</span>) (<span class="id">fenv</span>: <span class="id">funenv</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">id</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">fenv</span>!<span class="id">id</span> = <span class="id">Some</span> <span class="id">f</span> -&gt; (<span class="id">prog_defmap</span> <span class="id">p</span>)!<span class="id">id</span> = <span class="id">Some</span> (<span class="id">Gfun</span> (<span class="id">Internal</span> <span class="id">f</span>)).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">funenv_program_compat</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>, <span class="id">fenv_compat</span> <span class="id">p</span> (<span class="id">funenv_program</span> <span class="id">p</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2584')">Proof.</div>
<div class="proofscript" id="proof2584">
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">P</span> := <span class="kwd">fun</span> (<span class="id">dm</span>: <span class="id">PTree.t</span> (<span class="id">globdef</span> <span class="id">fundef</span> <span class="id">unit</span>)) (<span class="id">fenv</span>: <span class="id">funenv</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">id</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fenv</span>!<span class="id">id</span> = <span class="id">Some</span> <span class="id">f</span> -&gt; <span class="id">dm</span>!<span class="id">id</span> = <span class="id">Some</span> (<span class="id">Gfun</span> (<span class="id">Internal</span> <span class="id">f</span>))).<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">REMOVE</span>: <span class="kwd">forall</span> <span class="id">dm</span> <span class="id">fenv</span> <span class="id">id</span> <span class="id">g</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">P</span> <span class="id">dm</span> <span class="id">fenv</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">P</span> (<span class="id">PTree.set</span> <span class="id">id</span> <span class="id">g</span> <span class="id">dm</span>) (<span class="id">PTree.remove</span> <span class="id">id</span> <span class="id">fenv</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">unfold</span> <span class="id">P</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">PTree.grspec</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">destruct</span> (<span class="id">PTree.elt_eq</span> <span class="id">id0</span> <span class="id">id</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">PTree.gso</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">ADD</span>: <span class="kwd">forall</span> <span class="id">dm</span> <span class="id">fenv</span> <span class="id">idg</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">P</span> <span class="id">dm</span> <span class="id">fenv</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">P</span> (<span class="id">PTree.set</span> (<span class="id">fst</span> <span class="id">idg</span>) (<span class="id">snd</span> <span class="id">idg</span>) <span class="id">dm</span>) (<span class="id">add_globdef</span> <span class="id">fenv</span> <span class="id">idg</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">intros</span> <span class="id">dm</span> <span class="id">fenv</span> [<span class="id">id</span> <span class="id">g</span>]; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">g</span> <span class="kwd">as</span> [ [<span class="id">f</span>|<span class="id">ef</span>] | <span class="id">v</span>]; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">should_inline</span> <span class="id">id</span> <span class="id">f</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> ! <span class="id">PTree.gsspec</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">peq</span> <span class="id">id0</span> <span class="id">id</span>); <span class="tactic">auto</span>. <span class="id">inv</span> <span class="id">H0</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">REC</span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">dm</span> <span class="id">fenv</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">P</span> <span class="id">dm</span> <span class="id">fenv</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">P</span> (<span class="id">fold_left</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">idg</span> =&gt; <span class="id">PTree.set</span> (<span class="id">fst</span> <span class="id">idg</span>) (<span class="id">snd</span> <span class="id">idg</span>) <span class="id">x</span>) <span class="id">l</span> <span class="id">dm</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fold_left</span> <span class="id">add_globdef</span> <span class="id">l</span> <span class="id">fenv</span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">induction</span> <span class="id">l</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>. <br/>
&nbsp;&nbsp;- <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="tactic">apply</span> <span class="id">IHl</span>. <span class="tactic">apply</span> <span class="id">ADD</span>; <span class="tactic">auto</span>. <br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">REC</span>. <span class="tactic">red</span>; <span class="tactic">intros</span>.  <span class="tactic">rewrite</span> <span class="id">PTree.gempty</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">discriminate</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">fenv_compat_linkorder</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">cunit</span> <span class="id">prog</span> <span class="id">fenv</span>,<br/>
&nbsp;&nbsp;<span class="id">linkorder</span> <span class="id">cunit</span> <span class="id">prog</span> -&gt; <span class="id">fenv_compat</span> <span class="id">cunit</span> <span class="id">fenv</span> -&gt; <span class="id">fenv_compat</span> <span class="id">prog</span> <span class="id">fenv</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2585')">Proof.</div>
<div class="proofscript" id="proof2585">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">H1</span>. <br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">prog_defmap_linkorder</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H</span> <span class="id">H1</span>) <span class="kwd">as</span> (<span class="id">gd</span>' &amp; <span class="id">P</span> &amp; <span class="id">Q</span>). <br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">Q</span>. <span class="id">inv</span> <span class="id">H3</span>. <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> Properties of shifting </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id">shiftpos_eq</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span>, <span class="id">Zpos</span> (<span class="id">shiftpos</span> <span class="id">x</span> <span class="id">y</span>) = (<span class="id">Zpos</span> <span class="id">x</span> + <span class="id">Zpos</span> <span class="id">y</span>) - 1.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2586')">Proof.</div>
<div class="proofscript" id="proof2586">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">shiftpos</span>. <span class="id">zify</span>.  <span class="tactic">rewrite</span> <span class="id">Pos2Z.inj_sub</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">zify</span>. <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">shiftpos_inj</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">n</span>, <span class="id">shiftpos</span> <span class="id">x</span> <span class="id">n</span> = <span class="id">shiftpos</span> <span class="id">y</span> <span class="id">n</span> -&gt; <span class="id">x</span> = <span class="id">y</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2587')">Proof.</div>
<div class="proofscript" id="proof2587">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Zpos</span> (<span class="id">shiftpos</span> <span class="id">x</span> <span class="id">n</span>) = <span class="id">Zpos</span> (<span class="id">shiftpos</span> <span class="id">y</span> <span class="id">n</span>)) <span class="tactic">by</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> ! <span class="id">shiftpos_eq</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Z.pos</span> <span class="id">x</span> = <span class="id">Z.pos</span> <span class="id">y</span>) <span class="tactic">by</span> <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">congruence</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">shiftpos_diff</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">n</span>, <span class="id">x</span> &lt;&gt; <span class="id">y</span> -&gt; <span class="id">shiftpos</span> <span class="id">x</span> <span class="id">n</span> &lt;&gt; <span class="id">shiftpos</span> <span class="id">y</span> <span class="id">n</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2588')">Proof.</div>
<div class="proofscript" id="proof2588">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">elim</span> <span class="id">H</span>. <span class="tactic">eapply</span> <span class="id">shiftpos_inj</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">shiftpos_above</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span> <span class="id">n</span>, <span class="id">Ple</span> <span class="id">n</span> (<span class="id">shiftpos</span> <span class="id">x</span> <span class="id">n</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2589')">Proof.</div>
<div class="proofscript" id="proof2589">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">Ple</span>; <span class="id">zify</span>. <span class="tactic">rewrite</span> <span class="id">shiftpos_eq</span>. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">shiftpos_not_below</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span> <span class="id">n</span>, <span class="id">Plt</span> (<span class="id">shiftpos</span> <span class="id">x</span> <span class="id">n</span>) <span class="id">n</span> -&gt; <span class="id">False</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2590')">Proof.</div>
<div class="proofscript" id="proof2590">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">generalize</span> (<span class="id">shiftpos_above</span> <span class="id">x</span> <span class="id">n</span>). <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">shiftpos_below</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span> <span class="id">n</span>, <span class="id">Plt</span> (<span class="id">shiftpos</span> <span class="id">x</span> <span class="id">n</span>) (<span class="id">Pplus</span> <span class="id">x</span> <span class="id">n</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2591')">Proof.</div>
<div class="proofscript" id="proof2591">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">Plt</span>; <span class="id">zify</span>. <span class="tactic">rewrite</span> <span class="id">shiftpos_eq</span>. <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">shiftpos_le</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">n</span>, <span class="id">Ple</span> <span class="id">x</span> <span class="id">y</span> -&gt; <span class="id">Ple</span> (<span class="id">shiftpos</span> <span class="id">x</span> <span class="id">n</span>) (<span class="id">shiftpos</span> <span class="id">y</span> <span class="id">n</span>).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2592')">Proof.</div>
<div class="proofscript" id="proof2592">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">Ple</span> <span class="kwd">in</span> *; <span class="id">zify</span>. <span class="tactic">rewrite</span> ! <span class="id">shiftpos_eq</span>. <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<br/>
<h2> Working with the state monad </h2>
<br/>
<span class="kwd">Remark</span> <span class="id">bind_inversion</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span> <span class="id">B</span>: <span class="kwd">Type</span>) (<span class="id">f</span>: <span class="id">mon</span> <span class="id">A</span>) (<span class="id">g</span>: <span class="id">A</span> -&gt; <span class="id">mon</span> <span class="id">B</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">y</span>: <span class="id">B</span>) (<span class="id">s1</span> <span class="id">s3</span>: <span class="id">state</span>) (<span class="id">i</span>: <span class="id">sincr</span> <span class="id">s1</span> <span class="id">s3</span>),<br/>
&nbsp;&nbsp;<span class="id">bind</span> <span class="id">f</span> <span class="id">g</span> <span class="id">s1</span> = <span class="id">R</span> <span class="id">y</span> <span class="id">s3</span> <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">x</span>, <span class="id">exists</span> <span class="id">s2</span>, <span class="id">exists</span> <span class="id">i1</span>, <span class="id">exists</span> <span class="id">i2</span>,<br/>
&nbsp;&nbsp;<span class="id">f</span> <span class="id">s1</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s2</span> <span class="id">i1</span> /\ <span class="id">g</span> <span class="id">x</span> <span class="id">s2</span> = <span class="id">R</span> <span class="id">y</span> <span class="id">s3</span> <span class="id">i2</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2593')">Proof.</div>
<div class="proofscript" id="proof2593">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">bind</span>; <span class="tactic">intros</span>. <span class="tactic">destruct</span> (<span class="id">f</span> <span class="id">s1</span>). <span class="id">exists</span> <span class="id">x</span>; <span class="id">exists</span> <span class="id">s</span>'; <span class="id">exists</span> <span class="id">I</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">g</span> <span class="id">x</span> <span class="id">s</span>'). <span class="id">inv</span> <span class="id">H</span>. <span class="id">exists</span> <span class="id">I0</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Ltac</span> <span class="id">monadInv1</span> <span class="id">H</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| (<span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H</span>; <span class="tactic">clear</span> <span class="id">H</span>; <span class="tactic">try</span> <span class="tactic">subst</span><br/>
&nbsp;&nbsp;| (<span class="id">ret</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">H</span>; <span class="tactic">clear</span> <span class="id">H</span>; <span class="tactic">try</span> <span class="tactic">subst</span><br/>
&nbsp;&nbsp;| (<span class="id">bind</span> ?<span class="id">F</span> ?<span class="id">G</span> ?<span class="id">S</span> = <span class="id">R</span> ?<span class="id">X</span> ?<span class="id">S</span>' ?<span class="id">I</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">x</span> := <span class="tactic">fresh</span> "<span class="id">x</span>" <span class="kwd">in</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">s</span> := <span class="tactic">fresh</span> "<span class="id">s</span>" <span class="kwd">in</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">i1</span> := <span class="tactic">fresh</span> "<span class="id">INCR</span>" <span class="kwd">in</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">i2</span> := <span class="tactic">fresh</span> "<span class="id">INCR</span>" <span class="kwd">in</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">EQ1</span> := <span class="tactic">fresh</span> "<span class="id">EQ</span>" <span class="kwd">in</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">EQ2</span> := <span class="tactic">fresh</span> "<span class="id">EQ</span>" <span class="kwd">in</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">bind_inversion</span> <span class="id">_</span> <span class="id">_</span> <span class="id">F</span> <span class="id">G</span> <span class="id">X</span> <span class="id">S</span> <span class="id">S</span>' <span class="id">I</span> <span class="id">H</span>) <span class="kwd">as</span> [<span class="id">x</span> [<span class="id">s</span> [<span class="id">i1</span> [<span class="id">i2</span> [<span class="id">EQ1</span> <span class="id">EQ2</span>]]]]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">clear</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">try</span> (<span class="id">monadInv1</span> <span class="id">EQ2</span>)))))))<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">monadInv</span> <span class="id">H</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| (<span class="id">ret</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt; <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (<span class="id">bind</span> ?<span class="id">F</span> ?<span class="id">G</span> ?<span class="id">S</span> = <span class="id">R</span> ?<span class="id">X</span> ?<span class="id">S</span>' ?<span class="id">I</span>) =&gt; <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| (?<span class="id">F</span> <span class="id">_</span> = <span class="id">R</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="tactic">progress</span> <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>) || <span class="tactic">unfold</span> <span class="id">F</span> <span class="kwd">in</span> <span class="id">H</span>); <span class="id">monadInv1</span> <span class="id">H</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">mlist_iter2</span> {<span class="id">A</span> <span class="id">B</span>: <span class="kwd">Type</span>} (<span class="id">f</span>: <span class="id">A</span> -&gt; <span class="id">B</span> -&gt; <span class="id">mon</span> <span class="id">unit</span>) (<span class="id">l</span>: <span class="id">list</span> (<span class="id">A</span>*<span class="id">B</span>)): <span class="id">mon</span> <span class="id">unit</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">nil</span> =&gt; <span class="id">ret</span> <span class="id">tt</span><br/>
&nbsp;&nbsp;| (<span class="id">x</span>,<span class="id">y</span>) :: <span class="id">l</span>' =&gt; <span class="tactic">do</span> <span class="id">z</span> &lt;- <span class="id">f</span> <span class="id">x</span> <span class="id">y</span>; <span class="id">mlist_iter2</span> <span class="id">f</span> <span class="id">l</span>'<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Remark</span> <span class="id">mlist_iter2_fold</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span> <span class="id">B</span>: <span class="kwd">Type</span>) (<span class="id">f</span>: <span class="id">A</span> -&gt; <span class="id">B</span> -&gt; <span class="id">mon</span> <span class="id">unit</span>) <span class="id">l</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">i</span>,<br/>
&nbsp;&nbsp;<span class="id">mlist_iter2</span> <span class="id">f</span> <span class="id">l</span> <span class="id">s</span> =<br/>
&nbsp;&nbsp;<span class="id">R</span> <span class="id">tt</span> (<span class="id">fold_left</span> (<span class="kwd">fun</span> <span class="id">a</span> <span class="id">p</span> =&gt; <span class="kwd">match</span> <span class="id">f</span> (<span class="id">fst</span> <span class="id">p</span>) (<span class="id">snd</span> <span class="id">p</span>) <span class="id">a</span> <span class="kwd">with</span> <span class="id">R</span> <span class="id">_</span> <span class="id">s2</span> <span class="id">_</span> =&gt; <span class="id">s2</span> <span class="kwd">end</span>) <span class="id">l</span> <span class="id">s</span>) <span class="id">i</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2594')">Proof.</div>
<div class="proofscript" id="proof2594">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exists</span> (<span class="id">sincr_refl</span> <span class="id">s</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [<span class="id">x</span> <span class="id">y</span>]. <span class="tactic">unfold</span> <span class="id">bind</span>. <span class="tactic">simpl</span>. <span class="tactic">destruct</span> (<span class="id">f</span> <span class="id">x</span> <span class="id">y</span> <span class="id">s</span>) <span class="kwd">as</span> [<span class="id">xx</span> <span class="id">s1</span> <span class="id">i1</span>].<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">IHl</span> <span class="id">s1</span>) <span class="kwd">as</span> [<span class="id">i2</span> <span class="id">EQ</span>]. <span class="tactic">rewrite</span> <span class="id">EQ</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">ptree_mfold_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">A</span>: <span class="kwd">Type</span>) (<span class="id">f</span>: <span class="id">positive</span> -&gt; <span class="id">A</span> -&gt; <span class="id">mon</span> <span class="id">unit</span>) <span class="id">t</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span>,<br/>
&nbsp;&nbsp;<span class="id">ptree_mfold</span> <span class="id">f</span> <span class="id">t</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">exists</span> <span class="id">i</span>', <span class="id">mlist_iter2</span> <span class="id">f</span> (<span class="id">PTree.elements</span> <span class="id">t</span>) <span class="id">s</span> = <span class="id">R</span> <span class="id">tt</span> <span class="id">s</span>' <span class="id">i</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2595')">Proof.</div>
<div class="proofscript" id="proof2595">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">mlist_iter2_fold</span> <span class="id">_</span> <span class="id">_</span> <span class="id">f</span> (<span class="id">PTree.elements</span> <span class="id">t</span>) <span class="id">s</span>) <span class="kwd">as</span> [<span class="id">i</span>' <span class="id">EQ</span>].<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">ptree_mfold</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">inv</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id">PTree.fold_spec</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>. <span class="id">eexact</span> <span class="id">EQ</span>.<br/>
Qed.</div>
<br/>
<h2> Relational specification of the translation of moves </h2>
<br/>
<span class="kwd">Inductive</span> <span class="id">tr_moves</span> (<span class="id">c</span>: <span class="id">code</span>) : <span class="id">node</span> -&gt; <span class="id">list</span> <span class="id">reg</span> -&gt; <span class="id">list</span> <span class="id">reg</span> -&gt; <span class="id">node</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">tr_moves_cons</span>: <span class="kwd">forall</span> <span class="id">pc1</span> <span class="id">src</span> <span class="id">srcs</span> <span class="id">dst</span> <span class="id">dsts</span> <span class="id">pc2</span> <span class="id">pc3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_moves</span> <span class="id">c</span> <span class="id">pc1</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!<span class="id">pc2</span> = <span class="id">Some</span>(<span class="id">Iop</span> <span class="id">Omove</span> (<span class="id">src</span> :: <span class="id">nil</span>) <span class="id">dst</span> <span class="id">pc3</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_moves</span> <span class="id">c</span> <span class="id">pc1</span> (<span class="id">src</span> :: <span class="id">srcs</span>) (<span class="id">dst</span> :: <span class="id">dsts</span>) <span class="id">pc3</span><br/>
&nbsp;&nbsp;| <span class="id">tr_moves_nil</span>: <span class="kwd">forall</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">srcs</span> = <span class="id">nil</span> \/ <span class="id">dsts</span> = <span class="id">nil</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_moves</span> <span class="id">c</span> <span class="id">pc</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">add_moves_unchanged</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc2</span> <span class="id">s</span> <span class="id">pc1</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id">add_moves</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc2</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">pc1</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> <span class="id">pc</span> <span class="id">s</span>.(<span class="id">st_nextnode</span>) \/ <span class="id">Ple</span> <span class="id">s</span>'.(<span class="id">st_nextnode</span>) <span class="id">pc</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span> = <span class="id">s</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2596')">Proof.</div>
<div class="proofscript" id="proof2596">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">srcs</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">dsts</span>; <span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">st_code</span> <span class="id">s0</span>)!<span class="id">pc</span>. <span class="tactic">eapply</span> <span class="id">IHsrcs</span>; <span class="tactic">eauto</span>. <span class="id">monadInv</span> <span class="id">EQ</span>; <span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">EQ</span>; <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">PTree.gso</span>.<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">INCR0</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">add_moves_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc2</span> <span class="id">s</span> <span class="id">pc1</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">add_moves</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc2</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">pc1</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span>, <span class="id">Ple</span> <span class="id">s</span>.(<span class="id">st_nextnode</span>) <span class="id">pc</span> -&gt; <span class="id">Plt</span> <span class="id">pc</span> <span class="id">s</span>'.(<span class="id">st_nextnode</span>) -&gt; <span class="id">c</span>!<span class="id">pc</span> = <span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_moves</span> <span class="id">c</span> <span class="id">pc1</span> <span class="id">srcs</span> <span class="id">dsts</span> <span class="id">pc2</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2597')">Proof.</div>
<div class="proofscript" id="proof2597">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">srcs</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">apply</span> <span class="id">tr_moves_nil</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">dsts</span>; <span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">apply</span> <span class="id">tr_moves_nil</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tr_moves_cons</span> <span class="kwd">with</span> <span class="id">x</span>. <span class="tactic">eapply</span> <span class="id">IHsrcs</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">inversion</span> <span class="id">INCR</span>. <span class="tactic">apply</span> <span class="id">H0</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id">H0</span>. <span class="id">erewrite</span> <span class="id">add_moves_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">PTree.gss</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">INCR</span>; <span class="tactic">inversion</span> <span class="id">INCR0</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<h2> Relational specification of CFG expansion </h2>
<br/>
<span class="kwd">Section</span> <span class="id">INLINING_SPEC</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">fenv</span>: <span class="id">funenv</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">context_below</span> (<span class="id">ctx1</span> <span class="id">ctx2</span>: <span class="id">context</span>): <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">Pplus</span> <span class="id">ctx1</span>.(<span class="id">dreg</span>) <span class="id">ctx1</span>.(<span class="id">mreg</span>)) <span class="id">ctx2</span>.(<span class="id">dreg</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">context_stack_call</span> (<span class="id">ctx1</span> <span class="id">ctx2</span>: <span class="id">context</span>): <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id">ctx1</span>.(<span class="id">mstk</span>) &gt;= 0 /\ <span class="id">ctx1</span>.(<span class="id">dstk</span>) + <span class="id">ctx1</span>.(<span class="id">mstk</span>) &lt;= <span class="id">ctx2</span>.(<span class="id">dstk</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">context_stack_tailcall</span> (<span class="id">ctx1</span>: <span class="id">context</span>) (<span class="id">f</span>: <span class="id">function</span>) (<span class="id">ctx2</span>: <span class="id">context</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id">ctx2</span>.(<span class="id">dstk</span>) = <span class="id">align</span> <span class="id">ctx1</span>.(<span class="id">dstk</span>) (<span class="id">min_alignment</span> <span class="id">f</span>.(<span class="id">fn_stacksize</span>)).<br/>
<br/>
<span class="kwd">Section</span> <span class="id">INLINING_BODY_SPEC</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">stacksize</span>: <span class="id">Z</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">tr_instr</span>: <span class="id">context</span> -&gt; <span class="id">node</span> -&gt; <span class="id">instruction</span> -&gt; <span class="id">code</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">tr_nop</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Inop</span> (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Inop</span> <span class="id">s</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_op</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">op</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">res</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Iop</span> (<span class="id">sop</span> <span class="id">ctx</span> <span class="id">op</span>) (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) (<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">res</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Iop</span> <span class="id">op</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_load</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">chunk</span> <span class="id">addr</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">res</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Iload</span> <span class="id">chunk</span> (<span class="id">saddr</span> <span class="id">ctx</span> <span class="id">addr</span>) (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) (<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">res</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Iload</span> <span class="id">chunk</span> <span class="id">addr</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_store</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">chunk</span> <span class="id">addr</span> <span class="id">args</span> <span class="id">src</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Istore</span> <span class="id">chunk</span> (<span class="id">saddr</span> <span class="id">ctx</span> <span class="id">addr</span>) (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) (<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">src</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Istore</span> <span class="id">chunk</span> <span class="id">addr</span> <span class="id">args</span> <span class="id">src</span> <span class="id">s</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_call</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">sg</span> <span class="id">ros</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">res</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Icall</span> <span class="id">sg</span> (<span class="id">sros</span> <span class="id">ctx</span> <span class="id">ros</span>) (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) (<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">res</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Icall</span> <span class="id">sg</span> <span class="id">ros</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_call_inlined</span>:<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">sg</span> <span class="id">id</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span> <span class="id">c</span> <span class="id">f</span> <span class="id">pc1</span> <span class="id">ctx</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">res</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fenv</span>!<span class="id">id</span> = <span class="id">Some</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span>(<span class="id">Inop</span> <span class="id">pc1</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_moves</span> <span class="id">c</span> <span class="id">pc1</span> (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) (<span class="id">sregs</span> <span class="id">ctx</span>' <span class="id">f</span>.(<span class="id">fn_params</span>)) (<span class="id">spc</span> <span class="id">ctx</span>' <span class="id">f</span>.(<span class="id">fn_entrypoint</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">ctx</span>' <span class="id">f</span> <span class="id">c</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>'.(<span class="id">retinfo</span>) = <span class="id">Some</span>(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s</span>, <span class="id">sreg</span> <span class="id">ctx</span> <span class="id">res</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context_below</span> <span class="id">ctx</span> <span class="id">ctx</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context_stack_call</span> <span class="id">ctx</span> <span class="id">ctx</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Icall</span> <span class="id">sg</span> (<span class="id">inr</span> <span class="id">_</span> <span class="id">id</span>) <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_tailcall</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">sg</span> <span class="id">ros</span> <span class="id">args</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Itailcall</span> <span class="id">sg</span> (<span class="id">sros</span> <span class="id">ctx</span> <span class="id">ros</span>) (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Itailcall</span> <span class="id">sg</span> <span class="id">ros</span> <span class="id">args</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_tailcall_call</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">sg</span> <span class="id">ros</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Icall</span> <span class="id">sg</span> (<span class="id">sros</span> <span class="id">ctx</span> <span class="id">ros</span>) (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) <span class="id">res</span> <span class="id">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">Some</span>(<span class="id">s</span>, <span class="id">res</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Itailcall</span> <span class="id">sg</span> <span class="id">ros</span> <span class="id">args</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_tailcall_inlined</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">sg</span> <span class="id">id</span> <span class="id">args</span> <span class="id">c</span> <span class="id">f</span> <span class="id">pc1</span> <span class="id">ctx</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fenv</span>!<span class="id">id</span> = <span class="id">Some</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span>(<span class="id">Inop</span> <span class="id">pc1</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_moves</span> <span class="id">c</span> <span class="id">pc1</span> (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) (<span class="id">sregs</span> <span class="id">ctx</span>' <span class="id">f</span>.(<span class="id">fn_params</span>)) (<span class="id">spc</span> <span class="id">ctx</span>' <span class="id">f</span>.(<span class="id">fn_entrypoint</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">ctx</span>' <span class="id">f</span> <span class="id">c</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>'.(<span class="id">retinfo</span>) = <span class="id">ctx</span>.(<span class="id">retinfo</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context_below</span> <span class="id">ctx</span> <span class="id">ctx</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">context_stack_tailcall</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">ctx</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Itailcall</span> <span class="id">sg</span> (<span class="id">inr</span> <span class="id">_</span> <span class="id">id</span>) <span class="id">args</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_builtin</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">c</span> <span class="id">ef</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">res</span> <span class="kwd">with</span> <span class="id">BR</span> <span class="id">r</span> =&gt; <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>) | <span class="id">_</span> =&gt; <span class="id">True</span> <span class="kwd">end</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Ibuiltin</span> <span class="id">ef</span> (<span class="id">map</span> (<span class="id">sbuiltinarg</span> <span class="id">ctx</span>) <span class="id">args</span>) (<span class="id">sbuiltinres</span> <span class="id">ctx</span> <span class="id">res</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Ibuiltin</span> <span class="id">ef</span> <span class="id">args</span> <span class="id">res</span> <span class="id">s</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_cond</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">cond</span> <span class="id">args</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Icond</span> <span class="id">cond</span> (<span class="id">sregs</span> <span class="id">ctx</span> <span class="id">args</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s1</span>) (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">s2</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Icond</span> <span class="id">cond</span> <span class="id">args</span> <span class="id">s1</span> <span class="id">s2</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_jumptable</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">r</span> <span class="id">tbl</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Ijumptable</span> (<span class="id">sreg</span> <span class="id">ctx</span> <span class="id">r</span>) (<span class="id">List.map</span> (<span class="id">spc</span> <span class="id">ctx</span>) <span class="id">tbl</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Ijumptable</span> <span class="id">r</span> <span class="id">tbl</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_return</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">or</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">Ireturn</span> (<span class="id">option_map</span> (<span class="id">sreg</span> <span class="id">ctx</span>) <span class="id">or</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Ireturn</span> <span class="id">or</span>) <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id">tr_return_inlined</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">or</span> <span class="id">c</span> <span class="id">rinfo</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">Some</span> (<span class="id">inline_return</span> <span class="id">ctx</span> <span class="id">or</span> <span class="id">rinfo</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">Some</span> <span class="id">rinfo</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> (<span class="id">Ireturn</span> <span class="id">or</span>) <span class="id">c</span><br/>
<br/>
<span class="kwd">with</span> <span class="id">tr_funbody</span>: <span class="id">context</span> -&gt; <span class="id">function</span> -&gt; <span class="id">code</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">tr_funbody_intro</span>: <span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">In</span> <span class="id">r</span> <span class="id">f</span>.(<span class="id">fn_params</span>) -&gt; <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span> <span class="id">i</span>, <span class="id">f</span>.(<span class="id">fn_code</span>)!<span class="id">pc</span> = <span class="id">Some</span> <span class="id">i</span> -&gt; <span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">i</span> <span class="id">c</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) = <span class="id">Zmax</span> <span class="id">f</span>.(<span class="id">fn_stacksize</span>) 0 -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">min_alignment</span> <span class="id">f</span>.(<span class="id">fn_stacksize</span>) | <span class="id">ctx</span>.(<span class="id">dstk</span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">dstk</span>) &gt;= 0 -&gt; <span class="id">ctx</span>.(<span class="id">dstk</span>) + <span class="id">ctx</span>.(<span class="id">mstk</span>) &lt;= <span class="id">stacksize</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">c</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">fenv_agree</span> (<span class="id">fe</span>: <span class="id">funenv</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">id</span> <span class="id">f</span>, <span class="id">fe</span>!<span class="id">id</span> = <span class="id">Some</span> <span class="id">f</span> -&gt; <span class="id">fenv</span>!<span class="id">id</span> = <span class="id">Some</span> <span class="id">f</span>.<br/>
<br/>
<span class="kwd">Section</span> <span class="id">EXPAND_INSTR</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">fe</span>: <span class="id">funenv</span>.<br/>
<span class="kwd">Hypothesis</span> <span class="id">FE</span>: <span class="id">fenv_agree</span> <span class="id">fe</span>.<br/>
<br/>
<span class="kwd">Variable</span> <span class="id">rec</span>: <span class="kwd">forall</span> <span class="id">fe</span>', (<span class="id">size_fenv</span> <span class="id">fe</span>' &lt; <span class="id">size_fenv</span> <span class="id">fe</span>)%<span class="id">nat</span> -&gt; <span class="id">context</span> -&gt; <span class="id">function</span> -&gt; <span class="id">mon</span> <span class="id">unit</span>.<br/>
<br/>
<span class="kwd">Hypothesis</span> <span class="id">rec_unchanged</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">fe</span>' (<span class="id">L</span>: (<span class="id">size_fenv</span> <span class="id">fe</span>' &lt; <span class="id">size_fenv</span> <span class="id">fe</span>)%<span class="id">nat</span>) <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id">rec</span> <span class="id">fe</span>' <span class="id">L</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> <span class="id">pc</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span> = <span class="id">s</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>.<br/>
<br/>
<span class="kwd">Remark</span> <span class="id">set_instr_other</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;<span class="id">set_instr</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">pc</span>' &lt;&gt; <span class="id">pc</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>' = <span class="id">s</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2598')">Proof.</div>
<div class="proofscript" id="proof2598">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">monadInv</span> <span class="id">H</span>; <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">PTree.gso</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Remark</span> <span class="id">set_instr_same</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">set_instr</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">pc</span>) = <span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">pc</span>) = <span class="id">Some</span> <span class="id">instr</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2599')">Proof.</div>
<div class="proofscript" id="proof2599">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">H0</span>. <span class="id">monadInv</span> <span class="id">H</span>; <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">PTree.gss</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">expand_instr_unchanged</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">pc</span>',<br/>
&nbsp;&nbsp;<span class="id">expand_instr</span> <span class="id">fe</span> <span class="id">rec</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> <span class="id">pc</span>' <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">pc</span>' &lt;&gt; <span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>' = <span class="id">s</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2600')">Proof.</div>
<div class="proofscript" id="proof2600">
&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">set_instr_other</span>; <span class="tactic">intros</span> <span class="id">A</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">expand_instr</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">destruct</span> <span class="id">instr</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;call&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">can_inline</span> <span class="id">fe</span> <span class="id">s1</span>). <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">unfold</span> <span class="id">inline_function</span> <span class="kwd">in</span> <span class="id">EQ</span>. <span class="id">monadInv</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s2</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'). <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s5</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'). <span class="tactic">eapply</span> <span class="id">add_moves_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">inversion</span> <span class="id">INCR5</span>. <span class="tactic">inversion</span> <span class="id">INCR3</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s4</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'). <span class="tactic">eapply</span> <span class="id">rec_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ</span>; <span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">EQ</span>; <span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span>. <span class="tactic">auto</span>.<br/>
&nbsp;tailcall&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">can_inline</span> <span class="id">fe</span> <span class="id">s1</span>).<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">retinfo</span> <span class="id">ctx</span>) <span class="kwd">as</span> [[<span class="id">rpc</span> <span class="id">rreg</span>]|]; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">unfold</span> <span class="id">inline_tail_function</span> <span class="kwd">in</span> <span class="id">EQ</span>. <span class="id">monadInv</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s2</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'). <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s5</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'). <span class="tactic">eapply</span> <span class="id">add_moves_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">left</span>. <span class="tactic">inversion</span> <span class="id">INCR5</span>. <span class="tactic">inversion</span> <span class="id">INCR3</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s4</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>'). <span class="tactic">eapply</span> <span class="id">rec_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ</span>; <span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">EQ</span>; <span class="tactic">simpl</span>. <span class="id">monadInv</span> <span class="id">EQ1</span>; <span class="tactic">simpl</span>. <span class="tactic">auto</span>.<br/>
&nbsp;return&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">retinfo</span> <span class="id">ctx</span>) <span class="kwd">as</span> [[<span class="id">rpc</span> <span class="id">rreg</span>]|]; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">iter_expand_instr_unchanged</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">l</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span>,<br/>
&nbsp;&nbsp;<span class="id">mlist_iter2</span> (<span class="id">expand_instr</span> <span class="id">fe</span> <span class="id">rec</span> <span class="id">ctx</span>) <span class="id">l</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> <span class="id">pc</span> <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;~<span class="id">In</span> <span class="id">pc</span> (<span class="id">List.map</span> (<span class="id">spc</span> <span class="id">ctx</span>) (<span class="id">List.map</span> (@<span class="id">fst</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">l</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">list_norepet</span> (<span class="id">List.map</span> (@<span class="id">fst</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">l</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span> = <span class="id">s</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2601')">Proof.</div>
<div class="proofscript" id="proof2601">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;base&nbsp;case&nbsp;*)</span>&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">auto</span>.<br/>
&nbsp;inductive&nbsp;case&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [<span class="id">pc1</span> <span class="id">instr1</span>]; <span class="tactic">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">H</span>. <span class="id">inv</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> ((<span class="id">st_code</span> <span class="id">s0</span>)!<span class="id">pc</span>).<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">IHl</span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> <span class="id">INCR</span>; <span class="id">xomega</span>. <span class="tactic">destruct</span> <span class="id">INCR</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">expand_instr_unchanged</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">expand_cfg_rec_unchanged</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id">expand_cfg_rec</span> <span class="id">fe</span> <span class="id">rec</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> <span class="id">pc</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span> = <span class="id">s</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2602')">Proof.</div>
<div class="proofscript" id="proof2602">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">expand_cfg_rec</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">inversion</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> ((<span class="id">st_code</span> <span class="id">s0</span>)!<span class="id">pc</span>).<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">ptree_mfold_spec</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">INCR</span>' <span class="id">ITER</span>].<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">iter_expand_instr_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">s0</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">s0</span>; <span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">pc1</span> [<span class="id">A</span> <span class="id">B</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">pc</span>. <span class="tactic">unfold</span> <span class="id">spc</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="tactic">eapply</span> <span class="id">shiftpos_not_below</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">PTree.elements_keys_norepet</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">s0</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Hypothesis</span> <span class="id">rec_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">fe</span>' (<span class="id">L</span>: (<span class="id">size_fenv</span> <span class="id">fe</span>' &lt; <span class="id">size_fenv</span> <span class="id">fe</span>)%<span class="id">nat</span>) <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">rec</span> <span class="id">fe</span>' <span class="id">L</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">fenv_agree</span> <span class="id">fe</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">ctx</span>.(<span class="id">dpc</span>) + <span class="id">max_pc_function</span> <span class="id">f</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mreg</span>) = <span class="id">max_reg_function</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">Pplus</span> <span class="id">ctx</span>.(<span class="id">dreg</span>) <span class="id">ctx</span>.(<span class="id">mreg</span>)) <span class="id">s</span>.(<span class="id">st_nextreg</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) = <span class="id">Zmax</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) 0 -&gt;<br/>
&nbsp;&nbsp;(<span class="id">min_alignment</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) | <span class="id">ctx</span>.(<span class="id">dstk</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">dstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_stksize</span>) &lt;= <span class="id">stacksize</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span>, <span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">pc</span> -&gt; <span class="id">Plt</span> <span class="id">pc</span> <span class="id">s</span>'.(<span class="id">st_nextnode</span>) -&gt; <span class="id">c</span>!<span class="id">pc</span> = <span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">c</span>.<br/>
<br/>
<span class="kwd">Remark</span> <span class="id">min_alignment_pos</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">sz</span>, <span class="id">min_alignment</span> <span class="id">sz</span> &gt; 0.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2603')">Proof.</div>
<div class="proofscript" id="proof2603">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">unfold</span> <span class="id">min_alignment</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 1). <span class="tactic">omega</span>. <span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 2). <span class="tactic">omega</span>. <span class="tactic">destruct</span> (<span class="id">zle</span> <span class="id">sz</span> 4); <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Ltac</span> <span class="id">inv_incr</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| [ <span class="id">H</span>: <span class="id">sincr</span> <span class="id">_</span> <span class="id">_</span> |- <span class="id">_</span> ] =&gt; <span class="tactic">destruct</span> <span class="id">H</span>; <span class="id">inv_incr</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">idtac</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">expand_instr_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">expand_instr</span> <span class="id">fe</span> <span class="id">rec</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">instr_defs</span> <span class="id">instr</span> = <span class="id">Some</span> <span class="id">r</span> -&gt; <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">ctx</span>.(<span class="id">dreg</span>) + <span class="id">ctx</span>.(<span class="id">mreg</span>)) <span class="id">s</span>.(<span class="id">st_nextreg</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) &gt;= 0 -&gt; <span class="id">ctx</span>.(<span class="id">dstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_stksize</span>) &lt;= <span class="id">stacksize</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span>', <span class="id">Ple</span> <span class="id">s</span>.(<span class="id">st_nextnode</span>) <span class="id">pc</span>' -&gt; <span class="id">Plt</span> <span class="id">pc</span>' <span class="id">s</span>'.(<span class="id">st_nextnode</span>) -&gt; <span class="id">c</span>!<span class="id">pc</span>' = <span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">s</span>'.(<span class="id">st_code</span>)!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">c</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2604')">Proof.</div>
<div class="proofscript" id="proof2604">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">c</span>; <span class="tactic">intros</span> <span class="id">EXP</span> <span class="id">DEFS</span> <span class="id">OPC</span> <span class="id">OREG</span> <span class="id">STK1</span> <span class="id">STK2</span> <span class="id">STK3</span> <span class="id">S1</span> <span class="id">S2</span>.<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> <span class="id">set_instr_same</span>; <span class="tactic">intros</span> <span class="id">BASE</span>.<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">expand_instr</span> <span class="kwd">in</span> <span class="id">EXP</span>; <span class="tactic">destruct</span> <span class="id">instr</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">DEFS</span>;<br/>
&nbsp;&nbsp;<span class="tactic">try</span> (<span class="id">econstructor</span>; <span class="tactic">eauto</span>; <span class="tactic">fail</span>).<br/>
&nbsp;call&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">can_inline</span> <span class="id">fe</span> <span class="id">s1</span>) <span class="kwd">as</span> [|<span class="id">id</span> <span class="id">f</span> <span class="id">P</span> <span class="id">Q</span>].<br/>
&nbsp;not&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">tr_call</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">s1</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">EXP</span>. <span class="tactic">unfold</span> <span class="id">inline_function</span> <span class="kwd">in</span> <span class="id">EQ</span>; <span class="id">monadInv</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">ctx</span>' := <span class="id">callcontext</span> <span class="id">ctx</span> <span class="id">x1</span> <span class="id">x2</span> (<span class="id">max_reg_function</span> <span class="id">f</span>) (<span class="id">fn_stacksize</span> <span class="id">f</span>) <span class="id">n</span> <span class="id">r</span>).<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">EQ0</span>; <span class="tactic">inversion</span> <span class="id">EQ1</span>; <span class="tactic">inversion</span> <span class="id">EQ</span>. <span class="id">inv_incr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tr_call_inlined</span> <span class="kwd">with</span> (<span class="id">pc1</span> := <span class="id">x0</span>) (<span class="id">ctx</span>' := <span class="id">ctx</span>') (<span class="id">f</span> := <span class="id">f</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">BASE</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">add_moves_spec</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">S1</span>. <span class="tactic">eapply</span> <span class="id">set_instr_other</span>; <span class="tactic">eauto</span>. <span class="tactic">unfold</span> <span class="id">node</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">xomega</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">rec_spec</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">PTree.grspec</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">destruct</span> (<span class="id">PTree.elt_eq</span> <span class="id">id0</span> <span class="id">id</span>); <span class="tactic">try</span> <span class="tactic">discriminate</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">subst</span> <span class="id">s2</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">subst</span> <span class="id">s3</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">align_divides</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">dstk</span> <span class="id">ctx</span> + <span class="id">mstk</span> <span class="id">ctx</span> &lt;= <span class="id">dstk</span> <span class="id">ctx</span>'). <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">align_le</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id">S1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s1</span>.(<span class="id">st_code</span>)!<span class="id">pc0</span>). <span class="tactic">eapply</span> <span class="id">set_instr_other</span>; <span class="tactic">eauto</span>. <span class="tactic">unfold</span> <span class="id">node</span> <span class="kwd">in</span> *; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">add_moves_unchanged</span>; <span class="tactic">eauto</span>. <span class="tactic">unfold</span> <span class="id">node</span> <span class="kwd">in</span> *; <span class="id">xomega</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">simpl</span>. <span class="tactic">subst</span> <span class="id">s2</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">simpl</span>. <span class="tactic">split</span>. <span class="tactic">auto</span>. <span class="tactic">apply</span> <span class="id">align_le</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>.<br/>
&nbsp;tailcall&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">can_inline</span> <span class="id">fe</span> <span class="id">s1</span>) <span class="kwd">as</span> [|<span class="id">id</span> <span class="id">f</span> <span class="id">P</span> <span class="id">Q</span>].<br/>
&nbsp;not&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">retinfo</span> <span class="id">ctx</span>) <span class="kwd">as</span> [[<span class="id">rpc</span> <span class="id">rreg</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;turned&nbsp;into&nbsp;a&nbsp;call&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">tr_tailcall_call</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;preserved&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">tr_tailcall</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">s1</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">EXP</span>. <span class="tactic">unfold</span> <span class="id">inline_function</span> <span class="kwd">in</span> <span class="id">EQ</span>; <span class="id">monadInv</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">ctx</span>' := <span class="id">tailcontext</span> <span class="id">ctx</span> <span class="id">x1</span> <span class="id">x2</span> (<span class="id">max_reg_function</span> <span class="id">f</span>) (<span class="id">fn_stacksize</span> <span class="id">f</span>)) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">EQ0</span>; <span class="tactic">inversion</span> <span class="id">EQ1</span>; <span class="tactic">inversion</span> <span class="id">EQ</span>. <span class="id">inv_incr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tr_tailcall_inlined</span> <span class="kwd">with</span> (<span class="id">pc1</span> := <span class="id">x0</span>) (<span class="id">ctx</span>' := <span class="id">ctx</span>') (<span class="id">f</span> := <span class="id">f</span>); <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">BASE</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">add_moves_spec</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">S1</span>. <span class="tactic">eapply</span> <span class="id">set_instr_other</span>; <span class="tactic">eauto</span>. <span class="tactic">unfold</span> <span class="id">node</span>; <span class="id">xomega</span>. <span class="id">xomega</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">rec_spec</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">PTree.grspec</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">destruct</span> (<span class="id">PTree.elt_eq</span> <span class="id">id0</span> <span class="id">id</span>); <span class="tactic">try</span> <span class="tactic">discriminate</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">subst</span> <span class="id">s3</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="tactic">subst</span> <span class="id">s2</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">subst</span> <span class="id">s3</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">align_divides</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">dstk</span> <span class="id">ctx</span> &lt;= <span class="id">dstk</span> <span class="id">ctx</span>'). <span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">align_le</span>. <span class="tactic">apply</span> <span class="id">min_alignment_pos</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="tactic">rewrite</span> <span class="id">S1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">transitivity</span> (<span class="id">s1</span>.(<span class="id">st_code</span>))!<span class="id">pc0</span>. <span class="tactic">eapply</span> <span class="id">set_instr_other</span>; <span class="tactic">eauto</span>. <span class="tactic">unfold</span> <span class="id">node</span> <span class="kwd">in</span> *; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">add_moves_unchanged</span>; <span class="tactic">eauto</span>. <span class="tactic">unfold</span> <span class="id">node</span> <span class="kwd">in</span> *; <span class="id">xomega</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">simpl</span>.<br/>
<span class="tactic">subst</span> <span class="id">s2</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
&nbsp;builtin&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">tr_builtin</span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> <span class="id">b</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;return&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">retinfo</span> <span class="id">ctx</span>) <span class="kwd">as</span> [[<span class="id">rpc</span> <span class="id">rreg</span>] | ] <span class="id">eqn</span>:?.<br/>
&nbsp;inlined&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">tr_return_inlined</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;unchanged&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">tr_return</span>; <span class="tactic">eauto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">iter_expand_instr_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">l</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">mlist_iter2</span> (<span class="id">expand_instr</span> <span class="id">fe</span> <span class="id">rec</span> <span class="id">ctx</span>) <span class="id">l</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">list_norepet</span> (<span class="id">List.map</span> (@<span class="id">fst</span> <span class="id">_</span> <span class="id">_</span>) <span class="id">l</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">r</span>, <span class="id">In</span> (<span class="id">pc</span>, <span class="id">instr</span>) <span class="id">l</span> -&gt; <span class="id">instr_defs</span> <span class="id">instr</span> = <span class="id">Some</span> <span class="id">r</span> -&gt; <span class="id">Ple</span> <span class="id">r</span> <span class="id">ctx</span>.(<span class="id">mreg</span>)) -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span> <span class="id">instr</span>, <span class="id">In</span> (<span class="id">pc</span>, <span class="id">instr</span>) <span class="id">l</span> -&gt; <span class="id">Plt</span> (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">ctx</span>.(<span class="id">dreg</span>) + <span class="id">ctx</span>.(<span class="id">mreg</span>)) <span class="id">s</span>.(<span class="id">st_nextreg</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) &gt;= 0 -&gt; <span class="id">ctx</span>.(<span class="id">dstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_stksize</span>) &lt;= <span class="id">stacksize</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span>', <span class="id">Ple</span> <span class="id">s</span>.(<span class="id">st_nextnode</span>) <span class="id">pc</span>' -&gt; <span class="id">Plt</span> <span class="id">pc</span>' <span class="id">s</span>'.(<span class="id">st_nextnode</span>) -&gt; <span class="id">c</span>!<span class="id">pc</span>' = <span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>') -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span> <span class="id">instr</span>, <span class="id">In</span> (<span class="id">pc</span>, <span class="id">instr</span>) <span class="id">l</span> -&gt; <span class="id">c</span>!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) = <span class="id">s</span>'.(<span class="id">st_code</span>)!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">pc</span> <span class="id">instr</span>, <span class="id">In</span> (<span class="id">pc</span>, <span class="id">instr</span>) <span class="id">l</span> -&gt; <span class="id">tr_instr</span> <span class="id">ctx</span> <span class="id">pc</span> <span class="id">instr</span> <span class="id">c</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2605')">Proof.</div>
<div class="proofscript" id="proof2605">
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l</span>; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;base&nbsp;case&nbsp;*)</span>&nbsp;&nbsp;<span class="id">contradiction</span>.<br/>
&nbsp;inductive&nbsp;case&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [<span class="id">pc1</span> <span class="id">instr1</span>]; <span class="tactic">simpl</span> <span class="kwd">in</span> *. <span class="id">inv</span> <span class="id">H0</span>. <span class="id">monadInv</span> <span class="id">H</span>. <span class="id">inv_incr</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">A</span>: <span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">s0</span>.(<span class="id">st_nextnode</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">B</span>: <span class="id">Plt</span> (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) (<span class="id">st_nextnode</span> <span class="id">s</span>)) <span class="tactic">by</span> <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">spc</span> <span class="kwd">in</span> <span class="id">B</span>. <span class="tactic">generalize</span> (<span class="id">shiftpos_above</span> <span class="id">pc</span> (<span class="id">dpc</span> <span class="id">ctx</span>)). <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">H9</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;same&nbsp;pc&nbsp;*)</span>&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">expand_instr_spec</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">transitivity</span> ((<span class="id">st_code</span> <span class="id">s</span>')!<span class="id">pc</span>').<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">H7</span>. <span class="tactic">auto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">iter_expand_instr_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">list_map_compose</span> <span class="kwd">in</span> <span class="id">H9</span>. <span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> [[<span class="id">pc0</span> <span class="id">instr0</span>] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Plt</span> (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc0</span>) (<span class="id">st_nextnode</span> <span class="id">s</span>)) <span class="tactic">by</span> <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">transitivity</span> ((<span class="id">st_code</span> <span class="id">s</span>')!(<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">H8</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">iter_expand_instr_unchanged</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Plt</span> (<span class="id">spc</span> <span class="id">ctx</span> <span class="id">pc</span>) (<span class="id">st_nextnode</span> <span class="id">s</span>)) <span class="tactic">by</span> <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">list_map_compose</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">exploit</span> <span class="id">list_in_map_inv</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span> [[<span class="id">pc0</span> <span class="id">instr0</span>] [<span class="id">P</span> <span class="id">Q</span>]]. <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">pc</span> = <span class="id">pc0</span>) <span class="tactic">by</span> (<span class="tactic">eapply</span> <span class="id">shiftpos_inj</span>; <span class="tactic">eauto</span>). <span class="tactic">subst</span> <span class="id">pc0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">elim</span> <span class="id">H12</span>. <span class="id">change</span> <span class="id">pc</span> <span class="kwd">with</span> (<span class="id">fst</span> (<span class="id">pc</span>, <span class="id">instr0</span>)). <span class="tactic">apply</span> <span class="id">List.in_map</span>; <span class="tactic">auto</span>.<br/>
&nbsp;older&nbsp;pc&nbsp;*)</span>&nbsp;&nbsp;<span class="id">inv_incr</span>. <span class="tactic">eapply</span> <span class="id">IHl</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">Plt_le_trans</span>. <span class="tactic">eapply</span> <span class="id">H2</span>. <span class="id">right</span>; <span class="tactic">eauto</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">eapply</span> <span class="id">Ple_trans</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">H7</span>; <span class="tactic">auto</span>. <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">expand_cfg_rec_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">expand_cfg_rec</span> <span class="id">fe</span> <span class="id">rec</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">ctx</span>.(<span class="id">dpc</span>) + <span class="id">max_pc_function</span> <span class="id">f</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mreg</span>) = <span class="id">max_reg_function</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">ctx</span>.(<span class="id">dreg</span>) + <span class="id">ctx</span>.(<span class="id">mreg</span>)) <span class="id">s</span>.(<span class="id">st_nextreg</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) = <span class="id">Zmax</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) 0 -&gt;<br/>
&nbsp;&nbsp;(<span class="id">min_alignment</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) | <span class="id">ctx</span>.(<span class="id">dstk</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">dstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_stksize</span>) &lt;= <span class="id">stacksize</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span>', <span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">pc</span>' -&gt; <span class="id">Plt</span> <span class="id">pc</span>' <span class="id">s</span>'.(<span class="id">st_nextnode</span>) -&gt; <span class="id">c</span>!<span class="id">pc</span>' = <span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">c</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2606')">Proof.</div>
<div class="proofscript" id="proof2606">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">expand_cfg_rec</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">monadInv</span> <span class="id">H</span>. <span class="tactic">inversion</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">eapply</span> <span class="id">max_reg_function_params</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id">ptree_mfold_spec</span>; <span class="tactic">eauto</span>. <span class="tactic">intros</span> [<span class="id">INCR</span>' <span class="id">ITER</span>].<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">iter_expand_instr_spec</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">PTree.elements_keys_norepet</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id">H1</span>. <span class="tactic">eapply</span> <span class="id">max_reg_function_def</span> <span class="kwd">with</span> (<span class="id">i</span> := <span class="id">instr</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">PTree.elements_complete</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Ple</span> <span class="id">pc0</span> (<span class="id">max_pc_function</span> <span class="id">f</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">max_pc_function_sound</span>. <span class="tactic">eapply</span> <span class="id">PTree.elements_complete</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Plt_le_trans</span>. <span class="tactic">apply</span> <span class="id">shiftpos_below</span>. <span class="tactic">subst</span> <span class="id">s0</span>; <span class="tactic">simpl</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">subst</span> <span class="id">s0</span>; <span class="tactic">simpl</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">H8</span>; <span class="tactic">auto</span>. <span class="tactic">subst</span> <span class="id">s0</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">H11</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">H8</span>. <span class="tactic">apply</span> <span class="id">shiftpos_above</span>.<br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">Ple</span> <span class="id">pc0</span> (<span class="id">max_pc_function</span> <span class="id">f</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">max_pc_function_sound</span>. <span class="tactic">eapply</span> <span class="id">PTree.elements_complete</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">Plt_le_trans</span>. <span class="tactic">apply</span> <span class="id">shiftpos_below</span>. <span class="tactic">inversion</span> <span class="id">i</span>; <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">PTree.elements_correct</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>. <span class="tactic">auto</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">inversion</span> <span class="id">INCR0</span>. <span class="tactic">subst</span> <span class="id">s0</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">STKSIZE</span>; <span class="id">xomega</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">EXPAND_INSTR</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">expand_cfg_unchanged</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">fe</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">pc</span>,<br/>
&nbsp;&nbsp;<span class="id">expand_cfg</span> <span class="id">fe</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">Plt</span> <span class="id">pc</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span> = <span class="id">s</span>.(<span class="id">st_code</span>)!<span class="id">pc</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2607')">Proof.</div>
<div class="proofscript" id="proof2607">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">fe0</span>; <span class="tactic">pattern</span> <span class="id">fe0</span>. <span class="tactic">apply</span> <span class="id">well_founded_ind</span> <span class="kwd">with</span> (<span class="id">R</span> := <span class="id">ltof</span> <span class="id">_</span> <span class="id">size_fenv</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">well_founded_ltof</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">expand_cfg</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">unroll_Fixm</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">expand_cfg_rec_unchanged</span>; <span class="tactic">eauto</span>. <span class="tactic">assumption</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">expand_cfg_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">fe</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> <span class="id">c</span>,<br/>
&nbsp;&nbsp;<span class="id">expand_cfg</span> <span class="id">fe</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">s</span> = <span class="id">R</span> <span class="id">x</span> <span class="id">s</span>' <span class="id">i</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">fenv_agree</span> <span class="id">fe</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">ctx</span>.(<span class="id">dpc</span>) + <span class="id">max_pc_function</span> <span class="id">f</span>) <span class="id">s</span>.(<span class="id">st_nextnode</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mreg</span>) = <span class="id">max_reg_function</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ple</span> (<span class="id">ctx</span>.(<span class="id">dreg</span>) + <span class="id">ctx</span>.(<span class="id">mreg</span>)) <span class="id">s</span>.(<span class="id">st_nextreg</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">mstk</span>) = <span class="id">Zmax</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) 0 -&gt;<br/>
&nbsp;&nbsp;(<span class="id">min_alignment</span> (<span class="id">fn_stacksize</span> <span class="id">f</span>) | <span class="id">ctx</span>.(<span class="id">dstk</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">dstk</span>) &gt;= 0 -&gt;<br/>
&nbsp;&nbsp;<span class="id">s</span>'.(<span class="id">st_stksize</span>) &lt;= <span class="id">stacksize</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">pc</span>', <span class="id">Ple</span> <span class="id">ctx</span>.(<span class="id">dpc</span>) <span class="id">pc</span>' -&gt; <span class="id">Plt</span> <span class="id">pc</span>' <span class="id">s</span>'.(<span class="id">st_nextnode</span>) -&gt; <span class="id">c</span>!<span class="id">pc</span>' = <span class="id">s</span>'.(<span class="id">st_code</span>)!<span class="id">pc</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">ctx</span> <span class="id">f</span> <span class="id">c</span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2608')">Proof.</div>
<div class="proofscript" id="proof2608">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">fe0</span>; <span class="tactic">pattern</span> <span class="id">fe0</span>. <span class="tactic">apply</span> <span class="id">well_founded_ind</span> <span class="kwd">with</span> (<span class="id">R</span> := <span class="id">ltof</span> <span class="id">_</span> <span class="id">size_fenv</span>).<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">well_founded_ltof</span>.<br/>
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">expand_cfg</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">rewrite</span> <span class="id">unroll_Fixm</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">expand_cfg_rec_spec</span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">intros</span>. <span class="tactic">eapply</span> <span class="id">expand_cfg_unchanged</span>; <span class="tactic">eauto</span>. <span class="tactic">assumption</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">End</span> <span class="id">INLINING_BODY_SPEC</span>.<br/>
<br/>
<span class="kwd">End</span> <span class="id">INLINING_SPEC</span>.<br/>
<br/>
<h2> Relational specification of the translation of a function </h2>
<br/>
<span class="kwd">Inductive</span> <span class="id">tr_function</span>: <span class="id">program</span> -&gt; <span class="id">function</span> -&gt; <span class="id">function</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">tr_function_intro</span>: <span class="kwd">forall</span> <span class="id">p</span> <span class="id">fenv</span> <span class="id">f</span> <span class="id">f</span>' <span class="id">ctx</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fenv_compat</span> <span class="id">p</span> <span class="id">fenv</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_funbody</span> <span class="id">fenv</span> <span class="id">f</span>'.(<span class="id">fn_stacksize</span>) <span class="id">ctx</span> <span class="id">f</span> <span class="id">f</span>'.(<span class="id">fn_code</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">dstk</span>) = 0 -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ctx</span>.(<span class="id">retinfo</span>) = <span class="id">None</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span>'.(<span class="id">fn_sig</span>) = <span class="id">f</span>.(<span class="id">fn_sig</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span>'.(<span class="id">fn_params</span>) = <span class="id">sregs</span> <span class="id">ctx</span> <span class="id">f</span>.(<span class="id">fn_params</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f</span>'.(<span class="id">fn_entrypoint</span>) = <span class="id">spc</span> <span class="id">ctx</span> <span class="id">f</span>.(<span class="id">fn_entrypoint</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 &lt;= <span class="id">fn_stacksize</span> <span class="id">f</span>' &lt; <span class="id">Ptrofs.max_unsigned</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tr_function</span> <span class="id">p</span> <span class="id">f</span> <span class="id">f</span>'.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">tr_function_linkorder</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">cunit</span> <span class="id">prog</span> <span class="id">f</span> <span class="id">f</span>',<br/>
&nbsp;&nbsp;<span class="id">linkorder</span> <span class="id">cunit</span> <span class="id">prog</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_function</span> <span class="id">cunit</span> <span class="id">f</span> <span class="id">f</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_function</span> <span class="id">prog</span> <span class="id">f</span> <span class="id">f</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2609')">Proof.</div>
<div class="proofscript" id="proof2609">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="id">inv</span> <span class="id">H0</span>. <span class="id">econstructor</span>; <span class="tactic">eauto</span>. <span class="tactic">eapply</span> <span class="id">fenv_compat_linkorder</span>; <span class="tactic">eauto</span>. <br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">transf_function_spec</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">cunit</span> <span class="id">f</span> <span class="id">f</span>',<br/>
&nbsp;&nbsp;<span class="id">transf_function</span> (<span class="id">funenv_program</span> <span class="id">cunit</span>) <span class="id">f</span> = <span class="id">OK</span> <span class="id">f</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">tr_function</span> <span class="id">cunit</span> <span class="id">f</span> <span class="id">f</span>'.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof2610')">Proof.</div>
<div class="proofscript" id="proof2610">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">unfold</span> <span class="id">transf_function</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">set</span> (<span class="id">fenv</span> := <span class="id">funenv_program</span> <span class="id">cunit</span>) <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">expand_function</span> <span class="id">fenv</span> <span class="id">f</span> <span class="id">initstate</span>) <span class="kwd">as</span> [<span class="id">ctx</span> <span class="id">s</span> <span class="id">i</span>] <span class="id">eqn</span>:?.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> (<span class="id">zlt</span> (<span class="id">st_stksize</span> <span class="id">s</span>) <span class="id">Ptrofs.max_unsigned</span>); <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">monadInv</span> <span class="id">Heqr</span>. <span class="tactic">set</span> (<span class="id">ctx</span> := <span class="id">initcontext</span> <span class="id">x</span> <span class="id">x0</span> (<span class="id">max_reg_function</span> <span class="id">f</span>) (<span class="id">fn_stacksize</span> <span class="id">f</span>)) <span class="kwd">in</span> *.<br/>
<span class="id">Opaque</span> <span class="id">initstate</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">INCR3</span>. <span class="tactic">inversion</span> <span class="id">EQ1</span>. <span class="tactic">inversion</span> <span class="id">EQ</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">tr_function_intro</span> <span class="kwd">with</span> <span class="id">fenv</span> <span class="id">ctx</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">funenv_program_compat</span>.<br/>
&nbsp;&nbsp;<span class="tactic">eapply</span> <span class="id">expand_cfg_spec</span> <span class="kwd">with</span> (<span class="id">fe</span> := <span class="id">fenv</span>); <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">ctx</span>; <span class="tactic">rewrite</span> &lt;- <span class="id">H1</span>; <span class="tactic">rewrite</span> &lt;- <span class="id">H2</span>; <span class="tactic">rewrite</span> &lt;- <span class="id">H3</span>; <span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id">ctx</span>; <span class="tactic">rewrite</span> &lt;- <span class="id">H0</span>; <span class="tactic">rewrite</span> &lt;- <span class="id">H1</span>; <span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">xomega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">apply</span> <span class="id">Zdivide_0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="tactic">split</span>; <span class="tactic">auto</span>. <span class="tactic">destruct</span> <span class="id">INCR2</span>. <span class="tactic">destruct</span> <span class="id">INCR1</span>. <span class="tactic">destruct</span> <span class="id">INCR0</span>. <span class="tactic">destruct</span> <span class="id">INCR</span>.<br/>
&nbsp;&nbsp;<span class="tactic">simpl</span>. <span class="id">change</span> 0 <span class="kwd">with</span> (<span class="id">st_stksize</span> <span class="id">initstate</span>). <span class="tactic">omega</span>.<br/>
Qed.</div>
</div>
<div class="footer"><hr/>Generated by coq2html</div>
</body>
</html>
